name: Build Simplex Compiler

on:
  push:
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64]

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang llvm libssl-dev libsqlite3-dev

    - name: Build compiler
      run: |
        echo "=== Building Simplex Compiler for Linux ==="

        # Use pre-compiled LLVM IR (self-hosted compiler output)
        # No Python bootstrap needed - sxc_combined.ll is checked into repo
        if [ ! -f compiler/bootstrap/sxc_combined.ll ]; then
          echo "Error: compiler/bootstrap/sxc_combined.ll not found"
          echo "This file should be generated by running: ./build/sxc compiler/bootstrap/main.sx -o compiler/bootstrap/sxc_combined.ll"
          exit 1
        fi

        echo "Using pre-compiled sxc_combined.ll (self-hosted)"
        wc -l compiler/bootstrap/sxc_combined.ll

        # Link compiler
        clang -O2 \
          compiler/bootstrap/sxc_combined.ll \
          runtime/standalone_runtime.c \
          -o sxc-linux-x86_64 \
          -lm -lssl -lcrypto -lsqlite3 -lpthread

        # Verify
        chmod +x sxc-linux-x86_64
        ./sxc-linux-x86_64 --version || echo "Built successfully"

        # Show size
        ls -lh sxc-linux-x86_64

    - name: Run tests
      run: |
        echo "=== Running Tests ==="

        # Test compilation of a simple file
        cat > test_hello.sx << 'EOF'
        fn main() -> i64 {
            println("Hello from Simplex!");
            0
        }
        EOF

        ./sxc-linux-x86_64 test_hello.sx
        clang -O2 test_hello.ll runtime/standalone_runtime.c -o test_hello -lm -lssl -lcrypto -lsqlite3 -lpthread
        ./test_hello

        echo "Basic compilation test passed!"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: sxc-linux-x86_64
        path: |
          sxc-linux-x86_64
          runtime/standalone_runtime.c

  build-macos:
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: macos-15-intel
          - arch: arm64
            runner: macos-latest
    runs-on: ${{ matrix.runner }}

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install openssl@3 sqlite3

    - name: Build compiler
      run: |
        echo "=== Building Simplex Compiler for macOS (${{ matrix.arch }}) ==="

        # Get paths
        OPENSSL_PREFIX=$(brew --prefix openssl@3)
        SQLITE_PREFIX=$(brew --prefix sqlite3)

        # Use pre-compiled LLVM IR (self-hosted compiler output)
        echo "Using pre-compiled sxc_combined.ll (self-hosted)"
        wc -l compiler/bootstrap/sxc_combined.ll

        # Link compiler
        clang -O2 \
          -I$OPENSSL_PREFIX/include \
          -I$SQLITE_PREFIX/include \
          -L$OPENSSL_PREFIX/lib \
          -L$SQLITE_PREFIX/lib \
          compiler/bootstrap/sxc_combined.ll \
          runtime/standalone_runtime.c \
          -o sxc-macos-${{ matrix.arch }} \
          -lm -lssl -lcrypto -lsqlite3

        chmod +x sxc-macos-${{ matrix.arch }}
        ls -lh sxc-macos-${{ matrix.arch }}

    - name: Run tests
      run: |
        OPENSSL_PREFIX=$(brew --prefix openssl@3)
        SQLITE_PREFIX=$(brew --prefix sqlite3)

        cat > test_hello.sx << 'EOF'
        fn main() -> i64 {
            println("Hello from Simplex!");
            0
        }
        EOF

        ./sxc-macos-${{ matrix.arch }} test_hello.sx
        clang -O2 \
          -I$OPENSSL_PREFIX/include -I$SQLITE_PREFIX/include \
          -L$OPENSSL_PREFIX/lib -L$SQLITE_PREFIX/lib \
          test_hello.ll runtime/standalone_runtime.c \
          -o test_hello -lm -lssl -lcrypto -lsqlite3
        ./test_hello

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: sxc-macos-${{ matrix.arch }}
        path: |
          sxc-macos-${{ matrix.arch }}
          runtime/standalone_runtime.c

  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install LLVM
      run: choco install llvm -y

    - name: Install OpenSSL
      run: choco install openssl -y

    - name: Verify LLVM IR
      shell: bash
      run: |
        echo "=== Simplex Compiler for Windows ==="
        echo "Note: Windows build uses pre-compiled LLVM IR"

        # Use pre-compiled LLVM IR (self-hosted compiler output)
        # No Python bootstrap needed - sxc_combined.ll is checked into repo
        if [ ! -f compiler/bootstrap/sxc_combined.ll ]; then
          echo "Error: compiler/bootstrap/sxc_combined.ll not found"
          echo "This file should be generated by running: ./build/sxc compiler/bootstrap/main.sx -o compiler/bootstrap/sxc_combined.ll"
          exit 1
        fi

        echo "Using pre-compiled sxc_combined.ll (self-hosted)"
        wc -l compiler/bootstrap/sxc_combined.ll

        echo "Note: Full Windows binary requires runtime porting"

    - name: Upload LLVM IR artifact
      uses: actions/upload-artifact@v4
      with:
        name: sxc-windows-llvm-ir
        path: compiler/bootstrap/sxc_combined.ll
      if: always()

  release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: List artifacts
      run: find artifacts -type f

    - name: Prepare release bundle
      run: |
        # Copy runtime to release directory for bundling
        mkdir -p release
        cp artifacts/sxc-linux-x86_64/sxc-linux-x86_64 release/
        cp artifacts/sxc-macos-x86_64/sxc-macos-x86_64 release/
        cp artifacts/sxc-macos-arm64/sxc-macos-arm64 release/
        # Include runtime (use linux artifact copy)
        cp artifacts/sxc-linux-x86_64/runtime/standalone_runtime.c release/
        ls -la release/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          release/sxc-linux-x86_64
          release/sxc-macos-x86_64
          release/sxc-macos-arm64
          release/standalone_runtime.c
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-suite:
    needs: [build-linux]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang libssl-dev libsqlite3-dev

    - name: Download Linux binary
      uses: actions/download-artifact@v4
      with:
        name: sxc-linux-x86_64
        path: .

    - name: Run test suite
      continue-on-error: true  # Some tests not yet supported by self-hosted compiler
      run: |
        chmod +x sxc-linux-x86_64

        echo "=== Running Test Suite ==="

        PASS=0
        FAIL=0

        for category in basics types async actors; do
          echo ""
          echo "--- Testing $category ---"

          if [ -d "tests/$category" ]; then
            for test in tests/$category/*.sx; do
              name=$(basename "$test" .sx)
              echo -n "  $category/$name: "

              if ./sxc-linux-x86_64 "$test" 2>/dev/null; then
                ll_file="${test%.sx}.ll"
                if clang -O2 "$ll_file" runtime/standalone_runtime.c -o "test_$name" -lm -lssl -lcrypto -lsqlite3 -lpthread 2>/dev/null; then
                  if timeout 10 "./test_$name" >/dev/null 2>&1; then
                    echo "PASS"
                    PASS=$((PASS + 1))
                  else
                    echo "FAIL (runtime)"
                    FAIL=$((FAIL + 1))
                  fi
                  rm -f "test_$name"
                else
                  echo "FAIL (link)"
                  FAIL=$((FAIL + 1))
                fi
                rm -f "$ll_file"
              else
                echo "FAIL (compile)"
                FAIL=$((FAIL + 1))
              fi
            done
          fi
        done

        echo ""
        echo "=== Results ==="
        echo "Passed: $PASS"
        echo "Failed: $FAIL"

        if [ $FAIL -gt 0 ]; then
          exit 1
        fi

  build-docs:
    needs: [build-linux]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang libssl-dev libsqlite3-dev

    - name: Download Linux binary
      uses: actions/download-artifact@v4
      with:
        name: sxc-linux-x86_64
        path: .

    - name: Build documentation tools
      run: |
        chmod +x sxc-linux-x86_64
        mv sxc-linux-x86_64 sxc

        echo "=== Building sxdoc ==="
        ./sxc sxdoc.sx -o sxdoc.ll
        clang -O2 sxdoc.ll runtime/standalone_runtime.c \
          -o sxdoc -lm -lssl -lcrypto -lsqlite3 -lpthread
        chmod +x sxdoc

        echo "=== Building sxdoc-index ==="
        ./sxc sxdoc-index.sx -o sxdoc-index.ll
        clang -O2 sxdoc-index.ll runtime/standalone_runtime.c \
          -o sxdoc-index -lm -lssl -lcrypto -lsqlite3 -lpthread
        chmod +x sxdoc-index

    - name: Build documentation
      run: |
        chmod +x scripts/build-docs.sh
        ./scripts/build-docs.sh

    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: api-docs
        path: simplex-docs/api/
