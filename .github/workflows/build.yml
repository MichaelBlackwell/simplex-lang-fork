name: Build Simplex Toolchain

on:
  push:
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  SIMPLEX_VERSION: "0.5.0"

jobs:
  build-linux-x86_64:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang llvm libssl-dev libsqlite3-dev zip

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build toolchain
        run: |
          echo "=== Building Simplex Toolchain v$SIMPLEX_VERSION for Linux x86_64 ==="

          PLATFORM="linux-x86_64"
          mkdir -p dist/$PLATFORM

          # Helper function to merge LLVM IR files (keeps header from first file only)
          merge_ll() {
            local output=$1
            shift
            local first=$1
            shift

            # Copy first file entirely
            cp "$first" "$output"

            # Append remaining files, stripping headers
            for f in "$@"; do
              awk '/^define |^declare |^@[a-zA-Z]/ { found=1 } found { print }' "$f" >> "$output"
            done
          }

          cd compiler/bootstrap
          python3 stage0.py lexer.sx
          python3 stage0.py parser.sx
          python3 stage0.py codegen.sx
          python3 stage0.py main.sx

          merge_ll sxc_combined.ll lexer.ll parser.ll codegen.ll main.ll
          cd ../..

          echo "Building sxc..."
          clang -O2 compiler/bootstrap/sxc_combined.ll runtime/standalone_runtime.c \
            -o dist/$PLATFORM/sxc -lm -lssl -lcrypto -lsqlite3 -lpthread

          cd compiler/bootstrap
          for tool in sxpm cursus sxdoc sxlsp; do
            echo "Building $tool..."
            python3 stage0.py ../../tools/${tool}.sx
            mv ../../tools/${tool}.ll .
            merge_ll ${tool}_combined.ll lexer.ll parser.ll codegen.ll ${tool}.ll
          done
          cd ../..

          for tool in sxpm cursus sxdoc sxlsp; do
            clang -O2 compiler/bootstrap/${tool}_combined.ll runtime/standalone_runtime.c \
              -o dist/$PLATFORM/$tool -lm -lssl -lcrypto -lsqlite3 -lpthread
          done

          chmod +x dist/$PLATFORM/*
          echo "=== Built Binaries ==="
          ls -lh dist/$PLATFORM/

          cd dist
          zip -r simplex-toolchain-$SIMPLEX_VERSION-$PLATFORM.zip $PLATFORM/
          ls -lh *.zip

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: simplex-linux-x86_64-binaries
          path: dist/linux-x86_64/

      - name: Upload zip archive
        uses: actions/upload-artifact@v4
        with:
          name: simplex-toolchain-linux-x86_64
          path: dist/simplex-toolchain-${{ env.SIMPLEX_VERSION }}-linux-x86_64.zip

  build-macos-arm64:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install openssl@3 sqlite3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build toolchain
        run: |
          echo "=== Building Simplex Toolchain v$SIMPLEX_VERSION for macOS arm64 ==="

          PLATFORM="macos-arm64"
          mkdir -p dist/$PLATFORM

          # Helper function to merge LLVM IR files (keeps header from first file only)
          merge_ll() {
            local output=$1
            shift
            local first=$1
            shift

            cp "$first" "$output"
            for f in "$@"; do
              awk '/^define |^declare |^@[a-zA-Z]/ { found=1 } found { print }' "$f" >> "$output"
            done
          }

          OPENSSL_PREFIX=$(brew --prefix openssl@3)
          SQLITE_PREFIX=$(brew --prefix sqlite3)
          export CFLAGS="-I$OPENSSL_PREFIX/include -I$SQLITE_PREFIX/include"
          export LDFLAGS="-L$OPENSSL_PREFIX/lib -L$SQLITE_PREFIX/lib"

          cd compiler/bootstrap
          python3 stage0.py lexer.sx
          python3 stage0.py parser.sx
          python3 stage0.py codegen.sx
          python3 stage0.py main.sx

          merge_ll sxc_combined.ll lexer.ll parser.ll codegen.ll main.ll
          cd ../..

          clang -O2 $CFLAGS $LDFLAGS compiler/bootstrap/sxc_combined.ll runtime/standalone_runtime.c \
            -o dist/$PLATFORM/sxc -lm -lssl -lcrypto -lsqlite3

          cd compiler/bootstrap
          for tool in sxpm cursus sxdoc sxlsp; do
            python3 stage0.py ../../tools/${tool}.sx
            mv ../../tools/${tool}.ll .
            merge_ll ${tool}_combined.ll lexer.ll parser.ll codegen.ll ${tool}.ll
          done
          cd ../..

          for tool in sxpm cursus sxdoc sxlsp; do
            clang -O2 $CFLAGS $LDFLAGS compiler/bootstrap/${tool}_combined.ll runtime/standalone_runtime.c \
              -o dist/$PLATFORM/$tool -lm -lssl -lcrypto -lsqlite3
          done

          chmod +x dist/$PLATFORM/*
          ls -lh dist/$PLATFORM/

          cd dist
          zip -r simplex-toolchain-$SIMPLEX_VERSION-$PLATFORM.zip $PLATFORM/

      - name: Upload zip archive
        uses: actions/upload-artifact@v4
        with:
          name: simplex-toolchain-macos-arm64
          path: dist/simplex-toolchain-${{ env.SIMPLEX_VERSION }}-macos-arm64.zip

  # Windows build disabled - runtime/standalone_runtime.c needs Windows compatibility updates
  # (execinfo.h doesn't exist on Windows, needs conditional compilation)

  release:
    needs: [build-linux-x86_64, build-macos-arm64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/simplex-toolchain-linux-x86_64/simplex-toolchain-*.zip
            artifacts/simplex-toolchain-macos-arm64/simplex-toolchain-*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
