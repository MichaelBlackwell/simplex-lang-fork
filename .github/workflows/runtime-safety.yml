name: Runtime Safety CI

on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        sanitizer: [address, undefined, thread]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang llvm libssl-dev libsqlite3-dev

      - name: Build Simplex compiler
        run: |
          # Use pre-compiled LLVM IR (self-hosted compiler output)
          # No Python bootstrap needed - sxc_combined.ll is checked into repo
          if [ ! -f compiler/bootstrap/sxc_combined.ll ]; then
            echo "Error: compiler/bootstrap/sxc_combined.ll not found"
            exit 1
          fi

          echo "Using pre-compiled sxc_combined.ll (self-hosted)"
          wc -l compiler/bootstrap/sxc_combined.ll

          # Create build directory and link compiler
          mkdir -p build
          clang -O2 \
            compiler/bootstrap/sxc_combined.ll \
            runtime/standalone_runtime.c \
            -o build/sxc \
            -lm -lssl -lcrypto -lsqlite3 -lpthread

          chmod +x build/sxc
          echo "Simplex compiler built successfully"
          
      - name: Run tests with sanitizers
        run: |
          # Create a simple test file
          cat > test_hello.sx << 'SXEOF'
          fn main() -> i64 {
              println("Hello from Simplex!");
              0
          }
          SXEOF

          # Compile test with the Simplex compiler
          ./build/sxc test_hello.sx

          echo "Building and running with ${{ matrix.sanitizer }} sanitizer..."

          case "${{ matrix.sanitizer }}" in
            "address")
              export ASAN_OPTIONS=detect_leaks=1:halt_on_error=1
              clang -O1 -g -fsanitize=address \
                  -fno-omit-frame-pointer \
                  -Wno-format \
                  runtime/standalone_runtime.c \
                  test_hello.ll -o test_sanitized -lpthread -lm -lssl -lcrypto -lsqlite3
              ;;

            "undefined")
              export UBSAN_OPTIONS=halt_on_error=1
              clang -O1 -g -fsanitize=undefined \
                  -fno-omit-frame-pointer \
                  -Wno-format \
                  runtime/standalone_runtime.c \
                  test_hello.ll -o test_sanitized -lpthread -lm -lssl -lcrypto -lsqlite3
              ;;

            "thread")
              export TSAN_OPTIONS=halt_on_error=1
              clang -O1 -g -fsanitize=thread \
                  -fno-omit-frame-pointer \
                  -Wno-format \
                  runtime/standalone_runtime.c \
                  test_hello.ll -o test_sanitized -lpthread -lm -lssl -lcrypto -lsqlite3
              ;;
          esac

          echo "Running test under ${{ matrix.sanitizer }} sanitizer..."
          if ./test_sanitized; then
            echo "Tests passed under ${{ matrix.sanitizer }}"
          else
            echo "Tests failed under ${{ matrix.sanitizer }}"
            exit 1
          fi

      - name: Summary
        run: |
          echo "=== Runtime Safety CI Summary ==="
          echo "Sanitizer: ${{ matrix.sanitizer }}"
          echo "Status: All tests passed"
