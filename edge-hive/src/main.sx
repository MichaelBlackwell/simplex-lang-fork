// Edge Hive - CLI Entry Point
// A standalone command-line interface for the Edge Hive
//
// This provides:
// - Interactive REPL mode for queries and commands
// - Status display and diagnostics
// - Belief inspection and management
// - Federation control
//
// Usage:
//   edge-hive                    # Start in interactive mode
//   edge-hive --status           # Show hive status and exit
//   edge-hive --query "..."      # Single query and exit
//
// This module requires all other edge-hive modules

// =============================================================================
// Constants
// =============================================================================

fn CMD_QUIT() -> i64 { 1 }
fn CMD_STATUS() -> i64 { 2 }
fn CMD_HELP() -> i64 { 3 }
fn CMD_QUERY() -> i64 { 4 }
fn CMD_BELIEFS() -> i64 { 5 }
fn CMD_SYNC() -> i64 { 6 }
fn CMD_PREF() -> i64 { 7 }
fn CMD_CLEAR() -> i64 { 8 }
fn CMD_CONNECT() -> i64 { 9 }
fn CMD_DISCONNECT() -> i64 { 10 }
fn CMD_MODEL() -> i64 { 11 }

// =============================================================================
// Main Entry Point
// =============================================================================

fn main() -> i64 {
    println(string_from(""));
    println(string_from("╔══════════════════════════════════════════════════════════════╗"));
    println(string_from("║              SIMPLEX EDGE HIVE v0.9.9                         ║"));
    println(string_from("║         Local-First Cognitive Intelligence                    ║"));
    println(string_from("╚══════════════════════════════════════════════════════════════╝"));
    println(string_from(""));

    // Initialize the hive
    let hive: i64 = initialize_hive();
    if hive == 0 {
        println(string_from("ERROR: Failed to initialize Edge Hive"));
        return 1;
    }

    // Print initial status
    print_welcome(hive);

    // Run the interactive loop
    let exit_code: i64 = run_repl(hive);

    // Cleanup
    shutdown_hive(hive);

    exit_code
}

// =============================================================================
// Hive Initialization
// =============================================================================

fn initialize_hive() -> i64 {
    println(string_from("Initializing Edge Hive..."));

    // Detect device
    print(string_from("  Detecting device capabilities... "));
    let profile: i64 = detect_device_profile();
    let device_class: i64 = device_get_class(profile);
    println(device_class_name(device_class));

    // Create hive (using local-only mode for standalone)
    print(string_from("  Creating cognitive hive... "));
    let endpoint: i64 = string_from("wss://localhost:9000");  // Default local endpoint
    let device_id: i64 = generate_device_id_simple();
    let hive: i64 = edge_hive_new(device_id, endpoint);

    if hive == 0 {
        println(string_from("FAILED"));
        return 0;
    }
    println(string_from("OK"));

    // Put in local-first mode (no cloud dependency)
    print(string_from("  Configuring for local-first operation... "));
    edge_hive_test_mode(hive);
    println(string_from("OK"));

    // Print specialist summary
    print(string_from("  Loading specialists... "));
    let specialists: i64 = hive_specialists(hive);
    let count: i64 = specialist_registry_count(specialists);
    print_i64(count);
    println(string_from(" loaded"));

    // Check local model
    let local_model: i64 = hive_local_model(hive);
    if local_model_is_none(local_model) != 1 {
        print(string_from("  Local model: "));
        if local_model_is_ready(local_model) == 1 {
            let info: i64 = local_model_info(local_model);
            println(model_info_name(info));
        } else {
            println(string_from("Loading..."));
        }
    } else {
        println(string_from("  Local model: None (cloud fallback mode)"));
    }

    println(string_from(""));
    hive
}

fn generate_device_id_simple() -> i64 {
    // Generate unique device ID combining timestamp and random component
    // This prevents collisions from devices initialized at the same second
    let timestamp: i64 = time_now();
    let random_part: i64 = random_int(0, 999999);

    // Combine: timestamp provides base uniqueness, random handles same-second cases
    // Result space: ~10^15 unique IDs (vs old 10^9)
    (timestamp % 1000000000) * 1000000 + random_part
}

// =============================================================================
// Welcome Message
// =============================================================================

fn print_welcome(hive: i64) -> i64 {
    let profile: i64 = hive_device_profile(hive);
    let device_class: i64 = device_get_class(profile);
    let ram: i64 = device_get_ram_mb(profile);

    println(string_from("Type 'help' for available commands, or just ask a question."));
    println(string_from("Type 'quit' or 'exit' to shutdown."));
    println(string_from(""));

    0
}

// =============================================================================
// Interactive REPL
// =============================================================================

fn run_repl(hive: i64) -> i64 {
    let running: i64 = 1;

    while running == 1 {
        // Show prompt
        print(string_from("edge> "));

        // Read user input
        let input: i64 = read_line();
        if input == 0 {
            // EOF or error
            running = 0;
            continue;
        }

        // Trim whitespace
        let trimmed: i64 = string_trim(input);
        if string_len(trimmed) == 0 {
            continue;  // Empty line, show prompt again
        }

        // Parse command
        let cmd: i64 = parse_command(trimmed);

        if cmd == CMD_QUIT() {
            running = 0;
        } else if cmd == CMD_HELP() {
            print_help();
        } else if cmd == CMD_STATUS() {
            hive_print_status(hive);
        } else if cmd == CMD_BELIEFS() {
            print_beliefs(hive);
        } else if cmd == CMD_SYNC() {
            do_sync(hive);
        } else if cmd == CMD_CONNECT() {
            do_connect(hive);
        } else if cmd == CMD_DISCONNECT() {
            do_disconnect(hive);
        } else if cmd == CMD_MODEL() {
            print_model_status(hive);
        } else if cmd == CMD_CLEAR() {
            clear_screen();
        } else if cmd == CMD_PREF() {
            handle_pref_command(hive, trimmed);
        } else {
            // Treat as a query
            handle_query(hive, trimmed);
        }

        // Run maintenance cycle
        hive_maintenance_cycle(hive);
    }

    0
}

// =============================================================================
// Command Parsing
// =============================================================================

fn parse_command(input: i64) -> i64 {
    let lower: i64 = string_to_lower(input);

    if string_eq(lower, string_from("quit")) == 1 { return CMD_QUIT(); }
    if string_eq(lower, string_from("exit")) == 1 { return CMD_QUIT(); }
    if string_eq(lower, string_from("q")) == 1 { return CMD_QUIT(); }

    if string_eq(lower, string_from("help")) == 1 { return CMD_HELP(); }
    if string_eq(lower, string_from("?")) == 1 { return CMD_HELP(); }
    if string_eq(lower, string_from("h")) == 1 { return CMD_HELP(); }

    if string_eq(lower, string_from("status")) == 1 { return CMD_STATUS(); }
    if string_eq(lower, string_from("info")) == 1 { return CMD_STATUS(); }

    if string_eq(lower, string_from("beliefs")) == 1 { return CMD_BELIEFS(); }
    if string_eq(lower, string_from("belief")) == 1 { return CMD_BELIEFS(); }

    if string_eq(lower, string_from("sync")) == 1 { return CMD_SYNC(); }

    if string_eq(lower, string_from("connect")) == 1 { return CMD_CONNECT(); }
    if string_eq(lower, string_from("disconnect")) == 1 { return CMD_DISCONNECT(); }

    if string_eq(lower, string_from("model")) == 1 { return CMD_MODEL(); }

    if string_eq(lower, string_from("clear")) == 1 { return CMD_CLEAR(); }
    if string_eq(lower, string_from("cls")) == 1 { return CMD_CLEAR(); }

    if string_starts_with(lower, string_from("pref ")) == 1 { return CMD_PREF(); }
    if string_starts_with(lower, string_from("set ")) == 1 { return CMD_PREF(); }

    // Default: treat as query
    CMD_QUERY()
}

// =============================================================================
// Help Command
// =============================================================================

fn print_help() -> i64 {
    println(string_from(""));
    println(string_from("╔══════════════════════════════════════════════════════════════╗"));
    println(string_from("║                    AVAILABLE COMMANDS                         ║"));
    println(string_from("╠══════════════════════════════════════════════════════════════╣"));
    println(string_from("║  QUERIES                                                      ║"));
    println(string_from("║    Just type your question or request                         ║"));
    println(string_from("║    Example: What time is it?                                  ║"));
    println(string_from("║    Example: Remind me to call mom tomorrow                    ║"));
    println(string_from("║                                                               ║"));
    println(string_from("║  COMMANDS                                                     ║"));
    println(string_from("║    help, ?        Show this help message                      ║"));
    println(string_from("║    status, info   Show hive status and statistics             ║"));
    println(string_from("║    beliefs        Show stored beliefs and preferences         ║"));
    println(string_from("║    model          Show local model status                     ║"));
    println(string_from("║    sync           Sync beliefs with federation                ║"));
    println(string_from("║    connect        Connect to cloud federation                 ║"));
    println(string_from("║    disconnect     Disconnect from federation                  ║"));
    println(string_from("║    clear, cls     Clear the screen                            ║"));
    println(string_from("║    quit, exit, q  Shutdown and exit                           ║"));
    println(string_from("║                                                               ║"));
    println(string_from("║  PREFERENCES                                                  ║"));
    println(string_from("║    pref <key> <value>   Set a preference                      ║"));
    println(string_from("║    Example: pref theme dark                                   ║"));
    println(string_from("║    Example: pref response_style brief                         ║"));
    println(string_from("╚══════════════════════════════════════════════════════════════╝"));
    println(string_from(""));
    0
}

// =============================================================================
// Query Handling
// =============================================================================

fn handle_query(hive: i64, query: i64) -> i64 {
    println(string_from(""));

    // Create payload
    let payload: i64 = vec_new();
    vec_push(payload, query);

    // Process through cognitive cycle
    print(string_from("Processing... "));
    let response: i64 = hive_handle_request(hive, REQUEST_QUERY(), payload);

    if response == 0 {
        println(string_from(""));
        println(string_from("No response generated."));
        println(string_from(""));
        return 1;
    }

    // Extract response parts
    let result: i64 = vec_get(response, 0);
    let status: i64 = vec_get(response, 1);
    let confidence: i64 = vec_get(response, 2);
    let source: i64 = 0;
    if vec_len(response) > 3 {
        source = vec_get(response, 3);
    }

    println(string_from(""));

    // Display response
    if result != 0 {
        println(string_from("Response:"));
        println(string_from("─────────────────────────────────────────────────────────────"));
        println(result);
        println(string_from("─────────────────────────────────────────────────────────────"));
    } else {
        println(string_from("No specific response available."));
    }

    // Display metadata
    print(string_from("Confidence: "));
    print_i64(confidence / 10);
    print(string_from("."));
    print_i64(confidence % 10);
    println(string_from("%"));

    if source != 0 {
        print(string_from("Source: "));
        println(source);
    }

    println(string_from(""));
    0
}

// =============================================================================
// Belief Display
// =============================================================================

fn print_beliefs(hive: i64) -> i64 {
    let beliefs: i64 = hive_belief_store(hive);

    println(string_from(""));
    println(string_from("╔══════════════════════════════════════════════════════════════╗"));
    println(string_from("║                    BELIEF STORE                               ║"));
    println(string_from("╚══════════════════════════════════════════════════════════════╝"));

    belief_store_print_stats(beliefs);

    // Print some key beliefs
    println(string_from(""));
    println(string_from("── Preferences ──"));

    let theme: i64 = belief_get_preference(beliefs, string_from("theme"));
    print(string_from("  theme: "));
    if theme == 1 { println(string_from("dark")); }
    else if theme == 2 { println(string_from("light")); }
    else { println(string_from("(not set)")); }

    let style: i64 = belief_get_preference(beliefs, string_from("response_style"));
    print(string_from("  response_style: "));
    if style == 1 { println(string_from("brief")); }
    else if style == 2 { println(string_from("detailed")); }
    else { println(string_from("(not set)")); }

    println(string_from(""));
    println(string_from("── Context ──"));

    let battery: i64 = belief_get_context(beliefs, string_from("battery"));
    print(string_from("  battery: "));
    print_i64(battery);
    println(string_from("%"));

    let network: i64 = belief_get_context(beliefs, string_from("network"));
    print(string_from("  network: "));
    println(network_state_name(network));

    println(string_from(""));
    0
}

// =============================================================================
// Model Status
// =============================================================================

fn print_model_status(hive: i64) -> i64 {
    let local_model: i64 = hive_local_model(hive);

    println(string_from(""));
    println(string_from("╔══════════════════════════════════════════════════════════════╗"));
    println(string_from("║                    LOCAL MODEL STATUS                         ║"));
    println(string_from("╚══════════════════════════════════════════════════════════════╝"));

    if local_model_is_none(local_model) == 1 {
        println(string_from(""));
        println(string_from("No local model configured for this device class."));
        println(string_from("All queries will be delegated to cloud federation."));
        println(string_from(""));
        return 0;
    }

    let info: i64 = local_model_info(local_model);

    println(string_from(""));
    print(string_from("Model: "));
    println(model_info_name(info));

    print(string_from("Parameters: "));
    let params: i64 = model_info_params(info);
    if params >= 1000 {
        print_i64(params / 1000);
        println(string_from("B"));
    } else {
        print_i64(params);
        println(string_from("M"));
    }

    print(string_from("Context Length: "));
    print_i64(model_info_context(info));
    println(string_from(" tokens"));

    print(string_from("Status: "));
    if local_model_is_ready(local_model) == 1 {
        println(string_from("Ready"));
    } else {
        let state: i64 = local_model_state(local_model);
        if state == MODEL_STATE_LOADING() {
            println(string_from("Loading..."));
        } else if state == MODEL_STATE_ERROR() {
            println(string_from("Error"));
        } else {
            println(string_from("Not loaded"));
        }
    }

    // Stats
    let stats: i64 = local_model_stats(local_model);
    println(string_from(""));
    println(string_from("── Statistics ──"));
    print(string_from("Total inferences: "));
    print_i64(stats_total_inferences(stats));
    println(string_from(""));
    print(string_from("Total tokens generated: "));
    print_i64(stats_total_tokens(stats));
    println(string_from(""));

    let avg_tps: i64 = stats_avg_tps(stats);
    if avg_tps > 0 {
        print(string_from("Average tokens/sec: "));
        print_i64(avg_tps / 100);
        print(string_from("."));
        print_i64((avg_tps / 10) % 10);
        println(string_from(""));
    }

    println(string_from(""));
    0
}

// =============================================================================
// Federation Commands
// =============================================================================

fn do_sync(hive: i64) -> i64 {
    println(string_from(""));
    let fed: i64 = hive_federation(hive);
    let beliefs: i64 = hive_belief_store(hive);

    if federation_is_connected(fed) == 0 {
        println(string_from("Not connected to federation. Use 'connect' first."));
        println(string_from(""));
        return 1;
    }

    print(string_from("Syncing beliefs... "));
    let result: i64 = federation_sync_beliefs(fed, beliefs);
    if result == 1 {
        println(string_from("OK"));
    } else {
        println(string_from("FAILED"));
    }
    println(string_from(""));
    0
}

fn do_connect(hive: i64) -> i64 {
    println(string_from(""));
    let fed: i64 = hive_federation(hive);

    if federation_is_connected(fed) == 1 {
        println(string_from("Already connected to federation."));
        println(string_from(""));
        return 0;
    }

    print(string_from("Connecting to federation... "));
    let result: i64 = federation_connect(fed);
    if result == 1 {
        println(string_from("OK"));
    } else {
        println(string_from("FAILED (running in offline mode)"));
    }
    println(string_from(""));
    0
}

fn do_disconnect(hive: i64) -> i64 {
    println(string_from(""));
    let fed: i64 = hive_federation(hive);

    if federation_is_connected(fed) == 0 {
        println(string_from("Not connected to federation."));
        println(string_from(""));
        return 0;
    }

    print(string_from("Disconnecting from federation... "));
    federation_disconnect(fed);
    println(string_from("OK"));
    println(string_from(""));
    0
}

// =============================================================================
// Preference Commands
// =============================================================================

fn handle_pref_command(hive: i64, input: i64) -> i64 {
    // Parse "pref key value" or "set key value"
    let parts: i64 = string_split_whitespace(input);
    let num_parts: i64 = vec_len(parts);

    if num_parts < 3 {
        println(string_from(""));
        println(string_from("Usage: pref <key> <value>"));
        println(string_from("Example: pref theme dark"));
        println(string_from(""));
        return 1;
    }

    let key: i64 = vec_get(parts, 1);
    let value_str: i64 = vec_get(parts, 2);

    // Convert value to integer
    let value: i64 = preference_value_from_string(key, value_str);

    // Set preference
    hive_set_preference(hive, key, value);

    println(string_from(""));
    print(string_from("Set preference: "));
    print(key);
    print(string_from(" = "));
    println(value_str);
    println(string_from(""));
    0
}

fn preference_value_from_string(key: i64, value_str: i64) -> i64 {
    let lower: i64 = string_to_lower(value_str);

    // Theme values
    if string_eq(lower, string_from("dark")) == 1 { return 1; }
    if string_eq(lower, string_from("light")) == 1 { return 2; }
    if string_eq(lower, string_from("auto")) == 1 { return 0; }

    // Style values
    if string_eq(lower, string_from("brief")) == 1 { return 1; }
    if string_eq(lower, string_from("detailed")) == 1 { return 2; }
    if string_eq(lower, string_from("normal")) == 1 { return 0; }

    // Boolean values
    if string_eq(lower, string_from("true")) == 1 { return 1; }
    if string_eq(lower, string_from("false")) == 1 { return 0; }
    if string_eq(lower, string_from("yes")) == 1 { return 1; }
    if string_eq(lower, string_from("no")) == 1 { return 0; }
    if string_eq(lower, string_from("on")) == 1 { return 1; }
    if string_eq(lower, string_from("off")) == 1 { return 0; }

    // Try parsing as integer
    string_to_i64(value_str)
}

// =============================================================================
// Utility Functions
// =============================================================================

fn clear_screen() -> i64 {
    // ANSI escape code to clear screen
    print(string_from("\x1b[2J\x1b[H"));
    0
}

fn device_class_name(class: i64) -> i64 {
    if class == DEVICE_WATCH() { string_from("Watch") }
    else if class == DEVICE_WEARABLE() { string_from("Wearable") }
    else if class == DEVICE_PHONE() { string_from("Phone") }
    else if class == DEVICE_TABLET() { string_from("Tablet") }
    else if class == DEVICE_LAPTOP() { string_from("Laptop") }
    else if class == DEVICE_DESKTOP() { string_from("Desktop") }
    else { string_from("Unknown") }
}

fn network_state_name(state: i64) -> i64 {
    if state == NET_DISCONNECTED() { string_from("disconnected") }
    else if state == NET_WIFI() { string_from("wifi") }
    else if state == NET_CELLULAR() { string_from("cellular") }
    else if state == NET_ETHERNET() { string_from("ethernet") }
    else { string_from("unknown") }
}

// =============================================================================
// Shutdown
// =============================================================================

fn shutdown_hive(hive: i64) -> i64 {
    println(string_from(""));
    println(string_from("Shutting down Edge Hive..."));

    // Check if secure
    if hive_has_identity(hive) == 1 {
        hive_shutdown_secure(hive);
    } else {
        hive_shutdown(hive);
    }

    println(string_from(""));
    println(string_from("Goodbye!"));
    println(string_from(""));
    0
}

// =============================================================================
// Extern Declarations - Runtime
// =============================================================================

extern fn vec_new() -> i64;
extern fn vec_push(v: i64, val: i64) -> i64;
extern fn vec_get(v: i64, idx: i64) -> i64;
extern fn vec_len(v: i64) -> i64;

extern fn string_from(s: &str) -> i64;
extern fn string_len(s: i64) -> i64;
extern fn string_eq(a: i64, b: i64) -> i64;
extern fn string_trim(s: i64) -> i64;
extern fn string_to_lower(s: i64) -> i64;
extern fn string_starts_with(s: i64, prefix: i64) -> i64;
extern fn string_split_whitespace(s: i64) -> i64;
extern fn string_to_i64(s: i64) -> i64;

extern fn print(s: i64) -> i64;
extern fn println(s: i64) -> i64;
extern fn print_i64(n: i64) -> i64;
extern fn read_line() -> i64;

extern fn time_now() -> i64;

// =============================================================================
// Extern Declarations - Edge Hive Modules
// =============================================================================

// From types.sx
extern fn DEVICE_WATCH() -> i64;
extern fn DEVICE_WEARABLE() -> i64;
extern fn DEVICE_PHONE() -> i64;
extern fn DEVICE_TABLET() -> i64;
extern fn DEVICE_LAPTOP() -> i64;
extern fn DEVICE_DESKTOP() -> i64;

extern fn NET_DISCONNECTED() -> i64;
extern fn NET_WIFI() -> i64;
extern fn NET_CELLULAR() -> i64;
extern fn NET_ETHERNET() -> i64;

extern fn REQUEST_QUERY() -> i64;

extern fn MODEL_STATE_LOADING() -> i64;
extern fn MODEL_STATE_ERROR() -> i64;

// From device.sx
extern fn detect_device_profile() -> i64;
extern fn device_get_class(profile: i64) -> i64;
extern fn device_get_ram_mb(profile: i64) -> i64;

// From beliefs.sx
extern fn belief_get_preference(beliefs: i64, key: i64) -> i64;
extern fn belief_get_context(beliefs: i64, key: i64) -> i64;
extern fn belief_store_print_stats(beliefs: i64) -> i64;

// From specialist.sx
extern fn specialist_registry_count(registry: i64) -> i64;

// From federation.sx
extern fn federation_is_connected(fed: i64) -> i64;
extern fn federation_connect(fed: i64) -> i64;
extern fn federation_disconnect(fed: i64) -> i64;
extern fn federation_sync_beliefs(fed: i64, beliefs: i64) -> i64;

// From model.sx
extern fn local_model_is_none(model: i64) -> i64;
extern fn local_model_is_ready(model: i64) -> i64;
extern fn local_model_state(model: i64) -> i64;
extern fn local_model_info(model: i64) -> i64;
extern fn local_model_stats(model: i64) -> i64;
extern fn model_info_name(info: i64) -> i64;
extern fn model_info_params(info: i64) -> i64;
extern fn model_info_context(info: i64) -> i64;
extern fn stats_total_inferences(stats: i64) -> i64;
extern fn stats_total_tokens(stats: i64) -> i64;
extern fn stats_avg_tps(stats: i64) -> i64;

// From hive.sx
extern fn edge_hive_new(device_id: i64, cloud_endpoint: i64) -> i64;
extern fn hive_device_profile(hive: i64) -> i64;
extern fn hive_belief_store(hive: i64) -> i64;
extern fn hive_specialists(hive: i64) -> i64;
extern fn hive_federation(hive: i64) -> i64;
extern fn hive_local_model(hive: i64) -> i64;
extern fn hive_has_identity(hive: i64) -> i64;
extern fn hive_handle_request(hive: i64, request_type: i64, payload: i64) -> i64;
extern fn hive_maintenance_cycle(hive: i64) -> i64;
extern fn hive_set_preference(hive: i64, key: i64, value: i64) -> i64;
extern fn hive_print_status(hive: i64) -> i64;
extern fn hive_shutdown(hive: i64) -> i64;
extern fn hive_shutdown_secure(hive: i64) -> i64;

// From lib.sx
extern fn edge_hive_test_mode(hive: i64) -> i64;
