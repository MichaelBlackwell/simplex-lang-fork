// Edge Hive - Types Unit Tests
// Tests for core type constants and utility functions

fn main() -> i64 {
    println(string_from("=== Edge Hive Types Tests ==="));
    let passed: i64 = 0;
    let failed: i64 = 0;

    // Test device class constants
    if test_device_classes() == 0 {
        passed = passed + 1;
    } else {
        failed = failed + 1;
    }

    // Test network states
    if test_network_states() == 0 {
        passed = passed + 1;
    } else {
        failed = failed + 1;
    }

    // Test sensitivity levels
    if test_sensitivity_levels() == 0 {
        passed = passed + 1;
    } else {
        failed = failed + 1;
    }

    // Test sync strategies
    if test_sync_strategies() == 0 {
        passed = passed + 1;
    } else {
        failed = failed + 1;
    }

    // Test resource limits
    if test_resource_limits() == 0 {
        passed = passed + 1;
    } else {
        failed = failed + 1;
    }

    println(string_from(""));
    print(string_from("Passed: "));
    print_num(passed);
    print(string_from(", Failed: "));
    print_num(failed);
    println(string_from(""));

    failed
}

fn test_device_classes() -> i64 {
    print(string_from("Testing device classes... "));

    // Device classes should be ordered by capability
    if DEVICE_WATCH() >= DEVICE_PHONE() {
        println(string_from("FAIL: watch should be less capable than phone"));
        return 1;
    }

    if DEVICE_PHONE() >= DEVICE_LAPTOP() {
        println(string_from("FAIL: phone should be less capable than laptop"));
        return 1;
    }

    if DEVICE_LAPTOP() >= DEVICE_DESKTOP() {
        println(string_from("FAIL: laptop should be less capable than desktop"));
        return 1;
    }

    // Test device class names
    let watch_name: i64 = device_class_name(DEVICE_WATCH());
    let laptop_name: i64 = device_class_name(DEVICE_LAPTOP());

    println(string_from("OK"));
    0
}

fn test_network_states() -> i64 {
    print(string_from("Testing network states... "));

    // Disconnected should not be connected
    if is_connected(NET_DISCONNECTED()) != 0 {
        println(string_from("FAIL: disconnected should not be connected"));
        return 1;
    }

    // WiFi should be connected
    if is_connected(NET_WIFI()) != 1 {
        println(string_from("FAIL: wifi should be connected"));
        return 1;
    }

    // WiFi should be high bandwidth
    if is_high_bandwidth(NET_WIFI()) != 1 {
        println(string_from("FAIL: wifi should be high bandwidth"));
        return 1;
    }

    // Cellular should not be high bandwidth
    if is_high_bandwidth(NET_CELLULAR()) != 0 {
        println(string_from("FAIL: cellular should not be high bandwidth"));
        return 1;
    }

    // Ethernet should be high bandwidth
    if is_high_bandwidth(NET_ETHERNET()) != 1 {
        println(string_from("FAIL: ethernet should be high bandwidth"));
        return 1;
    }

    println(string_from("OK"));
    0
}

fn test_sensitivity_levels() -> i64 {
    print(string_from("Testing sensitivity levels... "));

    // Levels should be ordered by restriction
    if SENSITIVITY_PUBLIC() >= SENSITIVITY_PRIVATE() {
        println(string_from("FAIL: public should be less restrictive than private"));
        return 1;
    }

    if SENSITIVITY_PRIVATE() >= SENSITIVITY_SENSITIVE() {
        println(string_from("FAIL: private should be less restrictive than sensitive"));
        return 1;
    }

    if SENSITIVITY_SENSITIVE() >= SENSITIVITY_LOCAL() {
        println(string_from("FAIL: sensitive should be less restrictive than local"));
        return 1;
    }

    println(string_from("OK"));
    0
}

fn test_sync_strategies() -> i64 {
    print(string_from("Testing sync strategies... "));

    // Watch should use aggressive sync
    let watch_strategy: i64 = default_sync_strategy(DEVICE_WATCH());
    if watch_strategy != SYNC_AGGRESSIVE() {
        println(string_from("FAIL: watch should use aggressive sync"));
        return 1;
    }

    // Phone should use balanced sync
    let phone_strategy: i64 = default_sync_strategy(DEVICE_PHONE());
    if phone_strategy != SYNC_BALANCED() {
        println(string_from("FAIL: phone should use balanced sync"));
        return 1;
    }

    // Desktop should use local-first sync
    let desktop_strategy: i64 = default_sync_strategy(DEVICE_DESKTOP());
    if desktop_strategy != SYNC_LOCAL_FIRST() {
        println(string_from("FAIL: desktop should use local-first sync"));
        return 1;
    }

    println(string_from("OK"));
    0
}

fn test_resource_limits() -> i64 {
    print(string_from("Testing resource limits... "));

    // Watch should not run local models
    let watch_params: i64 = max_model_params(DEVICE_WATCH());
    if watch_params != 0 {
        println(string_from("FAIL: watch should not support local models"));
        return 1;
    }

    // Phone should support up to 500M params
    let phone_params: i64 = max_model_params(DEVICE_PHONE());
    if phone_params != 500000000 {
        println(string_from("FAIL: phone should support 500M params"));
        return 1;
    }

    // Laptop should support up to 7B params
    let laptop_params: i64 = max_model_params(DEVICE_LAPTOP());
    if laptop_params != 7000000000 {
        println(string_from("FAIL: laptop should support 7B params"));
        return 1;
    }

    // Belief store limits should scale with device
    let watch_beliefs: i64 = max_belief_store_entries(DEVICE_WATCH());
    let phone_beliefs: i64 = max_belief_store_entries(DEVICE_PHONE());
    if watch_beliefs >= phone_beliefs {
        println(string_from("FAIL: phone should have larger belief store than watch"));
        return 1;
    }

    println(string_from("OK"));
    0
}

// Runtime stubs
fn string_from(s: &str) -> i64 { 0 }
fn print(s: i64) -> i64 { 0 }
fn println(s: i64) -> i64 { 0 }
fn print_num(n: i64) -> i64 { 0 }

// Types constants (normally imported from types.sx)
fn DEVICE_UNKNOWN() -> i64 { 0 }
fn DEVICE_WATCH() -> i64 { 1 }
fn DEVICE_WEARABLE() -> i64 { 2 }
fn DEVICE_PHONE() -> i64 { 3 }
fn DEVICE_TABLET() -> i64 { 4 }
fn DEVICE_LAPTOP() -> i64 { 5 }
fn DEVICE_DESKTOP() -> i64 { 6 }

fn device_class_name(class: i64) -> i64 {
    if class == DEVICE_WATCH() { string_from("watch") }
    else if class == DEVICE_LAPTOP() { string_from("laptop") }
    else { string_from("unknown") }
}

fn NET_DISCONNECTED() -> i64 { 0 }
fn NET_WIFI() -> i64 { 1 }
fn NET_CELLULAR() -> i64 { 2 }
fn NET_ETHERNET() -> i64 { 3 }

fn is_connected(net_state: i64) -> i64 {
    if net_state > NET_DISCONNECTED() { 1 } else { 0 }
}

fn is_high_bandwidth(net_state: i64) -> i64 {
    if net_state == NET_WIFI() { 1 }
    else if net_state == NET_ETHERNET() { 1 }
    else { 0 }
}

fn SENSITIVITY_PUBLIC() -> i64 { 0 }
fn SENSITIVITY_PRIVATE() -> i64 { 1 }
fn SENSITIVITY_SENSITIVE() -> i64 { 2 }
fn SENSITIVITY_LOCAL() -> i64 { 3 }

fn SYNC_AGGRESSIVE() -> i64 { 1 }
fn SYNC_BALANCED() -> i64 { 2 }
fn SYNC_LOCAL_FIRST() -> i64 { 3 }

fn default_sync_strategy(device_class: i64) -> i64 {
    if device_class == DEVICE_WATCH() { SYNC_AGGRESSIVE() }
    else if device_class == DEVICE_WEARABLE() { SYNC_AGGRESSIVE() }
    else if device_class == DEVICE_PHONE() { SYNC_BALANCED() }
    else if device_class == DEVICE_TABLET() { SYNC_BALANCED() }
    else { SYNC_LOCAL_FIRST() }
}

fn max_model_params(device_class: i64) -> i64 {
    if device_class == DEVICE_WATCH() { 0 }
    else if device_class == DEVICE_WEARABLE() { 0 }
    else if device_class == DEVICE_PHONE() { 500000000 }
    else if device_class == DEVICE_TABLET() { 1000000000 }
    else if device_class == DEVICE_LAPTOP() { 7000000000 }
    else if device_class == DEVICE_DESKTOP() { 70000000000 }
    else { 0 }
}

fn max_belief_store_entries(device_class: i64) -> i64 {
    if device_class == DEVICE_WATCH() { 100 }
    else if device_class == DEVICE_PHONE() { 10000 }
    else { 1000 }
}
