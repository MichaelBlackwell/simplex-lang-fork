// Test file for Regex Library
// Tests: regex_new, regex_is_match, regex_find, regex_replace, etc.

fn test_regex_new() -> i64 {
    let rx: i64 = regex_new("[0-9]+", 0)

    if rx == 0 {
        println("FAIL: regex_new should not return 0")
        return 1
    }

    regex_free(rx)
    println("PASS: test_regex_new")
    0
}

fn test_is_match() -> i64 {
    let rx: i64 = regex_new("[0-9]+", 0)
    if rx == 0 {
        println("FAIL: could not compile regex")
        return 1
    }

    let result1: i64 = regex_is_match(rx, "hello123world")
    let result2: i64 = regex_is_match(rx, "no digits here")

    regex_free(rx)

    if result1 != 1 {
        println("FAIL: should match 'hello123world'")
        return 1
    }

    if result2 != 0 {
        println("FAIL: should not match 'no digits here'")
        return 1
    }

    println("PASS: test_is_match")
    0
}

fn test_find_str() -> i64 {
    let rx: i64 = regex_new("[0-9]+", 0)
    if rx == 0 {
        println("FAIL: could not compile regex")
        return 1
    }

    let found: String = regex_find_str(rx, "price: $42.50")
    regex_free(rx)

    if !string_eq(found, "42") {
        print("FAIL: expected '42', got: ")
        println(found)
        return 1
    }

    println("PASS: test_find_str")
    0
}

fn test_count() -> i64 {
    let rx: i64 = regex_new("[0-9]+", 0)
    if rx == 0 {
        println("FAIL: could not compile regex")
        return 1
    }

    let count: i64 = regex_count(rx, "a1b2c3d4e5")
    regex_free(rx)

    if count != 5 {
        print("FAIL: expected 5 matches, got: ")
        println(int_to_string(count))
        return 1
    }

    println("PASS: test_count")
    0
}

fn test_replace() -> i64 {
    let rx: i64 = regex_new("[0-9]+", 0)
    if rx == 0 {
        println("FAIL: could not compile regex")
        return 1
    }

    let result: String = regex_replace(rx, "a1b2c3", "X")
    regex_free(rx)

    if !string_eq(result, "aXbXcX") {
        print("FAIL: expected 'aXbXcX', got: ")
        println(result)
        return 1
    }

    println("PASS: test_replace")
    0
}

fn test_replace_first() -> i64 {
    let rx: i64 = regex_new("[0-9]+", 0)
    if rx == 0 {
        println("FAIL: could not compile regex")
        return 1
    }

    let result: String = regex_replace_first(rx, "a1b2c3", "X")
    regex_free(rx)

    if !string_eq(result, "aXb2c3") {
        print("FAIL: expected 'aXb2c3', got: ")
        println(result)
        return 1
    }

    println("PASS: test_replace_first")
    0
}

fn test_case_insensitive() -> i64 {
    let rx: i64 = regex_new("hello", 1)  // 1 = case insensitive
    if rx == 0 {
        println("FAIL: could not compile regex")
        return 1
    }

    let result1: i64 = regex_is_match(rx, "HELLO WORLD")
    let result2: i64 = regex_is_match(rx, "Hello There")
    regex_free(rx)

    if result1 != 1 {
        println("FAIL: should match 'HELLO WORLD' case-insensitively")
        return 1
    }

    if result2 != 1 {
        println("FAIL: should match 'Hello There' case-insensitively")
        return 1
    }

    println("PASS: test_case_insensitive")
    0
}

fn test_invalid_pattern() -> i64 {
    let rx: i64 = regex_new("[invalid", 0)  // Unclosed bracket

    if rx != 0 {
        regex_free(rx)
        println("FAIL: invalid pattern should return 0")
        return 1
    }

    println("PASS: test_invalid_pattern")
    0
}

fn test_email_pattern() -> i64 {
    let rx: i64 = regex_new("[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]+", 0)
    if rx == 0 {
        println("FAIL: could not compile email regex")
        return 1
    }

    let result1: i64 = regex_is_match(rx, "user@example.com")
    let result2: i64 = regex_is_match(rx, "not an email")
    regex_free(rx)

    if result1 != 1 {
        println("FAIL: should match valid email")
        return 1
    }

    if result2 != 0 {
        println("FAIL: should not match invalid email")
        return 1
    }

    println("PASS: test_email_pattern")
    0
}

fn main() -> i64 {
    println("=== Regex Tests ===")
    println("")

    var failures: i64 = 0

    failures = failures + test_regex_new()
    failures = failures + test_is_match()
    failures = failures + test_find_str()
    failures = failures + test_count()
    failures = failures + test_replace()
    failures = failures + test_replace_first()
    failures = failures + test_case_insensitive()
    failures = failures + test_invalid_pattern()
    failures = failures + test_email_pattern()

    println("")
    if failures == 0 {
        println("All Regex tests passed!")
    } else {
        print("Regex tests failed: ")
        println(int_to_string(failures))
    }

    failures
}
