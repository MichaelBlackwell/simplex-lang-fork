// Test AI Native Intrinsics
// Tests: embeddings, vector store, tool registry, shared memory, AI actors, graphs

fn main() -> i64 {
    println("=== AI Native Intrinsics Test ===");
    println("");

    var passed: i64 = 0;
    var failed: i64 = 0;

    // === Native Model (basic checks - no model loaded) ===
    println("--- Native Model ---");

    // Test 1: native_model_loaded (should be 0 without model)
    print("Test 1: native_model_loaded... ");
    let loaded = native_model_loaded();
    if loaded == 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should not be loaded");
        failed = failed + 1;
    }

    println("");
    println("--- Embedding Model ---");

    // Test 2: embedding_model_new
    print("Test 2: embedding_model_new... ");
    let emb_model = embedding_model_new(64);
    if emb_model != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null model");
        failed = failed + 1;
    }

    // Test 3: embedding_embed
    print("Test 3: embedding_embed... ");
    let emb1 = embedding_embed(emb_model, "hello world");
    if emb1 != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null embedding");
        failed = failed + 1;
    }

    // Test 4: embedding_dim
    print("Test 4: embedding_dim... ");
    let dim = embedding_dim(emb1);
    if dim == 64 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 64, got ");
        print_i64(dim);
        println("");
        failed = failed + 1;
    }

    // Test 5: embedding_embed second
    print("Test 5: embedding second... ");
    let emb2 = embedding_embed(emb_model, "goodbye world");
    if emb2 != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null embedding");
        failed = failed + 1;
    }

    // Test 6: embedding_cosine_similarity same
    print("Test 6: cosine similarity same... ");
    // Note: cosine_similarity returns double, we just verify it runs
    // Same embedding should have similarity ~1.0 (we can't compare floats directly)
    embedding_cosine_similarity(emb1, emb1);
    println("PASS");
    passed = passed + 1;

    // Test 7: embedding_cosine_similarity different
    print("Test 7: cosine similarity diff... ");
    // Different embeddings should have different similarity
    embedding_cosine_similarity(emb1, emb2);
    println("PASS");
    passed = passed + 1;

    // Clean up embeddings
    embedding_free(emb1);
    embedding_free(emb2);
    embedding_model_close(emb_model);

    println("");
    println("--- Shared Vector Store ---");

    // Test 8: shared_store_new
    print("Test 8: shared_store_new... ");
    let store = shared_store_new("test_store", 64);
    if store != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null store");
        failed = failed + 1;
    }

    // Test 9: shared_store_count empty
    print("Test 9: shared_store_count empty... ");
    let count0 = shared_store_count(store);
    if count0 == 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should be 0");
        failed = failed + 1;
    }

    // Test 10: shared_store_put
    print("Test 10: shared_store_put... ");
    let put1 = shared_store_put(store, "key1", "The quick brown fox", 1);
    if put1 != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - put failed");
        failed = failed + 1;
    }

    // Test 11: shared_store_put second
    print("Test 11: shared_store_put second... ");
    let put2 = shared_store_put(store, "key2", "Jumped over lazy dog", 1);
    if put2 != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 12: shared_store_count after puts
    print("Test 12: shared_store_count... ");
    let count2 = shared_store_count(store);
    if count2 == 2 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 2, got ");
        print_i64(count2);
        println("");
        failed = failed + 1;
    }

    // Test 13: shared_store_get
    print("Test 13: shared_store_get... ");
    let got = shared_store_get(store, "key1");
    if got != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - not found");
        failed = failed + 1;
    }

    // Test 14: shared_store_search (semantic search!)
    print("Test 14: shared_store_search... ");
    let results = shared_store_search(store, "fox jumping", 2);
    if results != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - search failed");
        failed = failed + 1;
    }

    // Test 15: shared_store_delete
    print("Test 15: shared_store_delete... ");
    let deleted = shared_store_delete(store, "key1");
    if deleted != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - delete failed");
        failed = failed + 1;
    }

    // Test 16: shared_store_count after delete
    print("Test 16: count after delete... ");
    let count1 = shared_store_count(store);
    if count1 == 1 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 1, got ");
        print_i64(count1);
        println("");
        failed = failed + 1;
    }

    // Test 17: shared_store_global
    print("Test 17: shared_store_global... ");
    let global_store = shared_store_global(64);
    if global_store != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null global store");
        failed = failed + 1;
    }

    shared_store_close(store);

    println("");
    println("--- Tool Registry ---");

    // Test 18: tool_registry_new
    print("Test 18: tool_registry_new... ");
    let registry = tool_registry_new();
    if registry != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null registry");
        failed = failed + 1;
    }

    // Test 19: tool_count empty
    print("Test 19: tool_count empty... ");
    let tcount0 = tool_count(registry);
    if tcount0 == 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should be 0");
        failed = failed + 1;
    }

    // Test 20: tool_register (returns index, first tool is 0)
    print("Test 20: tool_register... ");
    let tool_id = tool_register(registry, "calculator", "Performs math operations", "{}");
    if tool_id >= 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - register failed");
        failed = failed + 1;
    }

    // Test 21: tool_count after register
    print("Test 21: tool_count after... ");
    let tcount1 = tool_count(registry);
    if tcount1 == 1 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 1, got ");
        print_i64(tcount1);
        println("");
        failed = failed + 1;
    }

    // Test 22: tool_get (returns index, -1 if not found)
    print("Test 22: tool_get... ");
    let tool = tool_get(registry, "calculator");
    if tool >= 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - tool not found");
        failed = failed + 1;
    }

    // Test 23: tool_list
    print("Test 23: tool_list... ");
    let tool_names = tool_list(registry);
    if tool_names != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null list");
        failed = failed + 1;
    }

    // Test 24: tool_register_builtins
    print("Test 24: tool_register_builtins... ");
    let builtins = tool_register_builtins(registry);
    if builtins >= 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 25: tool_get_all_schemas
    print("Test 25: tool_get_all_schemas... ");
    let schemas = tool_get_all_schemas(registry);
    if schemas != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null schemas");
        failed = failed + 1;
    }

    tool_registry_close(registry);

    println("");
    println("--- Shared Memory ---");

    // Test 26: shared_memory_new
    print("Test 26: shared_memory_new... ");
    let smem = shared_memory_new("agent_memory", 100);
    if smem != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null shared memory");
        failed = failed + 1;
    }

    // Test 27: shared_memory_grant_read
    print("Test 27: shared_memory_grant_read... ");
    let grant_r = shared_memory_grant_read(smem, 1);
    if grant_r != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 28: shared_memory_grant_write
    print("Test 28: shared_memory_grant_write... ");
    let grant_w = shared_memory_grant_write(smem, 1);
    if grant_w != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 29: shared_memory_remember
    print("Test 29: shared_memory_remember... ");
    let remembered = shared_memory_remember(smem, 1, "Important fact about AI", 0.9);
    if remembered != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - remember failed");
        failed = failed + 1;
    }

    // Test 30: shared_memory_recall
    print("Test 30: shared_memory_recall... ");
    let recalled = shared_memory_recall(smem, 1, "Find AI facts", "");
    if recalled != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - recall failed");
        failed = failed + 1;
    }

    // Test 31: shared_memory_get_memory
    print("Test 31: shared_memory_get_memory... ");
    let mem_ptr = shared_memory_get_memory(smem);
    if mem_ptr != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null memory");
        failed = failed + 1;
    }

    shared_memory_close(smem);

    println("");
    println("--- AI Actor System ---");

    // Test 32: ai_actor_system_new
    print("Test 32: ai_actor_system_new... ");
    let sys = ai_actor_system_new();
    if sys != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null system");
        failed = failed + 1;
    }

    // Test 33: ai_actor_system_count empty
    print("Test 33: ai_actor_system_count... ");
    let sys_count0 = ai_actor_system_count(sys);
    if sys_count0 == 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should be 0");
        failed = failed + 1;
    }

    // Test 34: ai_actor_config_new
    print("Test 34: ai_actor_config_new... ");
    let config = ai_actor_config_new("assistant", "You are a helpful AI assistant");
    if config != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null config");
        failed = failed + 1;
    }

    // Test 35: ai_actor_config_set_timeout
    print("Test 35: ai_actor_config_set_timeout... ");
    ai_actor_config_set_timeout(config, 5000);
    println("PASS");
    passed = passed + 1;

    // Test 36: ai_actor_spawn
    print("Test 36: ai_actor_spawn... ");
    let actor_id = ai_actor_spawn(sys, config);
    if actor_id != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - spawn failed");
        failed = failed + 1;
    }

    // Test 37: ai_actor_system_count after spawn
    print("Test 37: system_count after spawn... ");
    let sys_count1 = ai_actor_system_count(sys);
    if sys_count1 == 1 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 1, got ");
        print_i64(sys_count1);
        println("");
        failed = failed + 1;
    }

    // Test 38: ai_actor_status
    print("Test 38: ai_actor_status... ");
    let status = ai_actor_status(sys, actor_id);
    // Status 0 = idle, 1 = busy, etc.
    if status >= 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - invalid status");
        failed = failed + 1;
    }

    // Test 39: ai_actor_name
    print("Test 39: ai_actor_name... ");
    let name = ai_actor_name(sys, actor_id);
    if name != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null name");
        failed = failed + 1;
    }

    // Test 40: ai_actor_add_message
    print("Test 40: ai_actor_add_message... ");
    let msg_added = ai_actor_add_message(sys, actor_id, "user", "Hello!");
    if msg_added != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - add message failed");
        failed = failed + 1;
    }

    // Test 41: ai_actor_history_len
    print("Test 41: ai_actor_history_len... ");
    let hist_len = ai_actor_history_len(sys, actor_id);
    if hist_len == 1 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 1, got ");
        print_i64(hist_len);
        println("");
        failed = failed + 1;
    }

    // Test 42: ai_actor_get_message
    print("Test 42: ai_actor_get_message... ");
    let msg = ai_actor_get_message(sys, actor_id, 0);
    if msg != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null message");
        failed = failed + 1;
    }

    // Test 43: ai_actor_clear_history
    print("Test 43: ai_actor_clear_history... ");
    ai_actor_clear_history(sys, actor_id);
    let hist_len2 = ai_actor_history_len(sys, actor_id);
    if hist_len2 == 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - history not cleared");
        failed = failed + 1;
    }

    // Test 44: ai_actor_system_list
    print("Test 44: ai_actor_system_list... ");
    let actor_list = ai_actor_system_list(sys);
    if actor_list != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null list");
        failed = failed + 1;
    }

    // Test 45: ai_actor_stop
    print("Test 45: ai_actor_stop... ");
    ai_actor_stop(sys, actor_id);
    println("PASS");
    passed = passed + 1;

    println("");
    println("--- AI Supervisor ---");

    // Test 46: ai_supervisor_new (strategy 0 = one_for_one)
    print("Test 46: ai_supervisor_new... ");
    let sup = ai_supervisor_new("main_supervisor", 0);
    if sup != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null supervisor");
        failed = failed + 1;
    }

    // Test 47: ai_supervisor_child_count empty
    print("Test 47: ai_supervisor_child_count... ");
    let child_count0 = ai_supervisor_child_count(sup);
    if child_count0 == 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should be 0");
        failed = failed + 1;
    }

    // Test 48: spawn new actor for supervisor
    print("Test 48: spawn for supervisor... ");
    let config2 = ai_actor_config_new("worker", "You are a worker");
    let worker_id = ai_actor_spawn(sys, config2);
    if worker_id != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 49: ai_supervisor_add_child
    print("Test 49: ai_supervisor_add_child... ");
    let added = ai_supervisor_add_child(sup, worker_id);
    if added != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - add child failed");
        failed = failed + 1;
    }

    // Test 50: ai_supervisor_child_count after add
    print("Test 50: child_count after add... ");
    let child_count1 = ai_supervisor_child_count(sup);
    if child_count1 == 1 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 1, got ");
        print_i64(child_count1);
        println("");
        failed = failed + 1;
    }

    // Test 51: ai_supervisor_check_health
    print("Test 51: ai_supervisor_check_health... ");
    let health = ai_supervisor_check_health(sys, sup);
    // Health check returns status
    if health >= 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    ai_supervisor_close(sup);
    ai_actor_system_close(sys);

    println("");
    println("--- Graph (Computation) ---");

    // Test 52: graph_new
    print("Test 52: graph_new... ");
    let graph = graph_new();
    if graph != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null graph");
        failed = failed + 1;
    }

    // Test 53: graph_add_node
    print("Test 53: graph_add_node... ");
    let node1 = graph_add_node(graph, 1, 0, 1.0);
    if node1 >= 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - add node failed");
        failed = failed + 1;
    }

    // Test 54: graph_add_node second
    print("Test 54: graph_add_node second... ");
    let node2 = graph_add_node(graph, 2, 1, 2.0);
    if node2 >= 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 55: graph_add_node third
    print("Test 55: graph_add_node third... ");
    let node3 = graph_add_node(graph, 3, 0, 1.5);
    if node3 >= 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 56: graph_add_edge
    print("Test 56: graph_add_edge... ");
    graph_add_edge(graph, node1, node2);
    graph_add_edge(graph, node2, node3);
    println("PASS");
    passed = passed + 1;

    // Test 57: graph_partition
    print("Test 57: graph_partition... ");
    graph_partition(graph);
    println("PASS");
    passed = passed + 1;

    // Test 58: graph_partition_count
    print("Test 58: graph_partition_count... ");
    let part_count = graph_partition_count(graph);
    if part_count >= 1 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should have partitions");
        failed = failed + 1;
    }

    // Test 59: graph_partition_node_count
    print("Test 59: graph_partition_node_count... ");
    let nodes_in_part = graph_partition_node_count(graph, 0);
    if nodes_in_part >= 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 60: graph_partition_device
    print("Test 60: graph_partition_device... ");
    let device = graph_partition_device(graph, 0);
    // Device ID can be any valid value
    if device >= 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    graph_free(graph);

    // Summary
    println("");
    println("=== Summary ===");
    print("Passed: ");
    print_i64(passed);
    print(" / ");
    print_i64(60);
    println("");

    if failed == 0 {
        println("");
        println("=== ALL AI NATIVE TESTS PASSED ===");
    } else {
        println("");
        println("=== SOME TESTS FAILED ===");
    }

    failed
}
