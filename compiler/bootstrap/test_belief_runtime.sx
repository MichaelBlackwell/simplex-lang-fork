// Test belief guard runtime using runtime functions directly
// Uses bitcast to pass f64 values as i64
// NOTE: Functions belief_register_i64, belief_guard_get_confidence, etc.
//       are declared in stage0.py and linked to standalone_runtime.c

fn main() -> i64 {
    let passed = 0;
    let failed = 0;
    print("=== Belief Guard Runtime Tests ===\n");

    // Test 1: Register a belief (0.8 confidence)
    // 0.8 in IEEE 754 double = 0x3FE999999999999A = 4604930618986332314
    print("Test 1: belief_register... ");
    let conf_08_bits: i64 = 4604930618986332314;
    let zero_bits: i64 = 0;
    // Create SxString from literal and pass pointer as i64
    let name1 = make_sx_string("obstacle");
    let r1 = belief_register_i64(name1, conf_08_bits, zero_bits);
    if r1 > 0 {
        print("PASS\n");
        passed = passed + 1;
    } else {
        print("FAIL\n");
        failed = failed + 1;
    }

    // Test 2: Get confidence
    print("Test 2: belief_guard_get_confidence... ");
    let conf_bits = belief_guard_get_confidence(name1);
    let diff = conf_bits - conf_08_bits;
    if diff < 100 && diff > -100 {
        print("PASS\n");
        passed = passed + 1;
    } else {
        print("FAIL (bits mismatch)\n");
        failed = failed + 1;
    }

    // Test 3: Register belief with derivative (0.6, -0.15)
    // 0.6 = 4603579539098312499
    // -0.15 = -4610842590788288205
    print("Test 3: belief_register with derivative... ");
    let conf_06_bits: i64 = 4603579539098312499;
    let der_neg015_bits: i64 = -4610842590788288205;
    let name2 = make_sx_string("velocity");
    let r3 = belief_register_i64(name2, conf_06_bits, der_neg015_bits);
    if r3 > 0 {
        print("PASS\n");
        passed = passed + 1;
    } else {
        print("FAIL\n");
        failed = failed + 1;
    }

    // Test 4: Get derivative
    print("Test 4: belief_guard_get_derivative... ");
    let der_bits = belief_guard_get_derivative(name2);
    let der_diff = der_bits - der_neg015_bits;
    if der_diff < 100 && der_diff > -100 {
        print("PASS\n");
        passed = passed + 1;
    } else {
        print("FAIL (derivative mismatch)\n");
        failed = failed + 1;
    }

    // Test 5: Update belief
    // 0.9 = 4606281698874543309
    print("Test 5: belief_update... ");
    let conf_09_bits: i64 = 4606281698874543309;
    belief_update_i64(name1, conf_09_bits);
    let updated_bits = belief_guard_get_confidence(name1);
    let update_diff = updated_bits - conf_09_bits;
    if update_diff < 100 && update_diff > -100 {
        print("PASS\n");
        passed = passed + 1;
    } else {
        print("FAIL\n");
        failed = failed + 1;
    }

    // Summary
    print("\n=== Summary ===\n");
    print("Passed: ");
    print_i64(passed);
    print(" / ");
    print_i64(passed + failed);
    print("\n");

    if failed == 0 {
        print("All tests passed!\n");
    }

    failed
}
