// Test regex intrinsics
// Tests: regex_* functions for pattern matching

fn main() -> i64 {
    println("=== Regex Intrinsics Test ===");
    println("");

    var passed: i64 = 0;
    var failed: i64 = 0;

    // === Regex Creation ===
    println("--- Regex Creation ---");

    // Test 1: regex_new simple pattern
    print("Test 1: regex_new... ");
    let rx = regex_new("hello", 0);
    if rx != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null regex");
        failed = failed + 1;
    }

    // Test 2: regex_new with metacharacters
    print("Test 2: regex_new metachar... ");
    let rx2 = regex_new("[0-9]+", 0);
    if rx2 != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null regex");
        failed = failed + 1;
    }

    // Test 3: regex_new with groups (POSIX extended regex)
    print("Test 3: regex_new groups... ");
    let rx3 = regex_new("([a-z]+)@([a-z]+)", 0);
    if rx3 != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null regex");
        failed = failed + 1;
    }

    println("");
    println("--- Pattern Matching ---");

    // Test 4: regex_is_match true
    print("Test 4: regex_is_match true... ");
    if regex_is_match(rx, "hello world") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should match");
        failed = failed + 1;
    }

    // Test 5: regex_is_match false
    print("Test 5: regex_is_match false... ");
    if regex_is_match(rx, "goodbye world") == 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should not match");
        failed = failed + 1;
    }

    // Test 6: regex_is_match digits
    print("Test 6: regex_is_match digits... ");
    if regex_is_match(rx2, "abc123def") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should match digits");
        failed = failed + 1;
    }

    // Test 7: regex_is_match no digits
    print("Test 7: regex_is_match no digits... ");
    if regex_is_match(rx2, "abcdef") == 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should not match");
        failed = failed + 1;
    }

    println("");
    println("--- Find Operations ---");

    // Test 8: regex_find position (returns packed start<<32|end)
    print("Test 8: regex_find position... ");
    let pos = regex_find(rx, "say hello there");
    // Extract start position from high 32 bits
    let start = pos / 4294967296;  // pos >> 32
    if start == 4 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected start=4, got ");
        print_i64(start);
        println("");
        failed = failed + 1;
    }

    // Test 9: regex_find not found
    print("Test 9: regex_find not found... ");
    let pos2 = regex_find(rx, "goodbye");
    if pos2 < 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected -1, got ");
        print_i64(pos2);
        println("");
        failed = failed + 1;
    }

    // Test 10: regex_find_str
    print("Test 10: regex_find_str... ");
    let found = regex_find_str(rx2, "abc123def456");
    if found != 0 {
        if string_eq(found, "123") != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            print("FAIL - got: ");
            print(found);
            println("");
            failed = failed + 1;
        }
    } else {
        println("FAIL - null result");
        failed = failed + 1;
    }

    println("");
    println("--- Count Operations ---");

    // Test 11: regex_count single
    print("Test 11: regex_count single... ");
    let count1 = regex_count(rx, "hello");
    if count1 == 1 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 1, got ");
        print_i64(count1);
        println("");
        failed = failed + 1;
    }

    // Test 12: regex_count multiple
    print("Test 12: regex_count multiple... ");
    let count2 = regex_count(rx2, "a1b22c333d4444");
    if count2 == 4 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 4, got ");
        print_i64(count2);
        println("");
        failed = failed + 1;
    }

    // Test 13: regex_count zero
    print("Test 13: regex_count zero... ");
    let count3 = regex_count(rx2, "no digits here");
    if count3 == 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 0, got ");
        print_i64(count3);
        println("");
        failed = failed + 1;
    }

    println("");
    println("--- Replace Operations ---");

    // Test 14: regex_replace_first
    print("Test 14: regex_replace_first... ");
    let replaced1 = regex_replace_first(rx, "hello hello", "hi");
    if replaced1 != 0 {
        if string_eq(replaced1, "hi hello") != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            print("FAIL - got: ");
            print(replaced1);
            println("");
            failed = failed + 1;
        }
    } else {
        println("FAIL - null result");
        failed = failed + 1;
    }

    // Test 15: regex_replace all
    print("Test 15: regex_replace all... ");
    let replaced2 = regex_replace(rx, "hello hello hello", "hi");
    if replaced2 != 0 {
        if string_eq(replaced2, "hi hi hi") != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            print("FAIL - got: ");
            print(replaced2);
            println("");
            failed = failed + 1;
        }
    } else {
        println("FAIL - null result");
        failed = failed + 1;
    }

    // Test 16: regex_replace digits
    print("Test 16: regex_replace digits... ");
    let replaced3 = regex_replace(rx2, "a1b2c3", "X");
    if replaced3 != 0 {
        if string_eq(replaced3, "aXbXcX") != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            print("FAIL - got: ");
            print(replaced3);
            println("");
            failed = failed + 1;
        }
    } else {
        println("FAIL - null result");
        failed = failed + 1;
    }

    // Test 17: regex_replace no match
    print("Test 17: regex_replace no match... ");
    let replaced4 = regex_replace(rx, "goodbye", "hi");
    if replaced4 != 0 {
        if string_eq(replaced4, "goodbye") != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            print("FAIL - got: ");
            print(replaced4);
            println("");
            failed = failed + 1;
        }
    } else {
        println("FAIL - null result");
        failed = failed + 1;
    }

    println("");
    println("--- Split Operations ---");

    // Test 18: regex_split
    print("Test 18: regex_split... ");
    let split_rx = regex_new(",\\s*", 0);
    let parts = regex_split(split_rx, "a, b,  c,d");
    let parts_len = vec_len(parts);
    if parts_len == 4 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 4, got ");
        print_i64(parts_len);
        println("");
        failed = failed + 1;
    }

    // Test 19: regex_split verify first part
    print("Test 19: regex_split first part... ");
    if parts_len >= 1 {
        let p0 = vec_get(parts, 0);
        if string_eq(p0, "a") != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            print("FAIL - p0: '");
            print(p0);
            println("'");
            failed = failed + 1;
        }
    } else {
        println("SKIP - no parts");
        failed = failed + 1;
    }

    // Test 20: regex_split no match
    print("Test 20: regex_split no match... ");
    let parts2 = regex_split(split_rx, "hello");
    let parts2_len = vec_len(parts2);
    if parts2_len == 1 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 1, got ");
        print_i64(parts2_len);
        println("");
        failed = failed + 1;
    }

    println("");
    println("--- Group Operations ---");

    // Test 21: regex_group_count
    print("Test 21: regex_group_count... ");
    let groups = regex_group_count(rx3);
    if groups == 2 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 2, got ");
        print_i64(groups);
        println("");
        failed = failed + 1;
    }

    // Test 22: regex_captures
    print("Test 22: regex_captures... ");
    let caps = regex_captures(rx3, "user@domain");
    if caps != 0 {
        let caps_len = vec_len(caps);
        if caps_len >= 3 {
            // caps[0] = full match, caps[1] = first group, caps[2] = second group
            let cap1 = vec_get(caps, 1);
            let cap2 = vec_get(caps, 2);
            if string_eq(cap1, "user") != 0 {
                if string_eq(cap2, "domain") != 0 {
                    println("PASS");
                    passed = passed + 1;
                } else {
                    print("FAIL - cap2: ");
                    print(cap2);
                    println("");
                    failed = failed + 1;
                }
            } else {
                print("FAIL - cap1: ");
                print(cap1);
                println("");
                failed = failed + 1;
            }
        } else {
            print("FAIL - not enough captures, got ");
            print_i64(caps_len);
            println("");
            failed = failed + 1;
        }
    } else {
        println("FAIL - no captures (regex may not have matched)");
        failed = failed + 1;
    }

    println("");
    println("--- Error Handling ---");

    // Test 23: regex_error valid (returns empty string for valid pattern)
    print("Test 23: regex_error valid... ");
    let err1 = regex_error("hello");
    let err1_len = string_len(err1);
    if err1_len == 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - got error: ");
        print(err1);
        println("");
        failed = failed + 1;
    }

    // Test 24: regex_error invalid
    print("Test 24: regex_error invalid... ");
    let err2 = regex_error("[invalid");
    if err2 != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should have error");
        failed = failed + 1;
    }

    // Test 25: common patterns - email-like
    print("Test 25: email pattern... ");
    let email_rx = regex_new("[a-zA-Z0-9]+@[a-zA-Z0-9]+\\.[a-zA-Z]+", 0);
    if email_rx != 0 {
        if regex_is_match(email_rx, "test@example.com") != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - should match email");
            failed = failed + 1;
        }
        regex_free(email_rx);
    } else {
        println("FAIL - invalid pattern");
        failed = failed + 1;
    }

    // Cleanup
    regex_free(rx);
    regex_free(rx2);
    regex_free(rx3);
    regex_free(split_rx);

    // Summary
    println("");
    println("=== Summary ===");
    print("Passed: ");
    print_i64(passed);
    print(" / ");
    print_i64(25);
    println("");

    if failed == 0 {
        println("");
        println("=== ALL REGEX TESTS PASSED ===");
    } else {
        println("");
        println("=== SOME TESTS FAILED ===");
    }

    failed
}
