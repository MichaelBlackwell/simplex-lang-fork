// Test Networking and Crypto Intrinsics

// Socket constants (from POSIX)
// AF_INET = 2
// SOCK_STREAM = 1 (TCP)
// SOCK_DGRAM = 2 (UDP)

// ============ SOCKET CREATION ============

// Test creating a TCP socket
fn test_socket_create_tcp() -> i64 {
    let sock = socket_create(2, 1);  // AF_INET, SOCK_STREAM
    if sock >= 0 {
        socket_close(sock);
        1
    } else {
        0
    }
}

// Test creating a UDP socket
fn test_socket_create_udp() -> i64 {
    let sock = socket_create(2, 2);  // AF_INET, SOCK_DGRAM
    if sock >= 0 {
        socket_close(sock);
        1
    } else {
        0
    }
}

// Test creating multiple sockets
fn test_socket_create_multiple() -> i64 {
    let s1 = socket_create(2, 1);
    let s2 = socket_create(2, 1);
    let s3 = socket_create(2, 1);

    // All should be valid and different
    let result = s1 >= 0 && s2 >= 0 && s3 >= 0 && s1 != s2 && s2 != s3;

    socket_close(s1);
    socket_close(s2);
    socket_close(s3);

    if result {
        1
    } else {
        0
    }
}

// ============ SOCKET OPTIONS ============

// Test setting socket options
fn test_socket_set_reuseaddr() -> i64 {
    let sock = socket_create(2, 1);
    if sock >= 0 {
        socket_set_reuseaddr(sock);
        // If we get here without crash, it worked
        socket_close(sock);
        1
    } else {
        0
    }
}

// Test setting non-blocking mode
fn test_socket_set_nonblocking() -> i64 {
    let sock = socket_create(2, 1);
    if sock >= 0 {
        socket_set_nonblocking(sock);
        // If we get here without crash, it worked
        socket_close(sock);
        1
    } else {
        0
    }
}

// ============ SOCKET BIND ============

// Test binding to a port (use high port to avoid permission issues)
fn test_socket_bind() -> i64 {
    let sock = socket_create(2, 1);  // TCP
    if sock < 0 {
        return 0;
    }

    socket_set_reuseaddr(sock);

    // Bind to 127.0.0.1:0 (let OS choose port)
    // 127.0.0.1 = 0x7F000001 = 2130706433
    let result = socket_bind(sock, 2130706433, 0);

    socket_close(sock);

    if result == 0 {
        1
    } else {
        0
    }
}

// Test binding to specific port
fn test_socket_bind_port() -> i64 {
    let sock = socket_create(2, 1);
    if sock < 0 {
        return 0;
    }

    socket_set_reuseaddr(sock);

    // Bind to 127.0.0.1:39876
    let result = socket_bind(sock, 2130706433, 39876);

    socket_close(sock);

    if result == 0 {
        1
    } else {
        0
    }
}

// ============ SOCKET LISTEN ============

// Test listening on a socket
fn test_socket_listen() -> i64 {
    let sock = socket_create(2, 1);
    if sock < 0 {
        return 0;
    }

    socket_set_reuseaddr(sock);
    socket_bind(sock, 2130706433, 0);

    let result = socket_listen(sock, 5);

    socket_close(sock);

    if result == 0 {
        1
    } else {
        0
    }
}

// ============ NON-BLOCKING CONNECT ============

// Test non-blocking connect (will get EINPROGRESS which is expected)
fn test_socket_connect_nonblock() -> i64 {
    let sock = socket_create(2, 1);
    if sock < 0 {
        return 0;
    }

    socket_set_nonblocking(sock);

    // Try to connect to 127.0.0.1:1 (unlikely to be listening)
    // Result will be -115 (EINPROGRESS) for non-blocking or -111 (ECONNREFUSED)
    let result = socket_connect(sock, 2130706433, 1);

    socket_close(sock);

    // Either in progress or refused is acceptable for this test
    if result == -115 || result == -111 || result < 0 {
        1
    } else {
        0
    }
}

// ============ SOCKET ERROR ============

// Test getting socket error
fn test_socket_get_error() -> i64 {
    let sock = socket_create(2, 1);
    if sock < 0 {
        return 0;
    }

    // Fresh socket should have no error
    let err = socket_get_error(sock);

    socket_close(sock);

    if err == 0 {
        1
    } else {
        0
    }
}

// ============ UDP OPERATIONS ============

// Test UDP socket bind
fn test_udp_bind() -> i64 {
    let sock = socket_create(2, 2);  // UDP
    if sock < 0 {
        return 0;
    }

    socket_set_reuseaddr(sock);
    let result = socket_bind(sock, 2130706433, 0);

    socket_close(sock);

    if result == 0 {
        1
    } else {
        0
    }
}

// ============ SHA256 CRYPTO ============

// Test sha256 returns a hash (64 hex chars)
fn test_sha256_length() -> i64 {
    let data = "hello";
    let hash = sha256(data, 5);
    let len = string_len(hash);
    if len == 64 {
        1
    } else {
        0
    }
}

// Test sha256 of "hello" matches known value
fn test_sha256_hello() -> i64 {
    let data = "hello";
    let hash = sha256(data, 5);
    // SHA256("hello") = 2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824
    let expected = "2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824";
    if string_eq(hash, expected) == 1 {
        1
    } else {
        0
    }
}

// Test sha256 of empty string
fn test_sha256_empty() -> i64 {
    let data = "";
    let hash = sha256(data, 0);
    // SHA256("") = e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
    let expected = "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855";
    if string_eq(hash, expected) == 1 {
        1
    } else {
        0
    }
}

// Test sha256 of "test"
fn test_sha256_test() -> i64 {
    let data = "test";
    let hash = sha256(data, 4);
    // SHA256("test") = 9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08
    let expected = "9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08";
    if string_eq(hash, expected) == 1 {
        1
    } else {
        0
    }
}

// Test sha256 different inputs produce different hashes
fn test_sha256_different() -> i64 {
    let hash1 = sha256("abc", 3);
    let hash2 = sha256("abd", 3);
    if string_eq(hash1, hash2) == 0 {
        1
    } else {
        0
    }
}

// Test sha256 same input produces same hash
fn test_sha256_deterministic() -> i64 {
    let hash1 = sha256("simplex", 7);
    let hash2 = sha256("simplex", 7);
    if string_eq(hash1, hash2) == 1 {
        1
    } else {
        0
    }
}

fn main() -> i64 {
    var passed = 0;
    var total = 17;

    print("=== Networking and Crypto Tests ===\n\n");

    // Socket creation tests
    print("Testing socket_create_tcp...\n");
    if test_socket_create_tcp() == 1 {
        print("socket_create_tcp: PASS\n");
        passed = passed + 1;
    } else {
        print("socket_create_tcp: FAIL\n");
    }

    print("\nTesting socket_create_udp...\n");
    if test_socket_create_udp() == 1 {
        print("socket_create_udp: PASS\n");
        passed = passed + 1;
    } else {
        print("socket_create_udp: FAIL\n");
    }

    print("\nTesting socket_create_multiple...\n");
    if test_socket_create_multiple() == 1 {
        print("socket_create_multiple: PASS\n");
        passed = passed + 1;
    } else {
        print("socket_create_multiple: FAIL\n");
    }

    // Socket options tests
    print("\nTesting socket_set_reuseaddr...\n");
    if test_socket_set_reuseaddr() == 1 {
        print("socket_set_reuseaddr: PASS\n");
        passed = passed + 1;
    } else {
        print("socket_set_reuseaddr: FAIL\n");
    }

    print("\nTesting socket_set_nonblocking...\n");
    if test_socket_set_nonblocking() == 1 {
        print("socket_set_nonblocking: PASS\n");
        passed = passed + 1;
    } else {
        print("socket_set_nonblocking: FAIL\n");
    }

    // Socket bind tests
    print("\nTesting socket_bind...\n");
    if test_socket_bind() == 1 {
        print("socket_bind: PASS\n");
        passed = passed + 1;
    } else {
        print("socket_bind: FAIL\n");
    }

    print("\nTesting socket_bind_port...\n");
    if test_socket_bind_port() == 1 {
        print("socket_bind_port: PASS\n");
        passed = passed + 1;
    } else {
        print("socket_bind_port: FAIL\n");
    }

    // Socket listen test
    print("\nTesting socket_listen...\n");
    if test_socket_listen() == 1 {
        print("socket_listen: PASS\n");
        passed = passed + 1;
    } else {
        print("socket_listen: FAIL\n");
    }

    // Connect test
    print("\nTesting socket_connect_nonblock...\n");
    if test_socket_connect_nonblock() == 1 {
        print("socket_connect_nonblock: PASS\n");
        passed = passed + 1;
    } else {
        print("socket_connect_nonblock: FAIL\n");
    }

    // Error test
    print("\nTesting socket_get_error...\n");
    if test_socket_get_error() == 1 {
        print("socket_get_error: PASS\n");
        passed = passed + 1;
    } else {
        print("socket_get_error: FAIL\n");
    }

    // UDP test
    print("\nTesting udp_bind...\n");
    if test_udp_bind() == 1 {
        print("udp_bind: PASS\n");
        passed = passed + 1;
    } else {
        print("udp_bind: FAIL\n");
    }

    // SHA256 tests
    print("\nTesting sha256_length...\n");
    if test_sha256_length() == 1 {
        print("sha256_length: PASS\n");
        passed = passed + 1;
    } else {
        print("sha256_length: FAIL\n");
    }

    print("\nTesting sha256_hello...\n");
    if test_sha256_hello() == 1 {
        print("sha256_hello: PASS\n");
        passed = passed + 1;
    } else {
        print("sha256_hello: FAIL\n");
    }

    print("\nTesting sha256_empty...\n");
    if test_sha256_empty() == 1 {
        print("sha256_empty: PASS\n");
        passed = passed + 1;
    } else {
        print("sha256_empty: FAIL\n");
    }

    print("\nTesting sha256_test...\n");
    if test_sha256_test() == 1 {
        print("sha256_test: PASS\n");
        passed = passed + 1;
    } else {
        print("sha256_test: FAIL\n");
    }

    print("\nTesting sha256_different...\n");
    if test_sha256_different() == 1 {
        print("sha256_different: PASS\n");
        passed = passed + 1;
    } else {
        print("sha256_different: FAIL\n");
    }

    print("\nTesting sha256_deterministic...\n");
    if test_sha256_deterministic() == 1 {
        print("sha256_deterministic: PASS\n");
        passed = passed + 1;
    } else {
        print("sha256_deterministic: FAIL\n");
    }

    print("\n=== Summary ===\n");
    print("Passed: ");
    print_i64(passed);
    print(" / ");
    print_i64(total);
    print("\n");

    passed
}
