// Test string operations and system info intrinsics
// Tests: string_*, get_*, getenv

fn main() -> i64 {
    println("=== String Operations & System Info Test ===");
    println("");

    var passed: i64 = 0;
    var failed: i64 = 0;

    // === String Operations Tests ===
    println("--- String Operations ---");

    // Test 1: string_starts_with
    print("Test 1: string_starts_with... ");
    if string_starts_with("hello world", "hello") != 0 {
        if string_starts_with("hello world", "world") == 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - false positive");
            failed = failed + 1;
        }
    } else {
        println("FAIL - should match prefix");
        failed = failed + 1;
    }

    // Test 2: string_ends_with
    print("Test 2: string_ends_with... ");
    if string_ends_with("hello world", "world") != 0 {
        if string_ends_with("hello world", "hello") == 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - false positive");
            failed = failed + 1;
        }
    } else {
        println("FAIL - should match suffix");
        failed = failed + 1;
    }

    // Test 3: string_contains
    print("Test 3: string_contains... ");
    if string_contains("hello world", "lo wo") != 0 {
        if string_contains("hello world", "xyz") == 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - false positive");
            failed = failed + 1;
        }
    } else {
        println("FAIL - should find substring");
        failed = failed + 1;
    }

    // Test 4: string_contains at start
    print("Test 4: string_contains at start... ");
    if string_contains("hello world", "hello") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 5: string_contains at end
    print("Test 5: string_contains at end... ");
    if string_contains("hello world", "world") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 6: string_hash consistency
    print("Test 6: string_hash consistency... ");
    let hash1: i64 = string_hash("test string");
    let hash2: i64 = string_hash("test string");
    if hash1 == hash2 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - same string different hash");
        failed = failed + 1;
    }

    // Test 7: string_hash different for different strings
    print("Test 7: string_hash uniqueness... ");
    let hash3: i64 = string_hash("hello");
    let hash4: i64 = string_hash("world");
    if hash3 != hash4 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - different strings same hash");
        failed = failed + 1;
    }

    // Test 8: string_hash non-zero
    print("Test 8: string_hash non-zero... ");
    let hash5: i64 = string_hash("abc");
    if hash5 != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - hash is zero");
        failed = failed + 1;
    }

    // Test 9: string_trim
    print("Test 9: string_trim... ");
    let trimmed = string_trim("  hello  ");
    if string_eq(trimmed, "hello") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - got: '");
        print(trimmed);
        println("'");
        failed = failed + 1;
    }

    // Test 10: string_trim no whitespace
    print("Test 10: string_trim no change... ");
    let trimmed2 = string_trim("hello");
    if string_eq(trimmed2, "hello") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 11: string_replace
    print("Test 11: string_replace... ");
    let replaced = string_replace("hello world", "world", "universe");
    if string_eq(replaced, "hello universe") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - got: '");
        print(replaced);
        println("'");
        failed = failed + 1;
    }

    // Test 12: string_replace no match
    print("Test 12: string_replace no match... ");
    let replaced2 = string_replace("hello world", "xyz", "abc");
    if string_eq(replaced2, "hello world") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 13: string_replace multiple
    print("Test 13: string_replace multiple... ");
    let replaced3 = string_replace("a-b-c-d", "-", "_");
    // May replace first or all depending on implementation
    if string_contains(replaced3, "_") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 14: string_char_at
    print("Test 14: string_char_at... ");
    let ch: i64 = string_char_at("hello", 0);
    if ch == 104 {  // 'h' = 104
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 104, got ");
        print_i64(ch);
        println("");
        failed = failed + 1;
    }

    // Test 15: string_char_at middle
    print("Test 15: string_char_at middle... ");
    let ch2: i64 = string_char_at("hello", 2);
    if ch2 == 108 {  // 'l' = 108
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 108, got ");
        print_i64(ch2);
        println("");
        failed = failed + 1;
    }

    // Test 16: string_char_at last
    print("Test 16: string_char_at last... ");
    let ch3: i64 = string_char_at("hello", 4);
    if ch3 == 111 {  // 'o' = 111
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 111, got ");
        print_i64(ch3);
        println("");
        failed = failed + 1;
    }

    // Test 17: string_split
    print("Test 17: string_split... ");
    let parts = string_split("a,b,c", ",");
    let parts_len: i64 = vec_len(parts);
    if parts_len == 3 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 3 parts, got ");
        print_i64(parts_len);
        println("");
        failed = failed + 1;
    }

    // Test 18: string_split verify parts
    print("Test 18: string_split parts... ");
    if parts_len >= 3 {
        let p0 = vec_get(parts, 0);
        let p1 = vec_get(parts, 1);
        let p2 = vec_get(parts, 2);
        if string_eq(p0, "a") != 0 {
            if string_eq(p1, "b") != 0 {
                if string_eq(p2, "c") != 0 {
                    println("PASS");
                    passed = passed + 1;
                } else {
                    println("FAIL - wrong part 2");
                    failed = failed + 1;
                }
            } else {
                println("FAIL - wrong part 1");
                failed = failed + 1;
            }
        } else {
            println("FAIL - wrong part 0");
            failed = failed + 1;
        }
    } else {
        println("SKIP - not enough parts");
        failed = failed + 1;
    }

    // Test 19: string_split no delimiter
    print("Test 19: string_split no delim... ");
    let parts2 = string_split("hello", ",");
    let parts2_len: i64 = vec_len(parts2);
    if parts2_len == 1 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 1, got ");
        print_i64(parts2_len);
        println("");
        failed = failed + 1;
    }

    println("");
    println("--- System Info ---");

    // Test 20: get_num_cpus
    print("Test 20: get_num_cpus... ");
    let cpus: i64 = get_num_cpus();
    if cpus >= 1 {
        print("PASS (");
        print_i64(cpus);
        println(" CPUs)");
        passed = passed + 1;
    } else {
        println("FAIL - should be >= 1");
        failed = failed + 1;
    }

    // Test 21: get_cwd
    print("Test 21: get_cwd... ");
    let cwd = get_cwd();
    let cwd_len: i64 = string_len(cwd);
    if cwd_len > 0 {
        print("PASS (");
        print(cwd);
        println(")");
        passed = passed + 1;
    } else {
        println("FAIL - empty cwd");
        failed = failed + 1;
    }

    // Test 22: get_cwd starts with /
    print("Test 22: get_cwd path format... ");
    if string_starts_with(cwd, "/") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should start with /");
        failed = failed + 1;
    }

    // Test 23: get_home_dir
    print("Test 23: get_home_dir... ");
    let home = get_home_dir();
    let home_len: i64 = string_len(home);
    if home_len > 0 {
        print("PASS (");
        print(home);
        println(")");
        passed = passed + 1;
    } else {
        println("FAIL - empty home");
        failed = failed + 1;
    }

    // Test 24: get_home_dir starts with /
    print("Test 24: get_home_dir format... ");
    if string_starts_with(home, "/") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should start with /");
        failed = failed + 1;
    }

    // Test 25: getenv PATH
    print("Test 25: getenv PATH... ");
    let path_env = getenv("PATH");
    let path_len: i64 = string_len(path_env);
    if path_len > 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - PATH should exist");
        failed = failed + 1;
    }

    // Test 26: getenv PATH contains /
    print("Test 26: getenv PATH format... ");
    if string_contains(path_env, "/") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - PATH should contain /");
        failed = failed + 1;
    }

    // Test 27: getenv HOME
    print("Test 27: getenv HOME... ");
    let home_env = getenv("HOME");
    let home_env_len: i64 = string_len(home_env);
    if home_env_len > 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - HOME should exist");
        failed = failed + 1;
    }

    // Test 28: getenv nonexistent
    print("Test 28: getenv nonexistent... ");
    let noexist = getenv("SIMPLEX_NONEXISTENT_VAR_12345");
    let noexist_len: i64 = string_len(noexist);
    if noexist_len == 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should be empty");
        failed = failed + 1;
    }

    // Test 29: get_args exists
    print("Test 29: get_args... ");
    let args = get_args();
    let args_len: i64 = vec_len(args);
    if args_len >= 0 {
        print("PASS (");
        print_i64(args_len);
        println(" args)");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 30: Combined - build path
    print("Test 30: path building... ");
    let path_part1 = get_home_dir();
    let path_part2 = string_concat(path_part1, "/.simplex");
    if string_ends_with(path_part2, "/.simplex") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Summary
    println("");
    println("=== Summary ===");
    print("Passed: ");
    print_i64(passed);
    print(" / ");
    print_i64(30);
    println("");

    if failed == 0 {
        println("");
        println("=== ALL STRING/SYSINFO TESTS PASSED ===");
    } else {
        println("");
        println("=== SOME TESTS FAILED ===");
    }

    failed
}
