// Test HashMap Intrinsics

// ============ HASHMAP CREATION ============

// Test creating a new hashmap
fn test_hashmap_new() -> i64 {
    let map = hashmap_new();
    if map != 0 {
        hashmap_free(map);
        1
    } else {
        0
    }
}

// Test creating hashmap with capacity
fn test_hashmap_with_capacity() -> i64 {
    let map = hashmap_with_capacity(100);
    if map != 0 {
        hashmap_free(map);
        1
    } else {
        0
    }
}

// Test multiple hashmaps are independent
fn test_hashmap_multiple() -> i64 {
    let m1 = hashmap_new();
    let m2 = hashmap_new();

    // They should be different pointers
    let result = m1 != 0 && m2 != 0 && m1 != m2;

    hashmap_free(m1);
    hashmap_free(m2);

    if result {
        1
    } else {
        0
    }
}

// ============ HASHMAP INSERT/GET ============

// Test insert and get
fn test_hashmap_insert_get() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "key1", 100);
    let val = hashmap_get(map, "key1");

    hashmap_free(map);

    if val == 100 {
        1
    } else {
        0
    }
}

// Test multiple inserts
fn test_hashmap_insert_multiple() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "a", 1);
    hashmap_insert(map, "b", 2);
    hashmap_insert(map, "c", 3);

    let va = hashmap_get(map, "a");
    let vb = hashmap_get(map, "b");
    let vc = hashmap_get(map, "c");

    hashmap_free(map);

    if va == 1 && vb == 2 && vc == 3 {
        1
    } else {
        0
    }
}

// Test overwriting value
fn test_hashmap_overwrite() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "key", 10);
    hashmap_insert(map, "key", 20);

    let val = hashmap_get(map, "key");

    hashmap_free(map);

    if val == 20 {
        1
    } else {
        0
    }
}

// Test get non-existent key returns 0
fn test_hashmap_get_missing() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "exists", 42);
    let val = hashmap_get(map, "missing");

    hashmap_free(map);

    if val == 0 {
        1
    } else {
        0
    }
}

// ============ HASHMAP CONTAINS ============

// Test contains for existing key
fn test_hashmap_contains_exists() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "hello", 123);
    let has = hashmap_contains(map, "hello");

    hashmap_free(map);

    if has == 1 {
        1
    } else {
        0
    }
}

// Test contains for missing key
fn test_hashmap_contains_missing() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "hello", 123);
    let has = hashmap_contains(map, "world");

    hashmap_free(map);

    if has == 0 {
        1
    } else {
        0
    }
}

// ============ HASHMAP LENGTH ============

// Test empty hashmap length
fn test_hashmap_len_empty() -> i64 {
    let map = hashmap_new();
    let len = hashmap_len(map);
    hashmap_free(map);

    if len == 0 {
        1
    } else {
        0
    }
}

// Test hashmap length after inserts
fn test_hashmap_len_after_insert() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "a", 1);
    hashmap_insert(map, "b", 2);
    hashmap_insert(map, "c", 3);

    let len = hashmap_len(map);
    hashmap_free(map);

    if len == 3 {
        1
    } else {
        0
    }
}

// Test length doesn't increase on overwrite
fn test_hashmap_len_overwrite() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "key", 1);
    hashmap_insert(map, "key", 2);
    hashmap_insert(map, "key", 3);

    let len = hashmap_len(map);
    hashmap_free(map);

    if len == 1 {
        1
    } else {
        0
    }
}

// ============ HASHMAP REMOVE ============

// Test remove existing key
fn test_hashmap_remove() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "key", 42);
    let removed = hashmap_remove(map, "key");
    let after = hashmap_get(map, "key");

    hashmap_free(map);

    // removed should return the old value (42), after should be 0
    if removed == 42 && after == 0 {
        1
    } else {
        0
    }
}

// Test remove decreases length
fn test_hashmap_remove_len() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "a", 1);
    hashmap_insert(map, "b", 2);
    hashmap_insert(map, "c", 3);

    let len_before = hashmap_len(map);
    hashmap_remove(map, "b");
    let len_after = hashmap_len(map);

    hashmap_free(map);

    if len_before == 3 && len_after == 2 {
        1
    } else {
        0
    }
}

// Test remove missing key returns 0
fn test_hashmap_remove_missing() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "exists", 100);
    let removed = hashmap_remove(map, "missing");

    hashmap_free(map);

    if removed == 0 {
        1
    } else {
        0
    }
}

// ============ HASHMAP CLEAR ============

// Test clear empties the map
fn test_hashmap_clear() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "a", 1);
    hashmap_insert(map, "b", 2);
    hashmap_insert(map, "c", 3);

    hashmap_clear(map);
    let len = hashmap_len(map);

    hashmap_free(map);

    if len == 0 {
        1
    } else {
        0
    }
}

// Test clear then reuse
fn test_hashmap_clear_reuse() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "old", 100);
    hashmap_clear(map);
    hashmap_insert(map, "new", 200);

    let old_val = hashmap_get(map, "old");
    let new_val = hashmap_get(map, "new");

    hashmap_free(map);

    if old_val == 0 && new_val == 200 {
        1
    } else {
        0
    }
}

// ============ HASHMAP ITERATION ============

// Test keys iterator
fn test_hashmap_keys_iter() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "x", 10);
    hashmap_insert(map, "y", 20);
    hashmap_insert(map, "z", 30);

    let iter = hashmap_keys(map);
    var count = 0;

    // Iterate through keys
    var key = hashmap_keys_next(iter);
    while key != 0 {
        count = count + 1;
        key = hashmap_keys_next(iter);
    }

    hashmap_iter_free(iter);
    hashmap_free(map);

    if count == 3 {
        1
    } else {
        0
    }
}

// Test values iterator
fn test_hashmap_values_iter() -> i64 {
    let map = hashmap_new();

    hashmap_insert(map, "a", 10);
    hashmap_insert(map, "b", 20);
    hashmap_insert(map, "c", 30);

    let iter = hashmap_values(map);
    var sum = 0;

    // Sum all values
    var val = hashmap_values_next(iter);
    while val != 0 {
        sum = sum + val;
        val = hashmap_values_next(iter);
    }

    hashmap_iter_free(iter);
    hashmap_free(map);

    // 10 + 20 + 30 = 60
    if sum == 60 {
        1
    } else {
        0
    }
}

fn main() -> i64 {
    var passed = 0;
    var total = 19;

    print("=== HashMap Tests ===\n\n");

    // Creation tests
    print("Testing hashmap_new...\n");
    if test_hashmap_new() == 1 {
        print("hashmap_new: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_new: FAIL\n");
    }

    print("\nTesting hashmap_with_capacity...\n");
    if test_hashmap_with_capacity() == 1 {
        print("hashmap_with_capacity: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_with_capacity: FAIL\n");
    }

    print("\nTesting hashmap_multiple...\n");
    if test_hashmap_multiple() == 1 {
        print("hashmap_multiple: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_multiple: FAIL\n");
    }

    // Insert/Get tests
    print("\nTesting hashmap_insert_get...\n");
    if test_hashmap_insert_get() == 1 {
        print("hashmap_insert_get: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_insert_get: FAIL\n");
    }

    print("\nTesting hashmap_insert_multiple...\n");
    if test_hashmap_insert_multiple() == 1 {
        print("hashmap_insert_multiple: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_insert_multiple: FAIL\n");
    }

    print("\nTesting hashmap_overwrite...\n");
    if test_hashmap_overwrite() == 1 {
        print("hashmap_overwrite: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_overwrite: FAIL\n");
    }

    print("\nTesting hashmap_get_missing...\n");
    if test_hashmap_get_missing() == 1 {
        print("hashmap_get_missing: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_get_missing: FAIL\n");
    }

    // Contains tests
    print("\nTesting hashmap_contains_exists...\n");
    if test_hashmap_contains_exists() == 1 {
        print("hashmap_contains_exists: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_contains_exists: FAIL\n");
    }

    print("\nTesting hashmap_contains_missing...\n");
    if test_hashmap_contains_missing() == 1 {
        print("hashmap_contains_missing: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_contains_missing: FAIL\n");
    }

    // Length tests
    print("\nTesting hashmap_len_empty...\n");
    if test_hashmap_len_empty() == 1 {
        print("hashmap_len_empty: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_len_empty: FAIL\n");
    }

    print("\nTesting hashmap_len_after_insert...\n");
    if test_hashmap_len_after_insert() == 1 {
        print("hashmap_len_after_insert: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_len_after_insert: FAIL\n");
    }

    print("\nTesting hashmap_len_overwrite...\n");
    if test_hashmap_len_overwrite() == 1 {
        print("hashmap_len_overwrite: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_len_overwrite: FAIL\n");
    }

    // Remove tests
    print("\nTesting hashmap_remove...\n");
    if test_hashmap_remove() == 1 {
        print("hashmap_remove: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_remove: FAIL\n");
    }

    print("\nTesting hashmap_remove_len...\n");
    if test_hashmap_remove_len() == 1 {
        print("hashmap_remove_len: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_remove_len: FAIL\n");
    }

    print("\nTesting hashmap_remove_missing...\n");
    if test_hashmap_remove_missing() == 1 {
        print("hashmap_remove_missing: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_remove_missing: FAIL\n");
    }

    // Clear tests
    print("\nTesting hashmap_clear...\n");
    if test_hashmap_clear() == 1 {
        print("hashmap_clear: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_clear: FAIL\n");
    }

    print("\nTesting hashmap_clear_reuse...\n");
    if test_hashmap_clear_reuse() == 1 {
        print("hashmap_clear_reuse: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_clear_reuse: FAIL\n");
    }

    // Iteration tests
    print("\nTesting hashmap_keys_iter...\n");
    if test_hashmap_keys_iter() == 1 {
        print("hashmap_keys_iter: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_keys_iter: FAIL\n");
    }

    print("\nTesting hashmap_values_iter...\n");
    if test_hashmap_values_iter() == 1 {
        print("hashmap_values_iter: PASS\n");
        passed = passed + 1;
    } else {
        print("hashmap_values_iter: FAIL\n");
    }

    print("\n=== Summary ===\n");
    print("Passed: ");
    print_i64(passed);
    print(" / ");
    print_i64(total);
    print("\n");

    passed
}
