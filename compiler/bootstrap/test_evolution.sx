// Test Evolution Engine - trait mutations and generations

// Test adding a trait
fn test_add_trait() -> i64 {
    // add_trait(name, initial_value) -> trait_id
    let trait_id = add_trait("Speed", 50);
    if trait_id > 0 {
        1
    } else {
        0
    }
}

// Test trait value
fn test_trait_value() -> i64 {
    let trait_id = add_trait("Strength", 75);
    let value = trait_value(trait_id);
    if value == 75 {
        1
    } else {
        0
    }
}

// Test trait mutation
fn test_mutate_trait() -> i64 {
    let trait_id = add_trait("Intelligence", 50);
    let before = trait_value(trait_id);

    // Mutate with rate 10 (value changes by -10 to +10)
    mutate_trait(trait_id, 10);
    let after = trait_value(trait_id);

    // Value should have changed (within bounds 0-100)
    // Since mutation is random, just check it's still valid
    if after >= 0 && after <= 100 {
        1
    } else {
        0
    }
}

// Test multiple mutations show variation
fn test_mutation_variation() -> i64 {
    let t1 = add_trait("Trait1", 50);
    let t2 = add_trait("Trait2", 50);
    let t3 = add_trait("Trait3", 50);

    // Mutate all with high rate
    mutate_trait(t1, 20);
    mutate_trait(t2, 20);
    mutate_trait(t3, 20);

    let v1 = trait_value(t1);
    let v2 = trait_value(t2);
    let v3 = trait_value(t3);

    // At least one should have changed from 50 (very likely with rate 20)
    // Or all should be valid values
    if v1 >= 0 && v1 <= 100 && v2 >= 0 && v2 <= 100 && v3 >= 0 && v3 <= 100 {
        1
    } else {
        0
    }
}

// Test current generation
fn test_current_generation() -> i64 {
    let gen = current_generation();
    // Generation should be non-negative
    if gen >= 0 {
        1
    } else {
        0
    }
}

// Test advancing generation
fn test_next_generation() -> i64 {
    let before = current_generation();
    let new_gen = next_generation();
    let after = current_generation();

    if new_gen == before + 1 && after == new_gen {
        1
    } else {
        0
    }
}

// Test fitness evaluation (sum of all trait values)
fn test_evaluate_fitness() -> i64 {
    // Add some traits with known values
    let t1 = add_trait("Fit1", 30);
    let t2 = add_trait("Fit2", 40);
    let t3 = add_trait("Fit3", 50);

    let fitness = evaluate_fitness();
    // Fitness should include at least these traits (may include others from previous tests)
    if fitness >= 120 {
        1
    } else {
        0
    }
}

// Test evolution cycle: mutate and evaluate
fn test_evolution_cycle() -> i64 {
    // Create initial traits
    let speed = add_trait("EvoSpeed", 50);
    let power = add_trait("EvoPower", 50);

    // Get initial fitness
    let initial_fitness = evaluate_fitness();

    // Advance to next generation
    next_generation();

    // Mutate traits
    mutate_trait(speed, 15);
    mutate_trait(power, 15);

    // Evaluate new fitness
    let new_fitness = evaluate_fitness();

    // Both should be valid (fitness can go up or down)
    if initial_fitness >= 0 && new_fitness >= 0 {
        1
    } else {
        0
    }
}

fn main() -> i64 {
    var passed = 0;
    var total = 8;

    print("=== Evolution Engine Tests ===\n\n");

    print("Testing add trait...\n");
    if test_add_trait() == 1 {
        print("add_trait: PASS\n");
        passed = passed + 1;
    } else {
        print("add_trait: FAIL\n");
    }

    print("\nTesting trait value...\n");
    if test_trait_value() == 1 {
        print("trait_value: PASS\n");
        passed = passed + 1;
    } else {
        print("trait_value: FAIL\n");
    }

    print("\nTesting mutate trait...\n");
    if test_mutate_trait() == 1 {
        print("mutate_trait: PASS\n");
        passed = passed + 1;
    } else {
        print("mutate_trait: FAIL\n");
    }

    print("\nTesting mutation variation...\n");
    if test_mutation_variation() == 1 {
        print("mutation_variation: PASS\n");
        passed = passed + 1;
    } else {
        print("mutation_variation: FAIL\n");
    }

    print("\nTesting current generation...\n");
    if test_current_generation() == 1 {
        print("current_generation: PASS\n");
        passed = passed + 1;
    } else {
        print("current_generation: FAIL\n");
    }

    print("\nTesting next generation...\n");
    if test_next_generation() == 1 {
        print("next_generation: PASS\n");
        passed = passed + 1;
    } else {
        print("next_generation: FAIL\n");
    }

    print("\nTesting evaluate fitness...\n");
    if test_evaluate_fitness() == 1 {
        print("evaluate_fitness: PASS\n");
        passed = passed + 1;
    } else {
        print("evaluate_fitness: FAIL\n");
    }

    print("\nTesting evolution cycle...\n");
    if test_evolution_cycle() == 1 {
        print("evolution_cycle: PASS\n");
        passed = passed + 1;
    } else {
        print("evolution_cycle: FAIL\n");
    }

    print("\n=== Summary ===\n");
    print("Passed: ");
    print_i64(passed);
    print(" / ");
    print_i64(total);
    print("\n");

    passed
}
