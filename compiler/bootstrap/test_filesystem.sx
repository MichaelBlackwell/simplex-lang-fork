// Test File System Intrinsics

// ============ PATH OPERATIONS ============

// Test path_join
fn test_path_join() -> i64 {
    let p = path_join("/tmp", "test.txt");
    let len = string_len(p);
    // "/tmp/test.txt" = 13 chars
    if len == 13 {
        1
    } else {
        0
    }
}

// Test path_dirname
fn test_path_dirname() -> i64 {
    let dir = path_dirname("/home/user/file.txt");
    let expected = "/home/user";
    if string_eq(dir, expected) == 1 {
        1
    } else {
        0
    }
}

// Test path_basename
fn test_path_basename() -> i64 {
    let base = path_basename("/home/user/file.txt");
    let expected = "file.txt";
    if string_eq(base, expected) == 1 {
        1
    } else {
        0
    }
}

// Test path_extension (includes the dot)
fn test_path_extension() -> i64 {
    let ext = path_extension("/home/user/file.txt");
    let expected = ".txt";
    if string_eq(ext, expected) == 1 {
        1
    } else {
        0
    }
}

// Test get_cwd
fn test_get_cwd() -> i64 {
    let cwd = get_cwd();
    let len = string_len(cwd);
    // CWD should be a non-empty path
    if len > 0 {
        1
    } else {
        0
    }
}

// ============ FILE EXISTENCE CHECKS ============

// Test file_exists on existing file (this test file)
fn test_file_exists() -> i64 {
    let exists = file_exists("test_filesystem.sx");
    if exists == 1 {
        1
    } else {
        0
    }
}

// Test file_exists on non-existing file
fn test_file_not_exists() -> i64 {
    let exists = file_exists("nonexistent_file_12345.xyz");
    if exists == 0 {
        1
    } else {
        0
    }
}

// Test is_file
fn test_is_file() -> i64 {
    let result = is_file("test_filesystem.sx");
    if result == 1 {
        1
    } else {
        0
    }
}

// Test is_directory on current dir
fn test_is_directory() -> i64 {
    let result = is_directory(".");
    if result == 1 {
        1
    } else {
        0
    }
}

// Test is_directory returns 0 for files
fn test_is_not_directory() -> i64 {
    let result = is_directory("test_filesystem.sx");
    if result == 0 {
        1
    } else {
        0
    }
}

// ============ FILE READ/WRITE ============

// Test write and read file
fn test_write_read_file() -> i64 {
    let test_path = "/tmp/simplex_test_file.txt";
    let content = "Hello from Simplex!";

    // Write file
    write_file(test_path, content);

    // Read it back
    let read_content = read_file(test_path);

    // Clean up
    remove_path(test_path);

    // Check content matches
    if string_eq(read_content, content) == 1 {
        1
    } else {
        0
    }
}

// Test file_size
fn test_file_size() -> i64 {
    let test_path = "/tmp/simplex_size_test.txt";
    let content = "12345678901234567890";  // 20 chars

    write_file(test_path, content);
    let size = file_size(test_path);
    remove_path(test_path);

    if size == 20 {
        1
    } else {
        0
    }
}

// ============ DIRECTORY OPERATIONS ============

// Test mkdir_p
fn test_mkdir_p() -> i64 {
    let test_dir = "/tmp/simplex_test_dir";

    // Create directory
    let result = mkdir_p(test_dir);

    // Check it exists
    let exists = is_directory(test_dir);

    // Clean up
    remove_path(test_dir);

    if result == 0 && exists == 1 {
        1
    } else {
        0
    }
}

// Test mkdir_p with nested path
fn test_mkdir_nested() -> i64 {
    let test_dir = "/tmp/simplex_test_nested/subdir/deep";

    // Create nested directory
    mkdir_p(test_dir);

    // Check it exists
    let exists = is_directory(test_dir);

    // Clean up (remove from deepest)
    remove_path(test_dir);
    remove_path("/tmp/simplex_test_nested/subdir");
    remove_path("/tmp/simplex_test_nested");

    if exists == 1 {
        1
    } else {
        0
    }
}

// Test remove_path on file
fn test_remove_file() -> i64 {
    let test_path = "/tmp/simplex_remove_test.txt";

    // Create file
    write_file(test_path, "to be deleted");

    // Verify it exists
    let before = file_exists(test_path);

    // Remove it
    remove_path(test_path);

    // Verify it's gone
    let after = file_exists(test_path);

    if before == 1 && after == 0 {
        1
    } else {
        0
    }
}

// Test list_dir
fn test_list_dir() -> i64 {
    let test_dir = "/tmp/simplex_list_test";
    mkdir_p(test_dir);

    // Create some files
    write_file(path_join(test_dir, "file1.txt"), "a");
    write_file(path_join(test_dir, "file2.txt"), "b");
    write_file(path_join(test_dir, "file3.txt"), "c");

    // List directory
    let entries = list_dir(test_dir);
    let count = vec_len(entries);

    // Clean up
    remove_path(path_join(test_dir, "file1.txt"));
    remove_path(path_join(test_dir, "file2.txt"));
    remove_path(path_join(test_dir, "file3.txt"));
    remove_path(test_dir);

    // Should have 3 entries
    if count == 3 {
        1
    } else {
        0
    }
}

fn main() -> i64 {
    var passed = 0;
    var total = 16;

    print("=== File System Tests ===\n\n");

    // Path operations
    print("Testing path_join...\n");
    if test_path_join() == 1 {
        print("path_join: PASS\n");
        passed = passed + 1;
    } else {
        print("path_join: FAIL\n");
    }

    print("\nTesting path_dirname...\n");
    if test_path_dirname() == 1 {
        print("path_dirname: PASS\n");
        passed = passed + 1;
    } else {
        print("path_dirname: FAIL\n");
    }

    print("\nTesting path_basename...\n");
    if test_path_basename() == 1 {
        print("path_basename: PASS\n");
        passed = passed + 1;
    } else {
        print("path_basename: FAIL\n");
    }

    print("\nTesting path_extension...\n");
    if test_path_extension() == 1 {
        print("path_extension: PASS\n");
        passed = passed + 1;
    } else {
        print("path_extension: FAIL\n");
    }

    print("\nTesting get_cwd...\n");
    if test_get_cwd() == 1 {
        print("get_cwd: PASS\n");
        passed = passed + 1;
    } else {
        print("get_cwd: FAIL\n");
    }

    // File existence
    print("\nTesting file_exists...\n");
    if test_file_exists() == 1 {
        print("file_exists: PASS\n");
        passed = passed + 1;
    } else {
        print("file_exists: FAIL\n");
    }

    print("\nTesting file_not_exists...\n");
    if test_file_not_exists() == 1 {
        print("file_not_exists: PASS\n");
        passed = passed + 1;
    } else {
        print("file_not_exists: FAIL\n");
    }

    print("\nTesting is_file...\n");
    if test_is_file() == 1 {
        print("is_file: PASS\n");
        passed = passed + 1;
    } else {
        print("is_file: FAIL\n");
    }

    print("\nTesting is_directory...\n");
    if test_is_directory() == 1 {
        print("is_directory: PASS\n");
        passed = passed + 1;
    } else {
        print("is_directory: FAIL\n");
    }

    print("\nTesting is_not_directory...\n");
    if test_is_not_directory() == 1 {
        print("is_not_directory: PASS\n");
        passed = passed + 1;
    } else {
        print("is_not_directory: FAIL\n");
    }

    // File read/write
    print("\nTesting write_read_file...\n");
    if test_write_read_file() == 1 {
        print("write_read_file: PASS\n");
        passed = passed + 1;
    } else {
        print("write_read_file: FAIL\n");
    }

    print("\nTesting file_size...\n");
    if test_file_size() == 1 {
        print("file_size: PASS\n");
        passed = passed + 1;
    } else {
        print("file_size: FAIL\n");
    }

    // Directory operations
    print("\nTesting mkdir_p...\n");
    if test_mkdir_p() == 1 {
        print("mkdir_p: PASS\n");
        passed = passed + 1;
    } else {
        print("mkdir_p: FAIL\n");
    }

    print("\nTesting mkdir_nested...\n");
    if test_mkdir_nested() == 1 {
        print("mkdir_nested: PASS\n");
        passed = passed + 1;
    } else {
        print("mkdir_nested: FAIL\n");
    }

    print("\nTesting remove_file...\n");
    if test_remove_file() == 1 {
        print("remove_file: PASS\n");
        passed = passed + 1;
    } else {
        print("remove_file: FAIL\n");
    }

    print("\nTesting list_dir...\n");
    if test_list_dir() == 1 {
        print("list_dir: PASS\n");
        passed = passed + 1;
    } else {
        print("list_dir: FAIL\n");
    }

    print("\n=== Summary ===\n");
    print("Passed: ");
    print_i64(passed);
    print(" / ");
    print_i64(total);
    print("\n");

    passed
}
