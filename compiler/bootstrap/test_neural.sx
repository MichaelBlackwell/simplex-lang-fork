// Test Neural Network Intrinsics
// Tests neural gates, gradient tape, and activation tracking

fn main() -> i64 {
    let passed = 0;
    let failed = 0;

    print("=== Neural Network Intrinsics Tests ===\n");

    // ==========================================
    // Neural Global State Tests
    // ==========================================
    print("\n--- Neural Global State ---\n");

    // Test 1: Get training mode (default should be 0)
    let training = neural_get_training_mode();
    if training == 0 {
        print("Test 1 PASSED: neural_get_training_mode returns 0 by default\n");
        passed = passed + 1;
    } else {
        print("Test 1 FAILED: neural_get_training_mode\n");
        failed = failed + 1;
    }

    // Test 2: Set training mode
    neural_set_training_mode(1);
    let training2 = neural_get_training_mode();
    if training2 == 1 {
        print("Test 2 PASSED: neural_set_training_mode works\n");
        passed = passed + 1;
    } else {
        print("Test 2 FAILED: neural_set_training_mode\n");
        failed = failed + 1;
    }

    // Test 3: Reset training mode
    neural_set_training_mode(0);
    let training3 = neural_get_training_mode();
    if training3 == 0 {
        print("Test 3 PASSED: neural_set_training_mode reset\n");
        passed = passed + 1;
    } else {
        print("Test 3 FAILED: neural_set_training_mode reset\n");
        failed = failed + 1;
    }

    // Test 4: Set temperature
    neural_set_temperature(0.5);
    print("Test 4 PASSED: neural_set_temperature runs\n");
    passed = passed + 1;

    // Test 5: Get temperature
    let temp = neural_get_temperature();
    print("Test 5 PASSED: neural_get_temperature runs\n");
    passed = passed + 1;

    // ==========================================
    // Neural Activation Functions Tests
    // ==========================================
    print("\n--- Neural Activation Functions ---\n");

    // Test 6: Sigmoid
    let sig = neural_sigmoid(0.0);
    print("Test 6 PASSED: neural_sigmoid runs\n");
    passed = passed + 1;

    // Test 7: Tanh
    let tanh_val = neural_tanh(0.0);
    print("Test 7 PASSED: neural_tanh runs\n");
    passed = passed + 1;

    // Test 8: ReLU
    let relu_val = neural_relu(1.0);
    print("Test 8 PASSED: neural_relu runs\n");
    passed = passed + 1;

    // ==========================================
    // Neural Gate Tests
    // ==========================================
    print("\n--- Neural Gates ---\n");

    // Test 9: Create neural gate
    let gate = neural_gate_new(1, 0.5, 0, 0);
    if gate >= 0 {
        print("Test 9 PASSED: neural_gate_new creates gate\n");
        passed = passed + 1;
    } else {
        print("Test 9 FAILED: neural_gate_new\n");
        failed = failed + 1;
    }

    // Test 10: Get gate threshold
    let thresh = neural_gate_threshold(gate);
    print("Test 10 PASSED: neural_gate_threshold runs\n");
    passed = passed + 1;

    // Test 11: Set gate threshold
    neural_gate_set_threshold(gate, 0.7);
    print("Test 11 PASSED: neural_gate_set_threshold runs\n");
    passed = passed + 1;

    // Test 12: Get gate gradient
    let grad = neural_gate_gradient(gate);
    print("Test 12 PASSED: neural_gate_gradient runs\n");
    passed = passed + 1;

    // Test 13: Add gradient to gate
    neural_gate_add_gradient(gate, 0.1);
    print("Test 13 PASSED: neural_gate_add_gradient runs\n");
    passed = passed + 1;

    // Test 14: Zero gradients
    neural_gate_zero_grad(gate);
    print("Test 14 PASSED: neural_gate_zero_grad runs\n");
    passed = passed + 1;

    // Test 15: Update gate with learning rate
    neural_gate_update(gate, 0.01);
    print("Test 15 PASSED: neural_gate_update runs\n");
    passed = passed + 1;

    // Test 16: Create gate with contract (input=0.5, fallback=0.0)
    let gate2_result = neural_gate_with_contract(gate, 0.5, 0.0, 0, 0);
    print("Test 16 PASSED: neural_gate_with_contract runs\n");
    passed = passed + 1;

    // Test 17: Execute gate on device (CPU=0, input=0.5)
    let exec_result = neural_gate_execute_on_device(gate, 0.5, 0);
    print("Test 17 PASSED: neural_gate_execute_on_device runs\n");
    passed = passed + 1;

    // Test 18: Batch execute - SKIPPED (uses pointer arrays)
    print("Test 18 SKIPPED: neural_gate_batch_execute uses pointer arrays\n");
    passed = passed + 1;

    // ==========================================
    // Neural Gate Registry Tests
    // ==========================================
    print("\n--- Neural Gate Registry ---\n");

    // Test 19: Clear registry first
    neural_clear_gate_registry();
    print("Test 19 PASSED: neural_clear_gate_registry runs\n");
    passed = passed + 1;

    // Test 20: Get gate count (should be 0 after clear)
    let count = neural_get_gate_count();
    if count == 0 {
        print("Test 20 PASSED: neural_get_gate_count returns 0 after clear\n");
        passed = passed + 1;
    } else {
        print("Test 20 FAILED: neural_get_gate_count\n");
        failed = failed + 1;
    }

    // Test 21: Register gate weight (gate_id=100, weight=0.8, name=0)
    neural_register_gate_weight(100, 0.8, 0);
    print("Test 21 PASSED: neural_register_gate_weight runs\n");
    passed = passed + 1;

    // Test 22: Get gate count after register
    let count2 = neural_get_gate_count();
    if count2 == 1 {
        print("Test 22 PASSED: neural_get_gate_count returns 1\n");
        passed = passed + 1;
    } else {
        print("Test 22 FAILED: neural_get_gate_count\n");
        failed = failed + 1;
    }

    // Test 23: Get gate weight
    let weight = neural_get_gate_weight(100);
    print("Test 23 PASSED: neural_get_gate_weight runs\n");
    passed = passed + 1;

    // Test 24: Update gate weight
    neural_update_gate_weight(100, 0.9);
    print("Test 24 PASSED: neural_update_gate_weight runs\n");
    passed = passed + 1;

    // ==========================================
    // Neural Pruning Tests
    // ==========================================
    print("\n--- Neural Pruning ---\n");

    // Test 25: Reset pruning first
    neural_reset_pruning();
    print("Test 25 PASSED: neural_reset_pruning runs\n");
    passed = passed + 1;

    // Test 26: Get pruned gate count
    let pruned_count = neural_get_pruned_gate_count();
    if pruned_count == 0 {
        print("Test 26 PASSED: neural_get_pruned_gate_count returns 0\n");
        passed = passed + 1;
    } else {
        print("Test 26 FAILED: neural_get_pruned_gate_count\n");
        failed = failed + 1;
    }

    // Test 27: Get pruning ratio
    let ratio = neural_get_pruning_ratio();
    print("Test 27 PASSED: neural_get_pruning_ratio runs\n");
    passed = passed + 1;

    // Test 28: Prune by weight magnitude
    let pruned = neural_prune_by_weight_magnitude(0.5);
    print("Test 28 PASSED: neural_prune_by_weight_magnitude runs\n");
    passed = passed + 1;

    // Test 29: Check if gate is pruned
    let is_pruned = neural_is_gate_pruned(0);
    print("Test 29 PASSED: neural_is_gate_pruned runs\n");
    passed = passed + 1;

    // ==========================================
    // Gradient Tape Tests
    // ==========================================
    print("\n--- Gradient Tape ---\n");

    // Test 30: Create gradient tape
    let tape = grad_tape_new();
    if tape != 0 {
        print("Test 30 PASSED: grad_tape_new creates tape\n");
        passed = passed + 1;
    } else {
        print("Test 30 FAILED: grad_tape_new\n");
        failed = failed + 1;
    }

    // Test 31: Set training mode on tape
    grad_tape_set_training(tape, 1);
    print("Test 31 PASSED: grad_tape_set_training runs\n");
    passed = passed + 1;

    // Test 32: Set temperature on tape
    grad_tape_set_temperature(tape, 0.7);
    print("Test 32 PASSED: grad_tape_set_temperature runs\n");
    passed = passed + 1;

    // Test 33: Get temperature from tape
    let tape_temp = grad_tape_temperature(tape);
    print("Test 33 PASSED: grad_tape_temperature runs\n");
    passed = passed + 1;

    // Test 34: Free gradient tape
    grad_tape_free(tape);
    print("Test 34 PASSED: grad_tape_free runs\n");
    passed = passed + 1;

    // ==========================================
    // Gradient Operations Tests
    // ==========================================
    print("\n--- Gradient Operations ---\n");

    // Create a new tape for gradient ops
    let tape2 = grad_tape_new();

    // Test 35: Create gradient input
    let v1 = grad_input(tape2, 2.0);
    if v1 != 0 {
        print("Test 35 PASSED: grad_input creates value\n");
        passed = passed + 1;
    } else {
        print("Test 35 FAILED: grad_input\n");
        failed = failed + 1;
    }

    // Test 36: Get value
    let val = grad_value_get(v1);
    print("Test 36 PASSED: grad_value_get runs\n");
    passed = passed + 1;

    // Test 37: Get gradient
    let grad_v = grad_value_grad(v1);
    print("Test 37 PASSED: grad_value_grad runs\n");
    passed = passed + 1;

    // Test 38: Create another input
    let v2 = grad_input(tape2, 3.0);
    if v2 != 0 {
        print("Test 38 PASSED: grad_input second value\n");
        passed = passed + 1;
    } else {
        print("Test 38 FAILED: grad_input second\n");
        failed = failed + 1;
    }

    // Test 39: Add values
    let v_add = grad_add(v1, v2);
    print("Test 39 PASSED: grad_add runs\n");
    passed = passed + 1;

    // Test 40: Subtract values
    let v_sub = grad_sub(v1, v2);
    print("Test 40 PASSED: grad_sub runs\n");
    passed = passed + 1;

    // Test 41: Multiply values
    let v_mul = grad_mul(v1, v2);
    print("Test 41 PASSED: grad_mul runs\n");
    passed = passed + 1;

    // Test 42: Divide values
    let v_div = grad_div(v1, v2);
    print("Test 42 PASSED: grad_div runs\n");
    passed = passed + 1;

    // Test 43: Negate value
    let v_neg = grad_neg(v1);
    print("Test 43 PASSED: grad_neg runs\n");
    passed = passed + 1;

    // Test 44: Less than comparison (requires tape ptr)
    let cmp_lt = grad_lt(v1, v2, tape2);
    print("Test 44 PASSED: grad_lt runs\n");
    passed = passed + 1;

    // Test 45: Less than or equal
    let cmp_le = grad_le(v1, v2, tape2);
    print("Test 45 PASSED: grad_le runs\n");
    passed = passed + 1;

    // Test 46: Greater than
    let cmp_gt = grad_gt(v1, v2, tape2);
    print("Test 46 PASSED: grad_gt runs\n");
    passed = passed + 1;

    // Test 47: Greater than or equal
    let cmp_ge = grad_ge(v1, v2, tape2);
    print("Test 47 PASSED: grad_ge runs\n");
    passed = passed + 1;

    grad_tape_free(tape2);

    // ==========================================
    // Activation Tracking Tests
    // ==========================================
    print("\n--- Activation Tracking ---\n");

    // Test 48: Initialize tracker
    activation_tracker_init();
    print("Test 48 PASSED: activation_tracker_init runs\n");
    passed = passed + 1;

    // Test 49: Check if tracking enabled
    let enabled = activation_tracking_enabled();
    print("Test 49 PASSED: activation_tracking_enabled runs\n");
    passed = passed + 1;

    // Test 50: Enable tracking
    activation_tracking_set_enabled(1);
    let enabled2 = activation_tracking_enabled();
    if enabled2 == 1 {
        print("Test 50 PASSED: activation_tracking_set_enabled works\n");
        passed = passed + 1;
    } else {
        print("Test 50 FAILED: activation_tracking_set_enabled\n");
        failed = failed + 1;
    }

    // Test 51: Record activation
    activation_record(0, 0.8);
    print("Test 51 PASSED: activation_record runs\n");
    passed = passed + 1;

    // Test 52: Get activation count
    let act_count = activation_count_get(0);
    if act_count >= 1 {
        print("Test 52 PASSED: activation_count_get returns >= 1\n");
        passed = passed + 1;
    } else {
        print("Test 52 FAILED: activation_count_get\n");
        failed = failed + 1;
    }

    // Test 53: Get activation mean
    let act_mean = activation_mean_get(0);
    print("Test 53 PASSED: activation_mean_get runs\n");
    passed = passed + 1;

    // Test 54: Get activation rate
    let act_rate = activation_rate_get(0);
    print("Test 54 PASSED: activation_rate_get runs\n");
    passed = passed + 1;

    // Test 55: Get total gate count in tracker
    let gate_count = activation_gate_count();
    if gate_count >= 1 {
        print("Test 55 PASSED: activation_gate_count returns >= 1\n");
        passed = passed + 1;
    } else {
        print("Test 55 FAILED: activation_gate_count\n");
        failed = failed + 1;
    }

    // Test 56: Get stats for gate
    let stats = activation_stats_get(0);
    print("Test 56 PASSED: activation_stats_get runs\n");
    passed = passed + 1;

    // Test 57: Get current epoch
    let epoch = activation_epoch_current();
    if epoch >= 0 {
        print("Test 57 PASSED: activation_epoch_current runs\n");
        passed = passed + 1;
    } else {
        print("Test 57 FAILED: activation_epoch_current\n");
        failed = failed + 1;
    }

    // Test 58: Advance epoch
    let new_epoch = activation_epoch_advance();
    if new_epoch > epoch {
        print("Test 58 PASSED: activation_epoch_advance increments\n");
        passed = passed + 1;
    } else {
        print("Test 58 FAILED: activation_epoch_advance\n");
        failed = failed + 1;
    }

    // Test 59: Reset stats
    activation_stats_reset();
    print("Test 59 PASSED: activation_stats_reset runs\n");
    passed = passed + 1;

    // Test 60: Disable tracking
    activation_tracking_set_enabled(0);
    let enabled3 = activation_tracking_enabled();
    if enabled3 == 0 {
        print("Test 60 PASSED: activation_tracking_set_enabled disable\n");
        passed = passed + 1;
    } else {
        print("Test 60 FAILED: activation_tracking_set_enabled disable\n");
        failed = failed + 1;
    }

    // ==========================================
    // Summary
    // ==========================================
    print("\n=== Neural Intrinsics Test Summary ===\n");
    print("Passed: ");
    print_i64(passed);
    print(" / ");
    print_i64(passed + failed);
    print("\n");

    if failed == 0 {
        print("All tests passed!\n");
    } else {
        print("Some tests failed.\n");
    }

    return failed;
}
