// Test infer expression within specialists

specialist TextProcessor {
    model: "mistral-7b",
    temperature: 70,

    var call_count: i64 = 0;

    receive Process(text: i64) -> i64 {
        self.call_count = self.call_count + 1;
        // Call infer with a prompt - returns processed text
        let result = infer("Process this text");
        result
    }

    receive Summarize(doc: i64) -> i64 {
        self.call_count = self.call_count + 1;
        let summary = infer("Summarize the document");
        summary
    }

    receive GetCallCount() -> i64 {
        self.call_count
    }
}

// Test basic infer call
fn test_infer_basic() -> i64 {
    let processor = spawn TextProcessor {};
    let result = ask(processor, Process(100));
    // infer returns a string pointer, just check it's non-zero
    if result != 0 {
        1
    } else {
        0
    }
}

// Test multiple infer calls
fn test_infer_multiple() -> i64 {
    let processor = spawn TextProcessor {};
    let r1 = ask(processor, Process(100));
    let r2 = ask(processor, Summarize(200));
    let count = ask(processor, GetCallCount());

    if count == 2 {
        1
    } else {
        0
    }
}

// Test infer outside specialist (uses default model)
fn test_infer_standalone() -> i64 {
    let result = infer("Hello world");
    if result != 0 {
        1
    } else {
        0
    }
}

fn main() -> i64 {
    var passed = 0;
    var total = 3;

    print("=== Infer Expression Tests ===\n\n");

    print("Testing infer basic...\n");
    if test_infer_basic() == 1 {
        print("infer_basic: PASS\n");
        passed = passed + 1;
    } else {
        print("infer_basic: FAIL\n");
    }

    print("\nTesting infer multiple...\n");
    let multi_result = test_infer_multiple();
    if multi_result == 1 {
        print("infer_multiple: PASS\n");
        passed = passed + 1;
    } else {
        print("infer_multiple: FAIL\n");
    }

    print("\nTesting infer standalone...\n");
    if test_infer_standalone() == 1 {
        print("infer_standalone: PASS\n");
        passed = passed + 1;
    } else {
        print("infer_standalone: FAIL\n");
    }

    print("\n=== Summary ===\n");
    print("Passed: ");
    print_i64(passed);
    print(" / ");
    print_i64(total);
    print("\n");

    passed
}
