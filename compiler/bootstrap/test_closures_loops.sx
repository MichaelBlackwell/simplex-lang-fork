// Test Closures and Loops

// ============ WHILE LOOPS ============

// Test basic while loop
fn test_while_basic() -> i64 {
    var count = 0;
    var i = 0;
    while i < 5 {
        count = count + 1;
        i = i + 1;
    }
    if count == 5 {
        1
    } else {
        0
    }
}

// Test while loop with complex condition
fn test_while_condition() -> i64 {
    var x = 10;
    var iterations = 0;
    while x > 0 && iterations < 100 {
        x = x - 2;
        iterations = iterations + 1;
    }
    if x == 0 && iterations == 5 {
        1
    } else {
        0
    }
}

// Test nested while loops
fn test_while_nested() -> i64 {
    var sum = 0;
    var i = 0;
    while i < 3 {
        var j = 0;
        while j < 3 {
            sum = sum + 1;
            j = j + 1;
        }
        i = i + 1;
    }
    // 3 * 3 = 9
    if sum == 9 {
        1
    } else {
        0
    }
}

// ============ FOR LOOPS ============

// Test basic for loop
fn test_for_basic() -> i64 {
    var sum = 0;
    for i in 0..5 {
        sum = sum + i;
    }
    // 0 + 1 + 2 + 3 + 4 = 10
    if sum == 10 {
        1
    } else {
        0
    }
}

// Test for loop with different range
fn test_for_range() -> i64 {
    var sum = 0;
    for i in 5..10 {
        sum = sum + i;
    }
    // 5 + 6 + 7 + 8 + 9 = 35
    if sum == 35 {
        1
    } else {
        0
    }
}

// Test nested for loops
fn test_for_nested() -> i64 {
    var total = 0;
    for i in 0..4 {
        for j in 0..3 {
            total = total + 1;
        }
    }
    // 4 * 3 = 12
    if total == 12 {
        1
    } else {
        0
    }
}

// Test for loop using loop variable
fn test_for_variable() -> i64 {
    var product = 1;
    for i in 1..6 {
        product = product * i;
    }
    // 1 * 2 * 3 * 4 * 5 = 120
    if product == 120 {
        1
    } else {
        0
    }
}

// ============ LOOP EXPRESSION ============

// Test infinite loop with break
fn test_loop_break() -> i64 {
    var count = 0;
    loop {
        count = count + 1;
        if count >= 10 {
            break;
        }
    }
    if count == 10 {
        1
    } else {
        0
    }
}

// Test loop with break value
fn test_loop_break_value() -> i64 {
    var i = 0;
    let result = loop {
        i = i + 1;
        if i == 7 {
            break i * 2;
        }
    };
    // Should be 14
    if result == 14 {
        1
    } else {
        0
    }
}

// ============ BREAK AND CONTINUE ============

// Test continue in while loop
fn test_continue_while() -> i64 {
    var sum = 0;
    var i = 0;
    while i < 10 {
        i = i + 1;
        if i % 2 == 0 {
            continue;
        }
        sum = sum + i;
    }
    // 1 + 3 + 5 + 7 + 9 = 25
    if sum == 25 {
        1
    } else {
        0
    }
}

// Test break in while loop
fn test_break_while() -> i64 {
    var sum = 0;
    var i = 0;
    while i < 100 {
        i = i + 1;
        sum = sum + i;
        if i >= 5 {
            break;
        }
    }
    // 1 + 2 + 3 + 4 + 5 = 15
    if sum == 15 {
        1
    } else {
        0
    }
}

// ============ CLOSURES ============

// Test simple closure (no capture)
fn test_closure_simple() -> i64 {
    let add_one = |x: i64| x + 1;
    let result = add_one(5);
    if result == 6 {
        1
    } else {
        0
    }
}

// Test closure with capture
fn test_closure_capture() -> i64 {
    let multiplier = 10;
    let multiply = |x: i64| x * multiplier;
    let result = multiply(5);
    if result == 50 {
        1
    } else {
        0
    }
}

// Test closure capturing multiple variables
fn test_closure_multi_capture() -> i64 {
    let a = 2;
    let b = 3;
    let c = 4;
    let compute = |x: i64| x * a + b - c;
    // 5 * 2 + 3 - 4 = 9
    let result = compute(5);
    if result == 9 {
        1
    } else {
        0
    }
}

// Test multiple closures
fn test_multiple_closures() -> i64 {
    let double = |x: i64| x * 2;
    let triple = |x: i64| x * 3;
    let r1 = double(5);
    let r2 = triple(5);
    if r1 == 10 && r2 == 15 {
        1
    } else {
        0
    }
}

// Test closure with two parameters
fn test_closure_two_params() -> i64 {
    let add = |a: i64, b: i64| a + b;
    let result = add(10, 20);
    if result == 30 {
        1
    } else {
        0
    }
}

// Test closure composition
fn test_closure_composition() -> i64 {
    let add_five = |x: i64| x + 5;
    let double = |x: i64| x * 2;
    // (3 + 5) * 2 = 16
    let result = double(add_five(3));
    if result == 16 {
        1
    } else {
        0
    }
}

fn main() -> i64 {
    var passed = 0;
    var total = 17;

    print("=== Closures and Loops Tests ===\n\n");

    // While loops
    print("Testing while basic...\n");
    if test_while_basic() == 1 {
        print("while_basic: PASS\n");
        passed = passed + 1;
    } else {
        print("while_basic: FAIL\n");
    }

    print("\nTesting while condition...\n");
    if test_while_condition() == 1 {
        print("while_condition: PASS\n");
        passed = passed + 1;
    } else {
        print("while_condition: FAIL\n");
    }

    print("\nTesting while nested...\n");
    if test_while_nested() == 1 {
        print("while_nested: PASS\n");
        passed = passed + 1;
    } else {
        print("while_nested: FAIL\n");
    }

    // For loops
    print("\nTesting for basic...\n");
    if test_for_basic() == 1 {
        print("for_basic: PASS\n");
        passed = passed + 1;
    } else {
        print("for_basic: FAIL\n");
    }

    print("\nTesting for range...\n");
    if test_for_range() == 1 {
        print("for_range: PASS\n");
        passed = passed + 1;
    } else {
        print("for_range: FAIL\n");
    }

    print("\nTesting for nested...\n");
    if test_for_nested() == 1 {
        print("for_nested: PASS\n");
        passed = passed + 1;
    } else {
        print("for_nested: FAIL\n");
    }

    print("\nTesting for variable...\n");
    if test_for_variable() == 1 {
        print("for_variable: PASS\n");
        passed = passed + 1;
    } else {
        print("for_variable: FAIL\n");
    }

    // Loop expression
    print("\nTesting loop break...\n");
    if test_loop_break() == 1 {
        print("loop_break: PASS\n");
        passed = passed + 1;
    } else {
        print("loop_break: FAIL\n");
    }

    print("\nTesting loop break value...\n");
    if test_loop_break_value() == 1 {
        print("loop_break_value: PASS\n");
        passed = passed + 1;
    } else {
        print("loop_break_value: FAIL\n");
    }

    // Break and continue
    print("\nTesting continue while...\n");
    if test_continue_while() == 1 {
        print("continue_while: PASS\n");
        passed = passed + 1;
    } else {
        print("continue_while: FAIL\n");
    }

    print("\nTesting break while...\n");
    if test_break_while() == 1 {
        print("break_while: PASS\n");
        passed = passed + 1;
    } else {
        print("break_while: FAIL\n");
    }

    // Closures
    print("\nTesting closure simple...\n");
    if test_closure_simple() == 1 {
        print("closure_simple: PASS\n");
        passed = passed + 1;
    } else {
        print("closure_simple: FAIL\n");
    }

    print("\nTesting closure capture...\n");
    if test_closure_capture() == 1 {
        print("closure_capture: PASS\n");
        passed = passed + 1;
    } else {
        print("closure_capture: FAIL\n");
    }

    print("\nTesting closure multi capture...\n");
    if test_closure_multi_capture() == 1 {
        print("closure_multi_capture: PASS\n");
        passed = passed + 1;
    } else {
        print("closure_multi_capture: FAIL\n");
    }

    print("\nTesting multiple closures...\n");
    if test_multiple_closures() == 1 {
        print("multiple_closures: PASS\n");
        passed = passed + 1;
    } else {
        print("multiple_closures: FAIL\n");
    }

    print("\nTesting closure two params...\n");
    if test_closure_two_params() == 1 {
        print("closure_two_params: PASS\n");
        passed = passed + 1;
    } else {
        print("closure_two_params: FAIL\n");
    }

    print("\nTesting closure composition...\n");
    if test_closure_composition() == 1 {
        print("closure_composition: PASS\n");
        passed = passed + 1;
    } else {
        print("closure_composition: FAIL\n");
    }

    print("\n=== Summary ===\n");
    print("Passed: ");
    print_i64(passed);
    print(" / ");
    print_i64(total);
    print("\n");

    passed
}
