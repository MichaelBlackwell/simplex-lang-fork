// Test JSON intrinsics
// Tests: json_* functions for creating, parsing, and manipulating JSON

fn main() -> i64 {
    println("=== JSON Intrinsics Test ===");
    println("");

    var passed: i64 = 0;
    var failed: i64 = 0;

    // === JSON Value Creation ===
    println("--- JSON Value Creation ---");

    // Test 1: json_null
    print("Test 1: json_null... ");
    let null_val = json_null();
    if null_val != 0 {
        if json_is_null(null_val) != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - not null type");
            failed = failed + 1;
        }
    } else {
        println("FAIL - returned 0");
        failed = failed + 1;
    }

    // Test 2: json_bool true
    print("Test 2: json_bool true... ");
    let bool_true = json_bool(1);
    if json_is_bool(bool_true) != 0 {
        if json_as_bool(bool_true) != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - wrong value");
            failed = failed + 1;
        }
    } else {
        println("FAIL - not bool type");
        failed = failed + 1;
    }

    // Test 3: json_bool false
    print("Test 3: json_bool false... ");
    let bool_false = json_bool(0);
    if json_is_bool(bool_false) != 0 {
        if json_as_bool(bool_false) == 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - wrong value");
            failed = failed + 1;
        }
    } else {
        println("FAIL - not bool type");
        failed = failed + 1;
    }

    // Test 4: json_number
    print("Test 4: json_number... ");
    let num_val = json_number(42);
    if json_is_number(num_val) != 0 {
        if json_as_i64(num_val) == 42 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - wrong value");
            failed = failed + 1;
        }
    } else {
        println("FAIL - not number type");
        failed = failed + 1;
    }

    // Test 5: json_string
    print("Test 5: json_string... ");
    let str_val = json_string("hello");
    if json_is_string(str_val) != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - not string type");
        failed = failed + 1;
    }

    // Test 6: json_array
    print("Test 6: json_array... ");
    let arr = json_array();
    if arr != 0 {
        if json_is_array(arr) != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - not array type");
            failed = failed + 1;
        }
    } else {
        println("FAIL - returned 0");
        failed = failed + 1;
    }

    // Test 7: json_object
    print("Test 7: json_object... ");
    let obj = json_object();
    if obj != 0 {
        if json_is_object(obj) != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - not object type");
            failed = failed + 1;
        }
    } else {
        println("FAIL - returned 0");
        failed = failed + 1;
    }

    println("");
    println("--- JSON Array Operations ---");

    // Test 8: json_array_push and len
    print("Test 8: json_array_push... ");
    let arr2 = json_array();
    json_array_push(arr2, json_number(1));
    json_array_push(arr2, json_number(2));
    json_array_push(arr2, json_number(3));
    if json_array_len(arr2) == 3 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 3, got ");
        print_i64(json_array_len(arr2));
        println("");
        failed = failed + 1;
    }

    // Test 9: json_get_index
    print("Test 9: json_get_index... ");
    let item0 = json_get_index(arr2, 0);
    let item1 = json_get_index(arr2, 1);
    let item2 = json_get_index(arr2, 2);
    if json_as_i64(item0) == 1 {
        if json_as_i64(item1) == 2 {
            if json_as_i64(item2) == 3 {
                println("PASS");
                passed = passed + 1;
            } else {
                println("FAIL - wrong item2");
                failed = failed + 1;
            }
        } else {
            println("FAIL - wrong item1");
            failed = failed + 1;
        }
    } else {
        println("FAIL - wrong item0");
        failed = failed + 1;
    }

    // Test 10: json_array mixed types
    print("Test 10: json_array mixed... ");
    let arr3 = json_array();
    json_array_push(arr3, json_string("hello"));
    json_array_push(arr3, json_number(42));
    json_array_push(arr3, json_bool(1));
    json_array_push(arr3, json_null());
    if json_array_len(arr3) == 4 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    println("");
    println("--- JSON Object Operations ---");

    // Test 11: json_object_set
    print("Test 11: json_object_set... ");
    let obj2 = json_object();
    json_object_set(obj2, "name", json_string("test"));
    json_object_set(obj2, "value", json_number(100));
    if json_object_len(obj2) == 2 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 2, got ");
        print_i64(json_object_len(obj2));
        println("");
        failed = failed + 1;
    }

    // Test 12: json_object_get
    print("Test 12: json_object_get... ");
    let name_val = json_object_get(obj2, "name");
    let value_val = json_object_get(obj2, "value");
    if name_val != 0 {
        if value_val != 0 {
            if json_as_i64(value_val) == 100 {
                println("PASS");
                passed = passed + 1;
            } else {
                println("FAIL - wrong value");
                failed = failed + 1;
            }
        } else {
            println("FAIL - value not found");
            failed = failed + 1;
        }
    } else {
        println("FAIL - name not found");
        failed = failed + 1;
    }

    // Test 13: json_object_has
    print("Test 13: json_object_has... ");
    if json_object_has(obj2, "name") != 0 {
        if json_object_has(obj2, "missing") == 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - found missing key");
            failed = failed + 1;
        }
    } else {
        println("FAIL - didn't find name");
        failed = failed + 1;
    }

    // Test 14: json_keys
    print("Test 14: json_keys... ");
    let keys = json_keys(obj2);
    let keys_len = vec_len(keys);
    if keys_len == 2 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 2, got ");
        print_i64(keys_len);
        println("");
        failed = failed + 1;
    }

    println("");
    println("--- JSON Serialization ---");

    // Test 15: json_stringify simple
    print("Test 15: json_stringify number... ");
    let num_str = json_stringify(json_number(42));
    if string_eq(num_str, "42") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - got: ");
        print(num_str);
        println("");
        failed = failed + 1;
    }

    // Test 16: json_stringify bool
    print("Test 16: json_stringify bool... ");
    let bool_str = json_stringify(json_bool(1));
    if string_eq(bool_str, "true") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - got: ");
        print(bool_str);
        println("");
        failed = failed + 1;
    }

    // Test 17: json_stringify null
    print("Test 17: json_stringify null... ");
    let null_str = json_stringify(json_null());
    if string_eq(null_str, "null") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - got: ");
        print(null_str);
        println("");
        failed = failed + 1;
    }

    // Test 18: json_stringify string
    print("Test 18: json_stringify string... ");
    let str_str = json_stringify(json_string("hello"));
    if string_contains(str_str, "hello") != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - got: ");
        print(str_str);
        println("");
        failed = failed + 1;
    }

    // Test 19: json_stringify array
    print("Test 19: json_stringify array... ");
    let arr_str = json_stringify(arr2);
    if string_contains(arr_str, "[") != 0 {
        if string_contains(arr_str, "1") != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - missing 1");
            failed = failed + 1;
        }
    } else {
        println("FAIL - no bracket");
        failed = failed + 1;
    }

    // Test 20: json_stringify object
    print("Test 20: json_stringify object... ");
    let obj_str = json_stringify(obj2);
    if string_contains(obj_str, "{") != 0 {
        if string_contains(obj_str, "name") != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - missing name");
            failed = failed + 1;
        }
    } else {
        println("FAIL - no brace");
        failed = failed + 1;
    }

    println("");
    println("--- JSON Parsing ---");

    // Test 21: json_parse number
    print("Test 21: json_parse number... ");
    let parsed_num = json_parse("42");
    if parsed_num != 0 {
        if json_is_number(parsed_num) != 0 {
            if json_as_i64(parsed_num) == 42 {
                println("PASS");
                passed = passed + 1;
            } else {
                println("FAIL - wrong value");
                failed = failed + 1;
            }
        } else {
            println("FAIL - not number");
            failed = failed + 1;
        }
    } else {
        println("FAIL - parse failed");
        failed = failed + 1;
    }

    // Test 22: json_parse bool
    print("Test 22: json_parse bool... ");
    let parsed_bool = json_parse("true");
    if parsed_bool != 0 {
        if json_is_bool(parsed_bool) != 0 {
            if json_as_bool(parsed_bool) != 0 {
                println("PASS");
                passed = passed + 1;
            } else {
                println("FAIL - wrong value");
                failed = failed + 1;
            }
        } else {
            println("FAIL - not bool");
            failed = failed + 1;
        }
    } else {
        println("FAIL - parse failed");
        failed = failed + 1;
    }

    // Test 23: json_parse null
    print("Test 23: json_parse null... ");
    let parsed_null = json_parse("null");
    if parsed_null != 0 {
        if json_is_null(parsed_null) != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - not null");
            failed = failed + 1;
        }
    } else {
        println("FAIL - parse failed");
        failed = failed + 1;
    }

    // Test 24: json_parse string
    print("Test 24: json_parse string... ");
    let parsed_str = json_parse("\"hello\"");
    if parsed_str != 0 {
        if json_is_string(parsed_str) != 0 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - not string");
            failed = failed + 1;
        }
    } else {
        println("FAIL - parse failed");
        failed = failed + 1;
    }

    // Test 25: json_parse array
    print("Test 25: json_parse array... ");
    let parsed_arr = json_parse("[1, 2, 3]");
    if parsed_arr != 0 {
        if json_is_array(parsed_arr) != 0 {
            if json_array_len(parsed_arr) == 3 {
                println("PASS");
                passed = passed + 1;
            } else {
                println("FAIL - wrong len");
                failed = failed + 1;
            }
        } else {
            println("FAIL - not array");
            failed = failed + 1;
        }
    } else {
        println("FAIL - parse failed");
        failed = failed + 1;
    }

    // Test 26: json_parse object
    print("Test 26: json_parse object... ");
    let parsed_obj = json_parse("{\"a\": 1, \"b\": 2}");
    if parsed_obj != 0 {
        if json_is_object(parsed_obj) != 0 {
            if json_object_len(parsed_obj) == 2 {
                println("PASS");
                passed = passed + 1;
            } else {
                println("FAIL - wrong len");
                failed = failed + 1;
            }
        } else {
            println("FAIL - not object");
            failed = failed + 1;
        }
    } else {
        println("FAIL - parse failed");
        failed = failed + 1;
    }

    // Test 27: json_parse nested
    print("Test 27: json_parse nested... ");
    let nested = json_parse("{\"arr\": [1, 2], \"obj\": {\"x\": 10}}");
    if nested != 0 {
        let arr_field = json_object_get(nested, "arr");
        let obj_field = json_object_get(nested, "obj");
        if arr_field != 0 {
            if obj_field != 0 {
                if json_is_array(arr_field) != 0 {
                    if json_is_object(obj_field) != 0 {
                        println("PASS");
                        passed = passed + 1;
                    } else {
                        println("FAIL - obj not object");
                        failed = failed + 1;
                    }
                } else {
                    println("FAIL - arr not array");
                    failed = failed + 1;
                }
            } else {
                println("FAIL - obj missing");
                failed = failed + 1;
            }
        } else {
            println("FAIL - arr missing");
            failed = failed + 1;
        }
    } else {
        println("FAIL - parse failed");
        failed = failed + 1;
    }

    println("");
    println("--- JSON Utilities ---");

    // Test 28: json_clone
    print("Test 28: json_clone... ");
    let original = json_object();
    json_object_set(original, "x", json_number(5));
    let cloned = json_clone(original);
    if cloned != original {
        let cloned_x = json_object_get(cloned, "x");
        if json_as_i64(cloned_x) == 5 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - wrong value");
            failed = failed + 1;
        }
    } else {
        println("FAIL - same pointer");
        failed = failed + 1;
    }

    // Test 29: json_equals same
    print("Test 29: json_equals same... ");
    let eq_a = json_number(42);
    let eq_b = json_number(42);
    if json_equals(eq_a, eq_b) != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should be equal");
        failed = failed + 1;
    }

    // Test 30: json_equals different
    print("Test 30: json_equals different... ");
    let eq_c = json_number(42);
    let eq_d = json_number(99);
    if json_equals(eq_c, eq_d) == 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should not be equal");
        failed = failed + 1;
    }

    // Test 31: json_type
    print("Test 31: json_type... ");
    let type_null = json_type(json_null());
    let type_bool = json_type(json_bool(1));
    let type_num = json_type(json_number(1));
    let type_str = json_type(json_string("x"));
    let type_arr = json_type(json_array());
    let type_obj = json_type(json_object());
    // Types: NULL=0, BOOL=1, NUMBER=2, STRING=3, ARRAY=4, OBJECT=5
    if type_null == 0 {
        if type_bool == 1 {
            if type_num == 2 {
                if type_str == 3 {
                    if type_arr == 4 {
                        if type_obj == 5 {
                            println("PASS");
                            passed = passed + 1;
                        } else {
                            println("FAIL - obj type");
                            failed = failed + 1;
                        }
                    } else {
                        println("FAIL - arr type");
                        failed = failed + 1;
                    }
                } else {
                    println("FAIL - str type");
                    failed = failed + 1;
                }
            } else {
                println("FAIL - num type");
                failed = failed + 1;
            }
        } else {
            println("FAIL - bool type");
            failed = failed + 1;
        }
    } else {
        println("FAIL - null type");
        failed = failed + 1;
    }

    // Test 32: roundtrip
    print("Test 32: roundtrip... ");
    let rt_obj = json_object();
    json_object_set(rt_obj, "name", json_string("test"));
    json_object_set(rt_obj, "count", json_number(42));
    let rt_str = json_stringify(rt_obj);
    let rt_parsed = json_parse(rt_str);
    if rt_parsed != 0 {
        let rt_count = json_object_get(rt_parsed, "count");
        if json_as_i64(rt_count) == 42 {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - wrong value after roundtrip");
            failed = failed + 1;
        }
    } else {
        println("FAIL - roundtrip parse failed");
        failed = failed + 1;
    }

    // Cleanup
    json_free(null_val);
    json_free(bool_true);
    json_free(bool_false);
    json_free(num_val);
    json_free(arr);
    json_free(obj);
    json_free(arr2);
    json_free(arr3);
    json_free(obj2);

    // Summary
    println("");
    println("=== Summary ===");
    print("Passed: ");
    print_i64(passed);
    print(" / ");
    print_i64(32);
    println("");

    if failed == 0 {
        println("");
        println("=== ALL JSON TESTS PASSED ===");
    } else {
        println("");
        println("=== SOME TESTS FAILED ===");
    }

    failed
}
