// Test threading and mailbox intrinsics
// Tests: thread_spawn, thread_join, condvar_*, mailbox_*

fn main() -> i64 {
    println("=== Threading and Mailbox Tests ===");
    println("");

    var passed: i64 = 0;
    var failed: i64 = 0;

    // === Mailbox Tests ===
    println("--- Mailbox Tests ---");

    // Test 1: mailbox_new
    print("Test 1: mailbox_new... ");
    let mb = mailbox_new(10);
    if mb != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null mailbox");
        failed = failed + 1;
    }

    // Test 2: mailbox_empty on new mailbox
    print("Test 2: mailbox_empty... ");
    if mailbox_empty(mb) != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - new mailbox should be empty");
        failed = failed + 1;
    }

    // Test 3: mailbox_size on new mailbox
    print("Test 3: mailbox_size empty... ");
    if mailbox_size(mb) == 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - size should be 0");
        failed = failed + 1;
    }

    // Test 4: mailbox_send
    print("Test 4: mailbox_send... ");
    let sent = mailbox_send(mb, 42);
    if sent != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - send failed");
        failed = failed + 1;
    }

    // Test 5: mailbox_size after send
    print("Test 5: mailbox_size after send... ");
    if mailbox_size(mb) == 1 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 1, got ");
        print_i64(mailbox_size(mb));
        println("");
        failed = failed + 1;
    }

    // Test 6: mailbox_empty after send
    print("Test 6: mailbox not empty... ");
    if mailbox_empty(mb) == 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should not be empty");
        failed = failed + 1;
    }

    // Test 7: mailbox_recv
    print("Test 7: mailbox_recv... ");
    let msg = mailbox_recv(mb);
    if msg == 42 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 42, got ");
        print_i64(msg);
        println("");
        failed = failed + 1;
    }

    // Test 8: mailbox_empty after recv
    print("Test 8: mailbox empty after recv... ");
    if mailbox_empty(mb) != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should be empty");
        failed = failed + 1;
    }

    // Test 9: mailbox_send multiple
    print("Test 9: mailbox_send multiple... ");
    mailbox_send(mb, 1);
    mailbox_send(mb, 2);
    mailbox_send(mb, 3);
    if mailbox_size(mb) == 3 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 10: mailbox_recv FIFO order
    print("Test 10: mailbox FIFO order... ");
    let m1 = mailbox_recv(mb);
    let m2 = mailbox_recv(mb);
    let m3 = mailbox_recv(mb);
    if m1 == 1 {
        if m2 == 2 {
            if m3 == 3 {
                println("PASS");
                passed = passed + 1;
            } else {
                println("FAIL - wrong m3");
                failed = failed + 1;
            }
        } else {
            println("FAIL - wrong m2");
            failed = failed + 1;
        }
    } else {
        println("FAIL - wrong m1");
        failed = failed + 1;
    }

    // Test 11: mailbox_try_recv on empty
    print("Test 11: mailbox_try_recv empty... ");
    let try_msg = mailbox_try_recv(mb);
    // try_recv returns 0 or special value when empty
    if mailbox_empty(mb) != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 12: mailbox_try_recv with message
    print("Test 12: mailbox_try_recv... ");
    mailbox_send(mb, 99);
    let try_msg2 = mailbox_try_recv(mb);
    if try_msg2 == 99 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 99, got ");
        print_i64(try_msg2);
        println("");
        failed = failed + 1;
    }

    // Test 13: mailbox_full (capacity 10)
    print("Test 13: mailbox_full... ");
    // Fill the mailbox
    var i: i64 = 0;
    while i < 10 {
        mailbox_send(mb, i);
        i = i + 1;
    }
    if mailbox_full(mb) != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should be full");
        failed = failed + 1;
    }

    // Test 14: mailbox_size when full
    print("Test 14: mailbox_size full... ");
    if mailbox_size(mb) == 10 {
        println("PASS");
        passed = passed + 1;
    } else {
        print("FAIL - expected 10, got ");
        print_i64(mailbox_size(mb));
        println("");
        failed = failed + 1;
    }

    // Drain mailbox for next tests
    while mailbox_empty(mb) == 0 {
        mailbox_recv(mb);
    }

    // Test 15: mailbox_close
    print("Test 15: mailbox_close... ");
    mailbox_close(mb);
    if mailbox_is_closed(mb) != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - should be closed");
        failed = failed + 1;
    }

    // Test 16: new mailbox for condvar tests
    print("Test 16: second mailbox... ");
    let mb2 = mailbox_new(5);
    if mb2 != 0 {
        if mb2 != mb {
            println("PASS");
            passed = passed + 1;
        } else {
            println("FAIL - same address");
            failed = failed + 1;
        }
    } else {
        println("FAIL - null");
        failed = failed + 1;
    }

    // Clean up
    mailbox_free(mb);
    mailbox_free(mb2);

    println("");
    println("--- Condition Variable Tests ---");

    // Test 17: condvar_new
    print("Test 17: condvar_new... ");
    let cv = condvar_new();
    if cv != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null condvar");
        failed = failed + 1;
    }

    // Test 18: mutex for condvar
    print("Test 18: mutex for condvar... ");
    let mtx = mutex_new();
    if mtx != 0 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL - null mutex");
        failed = failed + 1;
    }

    // Test 19: condvar_signal (no waiters - should not block)
    print("Test 19: condvar_signal... ");
    condvar_signal(cv);
    println("PASS");
    passed = passed + 1;

    // Test 20: condvar_broadcast (no waiters - should not block)
    print("Test 20: condvar_broadcast... ");
    condvar_broadcast(cv);
    println("PASS");
    passed = passed + 1;

    // Clean up condvar
    condvar_free(cv);
    mutex_free(mtx);

    println("");
    println("--- Thread Tests ---");

    // Test 21: Basic thread existence test
    print("Test 21: thread_id... ");
    let tid = thread_id();
    if tid >= 0 {
        print("PASS (tid=");
        print_i64(tid);
        println(")");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }

    // Test 22: thread_yield
    print("Test 22: thread_yield... ");
    thread_yield();
    println("PASS");
    passed = passed + 1;

    // Test 23: Shared state with atomics
    print("Test 23: atomic shared state... ");
    let counter = malloc(8);  // Allocate space for i64
    atomic_store(counter, 0);
    atomic_add(counter, 10);
    atomic_add(counter, 20);
    let val = atomic_load(counter);
    if val == 30 {
        println("PASS");
        passed = passed + 1;
    } else {
        println("FAIL");
        failed = failed + 1;
    }
    free(counter);

    // Test 24: Multiple mutexes for thread safety
    print("Test 24: multiple mutexes... ");
    let m1 = mutex_new();
    let m2 = mutex_new();
    mutex_lock(m1);
    mutex_lock(m2);
    mutex_unlock(m2);
    mutex_unlock(m1);
    println("PASS");
    passed = passed + 1;
    mutex_free(m1);
    mutex_free(m2);

    // Test 25: Mutex with condvar pattern
    print("Test 25: mutex-condvar pattern... ");
    let sync_mtx = mutex_new();
    let sync_cv = condvar_new();
    mutex_lock(sync_mtx);
    // Signal while holding lock (common pattern)
    condvar_signal(sync_cv);
    mutex_unlock(sync_mtx);
    println("PASS");
    passed = passed + 1;
    mutex_free(sync_mtx);
    condvar_free(sync_cv);

    // Summary
    println("");
    println("=== Summary ===");
    print("Passed: ");
    print_i64(passed);
    print(" / ");
    print_i64(25);
    println("");

    if failed == 0 {
        println("");
        println("=== ALL THREAD/MAILBOX TESTS PASSED ===");
    } else {
        println("");
        println("=== SOME TESTS FAILED ===");
    }

    failed
}
