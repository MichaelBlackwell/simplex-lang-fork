// Comprehensive test of all working Simplex features

// ===== Basic Language =====

fn test_basic_math() -> i64 {
    var a = 10;
    var b = 20;
    a + b * 2 - 5  // Should be 45
}

fn test_conditionals() -> i64 {
    var x = 15;
    if x > 10 { 1 } else { 0 }
}

fn test_while_loop() -> i64 {
    var count = 0;
    var i = 0;
    while i < 5 {
        count = count + i;
        i = i + 1;
    }
    count  // Should be 10
}

fn test_for_loop() -> i64 {
    var sum = 0;
    for i in 0..5 {
        sum = sum + i;
    }
    sum  // Should be 10
}

fn test_loop_break() -> i64 {
    var i = 0;
    let result = loop {
        i = i + 1;
        if i == 5 { break i * 10; }
    };
    result  // Should be 50
}

// ===== Structs =====

struct Point {
    x: i64,
    y: i64,
}

fn test_struct() -> i64 {
    let p = Point { x: 10, y: 20 };
    p.x + p.y  // Should be 30
}

// ===== Enums =====

enum Color {
    Red,
    Green,
    Blue,
}

enum Status {
    Ok(i64),
    Error,
}

fn test_enum_simple() -> i64 {
    let c = Color::Green;
    match c {
        Color::Red => 1,
        Color::Green => 2,
        Color::Blue => 3,
    }
}

fn test_enum_with_data() -> i64 {
    let s = Status::Ok(42);
    match s {
        Status::Ok(v) => v,
        Status::Error => 0,
    }
}

// ===== Closures =====

fn test_closure_simple() -> i64 {
    let add = |a: i64, b: i64| { a + b };
    add(3, 4)  // Should be 7
}

fn test_closure_capture() -> i64 {
    var base = 100;
    let add_base = |x: i64| { base + x };
    add_base(5)  // Should be 105
}

// ===== Generics =====

fn identity<T>(x: T) -> T {
    x
}

fn test_generic() -> i64 {
    identity::<i64>(42)
}

// ===== Option/Result (builtin) =====

fn test_option() -> i64 {
    let opt = Some(99);
    match opt {
        Some(v) => v,
        None => 0,
    }
}

fn test_result() -> i64 {
    let res = Ok(77);
    match res {
        Ok(v) => v,
        Err => 0,
    }
}

// ===== Main Test Runner =====

fn main() -> i64 {
    var passed = 0;
    var total = 0;

    // Basic features
    total = total + 1;
    if test_basic_math() == 45 { print("basic_math: PASS\n"); passed = passed + 1; }
    else { print("basic_math: FAIL\n"); }

    total = total + 1;
    if test_conditionals() == 1 { print("conditionals: PASS\n"); passed = passed + 1; }
    else { print("conditionals: FAIL\n"); }

    total = total + 1;
    if test_while_loop() == 10 { print("while_loop: PASS\n"); passed = passed + 1; }
    else { print("while_loop: FAIL\n"); }

    total = total + 1;
    if test_for_loop() == 10 { print("for_loop: PASS\n"); passed = passed + 1; }
    else { print("for_loop: FAIL\n"); }

    total = total + 1;
    if test_loop_break() == 50 { print("loop_break: PASS\n"); passed = passed + 1; }
    else { print("loop_break: FAIL\n"); }

    // Struct
    total = total + 1;
    if test_struct() == 30 { print("struct: PASS\n"); passed = passed + 1; }
    else { print("struct: FAIL\n"); }

    // Enums
    total = total + 1;
    if test_enum_simple() == 2 { print("enum_simple: PASS\n"); passed = passed + 1; }
    else { print("enum_simple: FAIL\n"); }

    total = total + 1;
    if test_enum_with_data() == 42 { print("enum_with_data: PASS\n"); passed = passed + 1; }
    else { print("enum_with_data: FAIL\n"); }

    // Closures
    total = total + 1;
    if test_closure_simple() == 7 { print("closure_simple: PASS\n"); passed = passed + 1; }
    else { print("closure_simple: FAIL\n"); }

    total = total + 1;
    if test_closure_capture() == 105 { print("closure_capture: PASS\n"); passed = passed + 1; }
    else { print("closure_capture: FAIL\n"); }

    // Generics
    total = total + 1;
    if test_generic() == 42 { print("generic: PASS\n"); passed = passed + 1; }
    else { print("generic: FAIL\n"); }

    // Option/Result
    total = total + 1;
    if test_option() == 99 { print("option: PASS\n"); passed = passed + 1; }
    else { print("option: FAIL\n"); }

    total = total + 1;
    if test_result() == 77 { print("result: PASS\n"); passed = passed + 1; }
    else { print("result: FAIL\n"); }

    print("\n========== SUMMARY ==========\n");
    print("Passed: ");
    print_i64(passed);
    print(" / ");
    print_i64(total);
    print("\n");

    if passed == total {
        print("ALL TESTS PASSED!\n");
    } else {
        print("SOME TESTS FAILED\n");
    }

    passed
}
