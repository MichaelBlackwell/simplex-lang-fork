// Fixed buffer overflow safety test
fn main() -> i64 {
    println("=== Fixed Buffer Overflow Safety Test ===");
    
    // Test 1: Normal string operations
    let test1 = intrinsic_string_new("Hello, Simplex Runtime!");
    let test1_len = intrinsic_string_len(test1);
    
    // Test 2: String with special characters
    let test2 = intrinsic_string_new("Special chars: \"\\n\\t\\r");
    let test2_len = intrinsic_string_len(test2);
    
    // Test 3: Empty string
    let test3 = intrinsic_string_new("");
    let test3_len = intrinsic_string_len(test3);
    
    // Test 4: Multiple allocations
    var alloc_count = 0;
    var success_count = 0;
    while alloc_count < 100 {
        let test_alloc = intrinsic_string_new("Memory safety test");
        if test_alloc != 0 {
            success_count = success_count + 1;
        }
        alloc_count = alloc_count + 1;
    }
    
    // Test 5: Large single allocation
    let large_test = intrinsic_string_new("This is a larger string to test safe memory allocation patterns in the Simplex runtime system with buffer overflow protection and proper error handling throughout all allocation paths including malloc realloc and free operations");
    let large_len = intrinsic_string_len(large_test);
    
    // Results
    println(intrinsic_string_concat("Test 1 - Normal string: ", int_to_string(test1_len)));
    println(intrinsic_string_concat("Test 2 - Special chars: ", int_to_string(test2_len)));
    println(intrinsic_string_concat("Test 3 - Empty string: ", int_to_string(test3_len)));
    println(intrinsic_string_concat("Test 4 - Multiple allocs: ", int_to_string(success_count)));
    println(intrinsic_string_concat("Test 5 - Large allocation: ", int_to_string(large_len)));
    
    if test1_len > 0 && test2_len > 0 && test3_len >= 0 && success_count >= 90 && large_len > 0 {
        println("=== ALL BUFFER SAFETY TESTS PASSED ===");
        println("String allocation working correctly");
        println("No buffer overflows detected");
        println("Memory allocation patterns safe");
        println("Error handling functional");
        return 0;
    } else {
        println("=== BUFFER SAFETY TESTS FAILED ===");
        return 1;
    }
}