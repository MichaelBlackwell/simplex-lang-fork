// Test file for Anima Persistence (Save/Load)
// Phase 4: Memory Persistence

// External declarations
fn anima_memory_new(capacity: i64) -> i64;
fn anima_remember(mem: i64, content: i64, importance: f64) -> i64;
fn anima_learn(mem: i64, content: i64, confidence: f64, source: i64) -> i64;
fn anima_believe(mem: i64, content: i64, confidence: f64, evidence: i64) -> i64;
fn anima_episodic_count(mem: i64) -> i64;
fn anima_semantic_count(mem: i64) -> i64;
fn anima_beliefs_count(mem: i64) -> i64;
fn anima_memory_close(mem: i64) -> i64;
fn anima_save(mem: i64, path: i64) -> i64;
fn anima_load(path: i64) -> i64;
fn anima_exists(path: i64) -> i64;

fn main() {
    println("=== Anima Persistence Test ===");
    println("");

    let path: i64 = string_from("/tmp/test_anima.json");

    // Create anima memory and populate it
    println("--- Creating and Populating Memory ---");
    let mem: i64 = anima_memory_new(5);

    // Add some experiences
    anima_remember(mem, string_from("User asked about functions"), 0.8);
    anima_remember(mem, string_from("Helped debug a crash"), 0.9);
    anima_remember(mem, string_from("Routine log check"), 0.3);

    // Add some facts
    anima_learn(mem, string_from("Simplex compiles to LLVM IR"), 0.95, string_from("docs"));
    anima_learn(mem, string_from("Actors use message passing"), 0.9, string_from("code"));

    // Add a belief
    anima_believe(mem, string_from("User prefers concise answers"), 0.7, 0);

    print("Original episodic count: ");
    print_i64(anima_episodic_count(mem));
    println("");
    print("Original semantic count: ");
    print_i64(anima_semantic_count(mem));
    println("");
    print("Original beliefs count: ");
    print_i64(anima_beliefs_count(mem));
    println("");

    // Save to file
    println("");
    println("--- Saving Memory ---");
    let saved: i64 = anima_save(mem, path);
    if saved == 1 {
        println("Successfully saved to /tmp/test_anima.json");
    } else {
        println("ERROR: Failed to save!");
    }

    // Close original memory
    anima_memory_close(mem);
    println("Closed original memory");

    // Check if file exists
    println("");
    println("--- Checking File ---");
    if anima_exists(path) == 1 {
        println("Save file exists");
    } else {
        println("ERROR: Save file not found!");
    }

    // Load from file
    println("");
    println("--- Loading Memory ---");
    let loaded: i64 = anima_load(path);
    if loaded != 0 {
        println("Successfully loaded from file");

        print("Loaded episodic count: ");
        print_i64(anima_episodic_count(loaded));
        println("");
        print("Loaded semantic count: ");
        print_i64(anima_semantic_count(loaded));
        println("");
        print("Loaded beliefs count: ");
        print_i64(anima_beliefs_count(loaded));
        println("");

        // Verify counts match
        if anima_episodic_count(loaded) == 3 {
            println("Episodic count matches!");
        } else {
            println("ERROR: Episodic count mismatch!");
        }

        if anima_semantic_count(loaded) == 2 {
            println("Semantic count matches!");
        } else {
            println("ERROR: Semantic count mismatch!");
        }

        if anima_beliefs_count(loaded) == 1 {
            println("Beliefs count matches!");
        } else {
            println("ERROR: Beliefs count mismatch!");
        }

        // Clean up loaded memory
        anima_memory_close(loaded);
    } else {
        println("ERROR: Failed to load!");
    }

    println("");
    println("=== Persistence test complete! ===");
}
