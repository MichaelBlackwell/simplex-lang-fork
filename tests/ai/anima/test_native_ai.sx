// Test file for Native AI Language Constructs
// Tests: specialist, hive, anima, mnemonic, infer

// Define an Anima (cognitive soul)
anima AssistantSoul {
    identity {
        purpose: "To help users with programming tasks",
        values: ["helpfulness", "accuracy", "clarity"]
    }
    memory {
        episodic: "in_memory",
        semantic: "in_memory"
    }
    beliefs {
        revision_threshold: 0.3
    }
    slm {
        model: "default",
        quantization: "q4"
    }
    persistence {
        auto_save: true
    }
}

// Define a Specialist (AI actor with model)
specialist CodeAnalyzer {
    model: "codellama-7b",
    temperature: 0.3,

    var analysis_count: i64 = 0

    receive Analyze(code: String) -> String {
        analysis_count = analysis_count + 1;
        // Use infer() to call the model
        infer("Analyze this code for bugs and improvements: " + code)
    }

    receive GetCount() -> i64 {
        analysis_count
    }
}

// Define another Specialist
specialist Summarizer {
    model: "mistral-7b",
    temperature: 0.5,

    receive Summarize(text: String) -> String {
        infer("Summarize the following text concisely: " + text)
    }
}

// Define a Hive with mnemonic (shared memory)
hive DocumentProcessor {
    specialists: [CodeAnalyzer, Summarizer],
    router: SemanticRouter,
    strategy: OneForOne,
    mnemonic {
        episodic: {
            capacity: 1000
        },
        semantic: {
            path: "knowledge.db"
        },
        beliefs: {
            revision_threshold: 0.5
        }
    }
}

fn main() {
    println("=== Native AI Language Constructs Test ===");
    println("");

    // Test Anima creation
    println("--- Testing Anima ---");
    let soul: i64 = AssistantSoul_new();
    if soul != 0 {
        println("Created AssistantSoul anima");
    }

    // Test Anima memory operations
    let exp: i64 = string_from("User asked about code optimization");
    AssistantSoul_remember(soul, exp);
    println("Stored episodic memory");

    let fact: i64 = string_from("Simplex supports specialist and hive constructs");
    AssistantSoul_learn(soul, fact);
    println("Stored semantic memory");

    let belief: i64 = string_from("Users prefer detailed explanations");
    AssistantSoul_believe(soul, belief, 80);  // 80% confidence
    println("Stored belief");

    // Test recall - returns a Vec of strings
    let goal: i64 = string_from("code optimization");
    let context: i64 = 0;
    let recalled: i64 = AssistantSoul_recall_for(soul, goal, context);
    print("Recalled memories (Vec ptr): ");
    print_i64(recalled);
    println("");

    // Test Specialist creation
    println("");
    println("--- Testing Specialists ---");
    let analyzer: i64 = CodeAnalyzer_new();
    if analyzer != 0 {
        println("Created CodeAnalyzer specialist");
    }

    let summarizer: i64 = Summarizer_new();
    if summarizer != 0 {
        println("Created Summarizer specialist");
    }

    // Test specialist handlers
    let code: i64 = string_from("fn add(a: i64, b: i64) -> i64 { a + b }");
    let analysis: i64 = CodeAnalyzer_handle_Analyze(analyzer, code);
    print("Code analysis: ");
    print_string(analysis);
    println("");

    let count: i64 = CodeAnalyzer_handle_GetCount(analyzer);
    print("Analysis count: ");
    print_i64(count);
    println("");

    let text: i64 = string_from("Simplex is a programming language designed for AI applications. It provides first-class support for specialists, hives, and cognitive memory through the anima construct.");
    let summary: i64 = Summarizer_handle_Summarize(summarizer, text);
    print("Summary: ");
    print_string(summary);
    println("");

    // Test Hive creation
    println("");
    println("--- Testing Hive ---");
    let doc_hive: i64 = DocumentProcessor_new();
    if doc_hive != 0 {
        println("Created DocumentProcessor hive");
    }

    // Test mnemonic (shared memory)
    let mnemonic: i64 = DocumentProcessor_mnemonic(doc_hive);
    if mnemonic != 0 {
        println("Got hive mnemonic (shared memory)");
    }

    // Share knowledge to mnemonic
    let knowledge: i64 = string_from("Learned: Code analysis reveals no bugs");
    DocumentProcessor_share(doc_hive, knowledge, 0.9);
    println("Shared knowledge to mnemonic");

    // Recall from mnemonic - returns a Vec of strings
    let recall_goal: i64 = string_from("code analysis");
    let shared_memory: i64 = DocumentProcessor_recall(doc_hive, recall_goal);
    print("Recalled from mnemonic (Vec ptr): ");
    print_i64(shared_memory);
    if shared_memory != 0 {
        println(" - recall succeeded");
    } else {
        println(" - no memories found");
    }

    println("");
    println("=== Native AI Language Constructs Test Complete! ===");
}
