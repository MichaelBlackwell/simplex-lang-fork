// Validation: Core Language Features
// Tests: 34.1.1 Match Guards, 34.1.2 Closures, 34.1.3 Monomorphization

// ============================================
// 34.1.1 Match Expression Guards
// ============================================

fn test_match_guard_basic() -> i64 {
 let x: i64 = 5;
 let result: i64 = match x {
 n if n > 10 => 1,
 n if n > 0 => 2,
 _ => 3
 };
 result // Expected: 2
}

fn test_match_guard_negative() -> i64 {
 let x: i64 = -5;
 let result: i64 = match x {
 n if n > 0 => 1,
 n if n < 0 => 2,
 _ => 3
 };
 result // Expected: 2
}

// ============================================
// 34.1.2 Closures with Environment Capture
// ============================================

fn test_lambda_basic() -> i64 {
 let double: i64 = (x) => x * 2;
 double(5) // Expected: 10
}

fn test_lambda_capture() -> i64 {
 let multiplier: i64 = 3;
 let mult: i64 = (x) => x * multiplier;
 mult(4) // Expected: 12
}

fn test_closure_nested_capture() -> i64 {
 let a: i64 = 10;
 let b: i64 = 20;
 let add_both: i64 = (x) => x + a + b;
 add_both(5) // Expected: 35
}

// ============================================
// 34.1.3 Full Monomorphization
// ============================================

struct Point<T> {
 x: T,
 y: T
}

fn generic_add<T>(a: T, b: T) -> T {
 a + b
}

fn test_monomorph_i64() -> i64 {
 generic_add::<i64>(10, 20) // Expected: 30
}

fn test_monomorph_struct() -> i64 {
 let p: Point<i64> = Point { x: 5, y: 10 };
 p.x + p.y // Expected: 15
}

// Test that different type instantiations are separate
fn test_monomorph_distinct() -> i64 {
 let a: i64 = generic_add::<i64>(1, 2);
 // If we had f64: let b: f64 = generic_add::<f64>(1.0, 2.0);
 a // Expected: 3
}

// ============================================
// Main test runner
// ============================================

fn main() -> i64 {
 // Run all tests and sum results
 // Expected: 2 + 2 + 10 + 12 + 35 + 30 + 15 = 106
 let r1: i64 = test_match_guard_basic(); // Expected: 2
 let r2: i64 = test_match_guard_negative(); // Expected: 2
 let r3: i64 = test_lambda_basic(); // Expected: 10
 let r4: i64 = test_lambda_capture(); // Expected: 12
 let r5: i64 = test_closure_nested_capture(); // Expected: 35
 let r6: i64 = test_monomorph_i64(); // Expected: 30
 let r7: i64 = test_monomorph_struct(); // Expected: 15

 r1 + r2 + r3 + r4 + r5 + r6 + r7 // Should be 106
}
