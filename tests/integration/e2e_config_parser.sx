// Integration test: Simple configuration parser
// Uses: JSON, String operations, Result, Option

fn parse_config(json_str: i64) -> i64 {
    let result: i64 = json_parse(json_str);
    if result_is_err(result) {
        return result_err(0 - 1);  // Config parse error
    }

    let config: i64 = result_unwrap(result);
    if json_is_object(config) == false {
        return result_err(0 - 2);  // Config must be an object
    }

    result_ok(config)
}

fn get_config_string(config: i64, key: i64) -> i64 {
    if json_object_has(config, key) == false {
        return option_none();
    }

    let val: i64 = json_get(config, key);
    if json_is_string(val) == false {
        return option_none();
    }

    option_some(json_as_string(val))
}

fn get_config_int(config: i64, key: i64) -> i64 {
    if json_object_has(config, key) == false {
        return option_none();
    }

    let val: i64 = json_get(config, key);
    if json_is_number(val) == false {
        return option_none();
    }

    option_some(json_as_i64(val))
}

fn get_config_bool(config: i64, key: i64) -> i64 {
    if json_object_has(config, key) == false {
        return option_none();
    }

    let val: i64 = json_get(config, key);
    if json_is_bool(val) == false {
        return option_none();
    }

    option_some(json_as_bool(val))
}

fn test_valid_config() -> i64 {
    let json: i64 = "{\"host\": \"localhost\", \"port\": 8080, \"debug\": true}";
    let result: i64 = parse_config(json);

    if result_is_err(result) {
        println("FAIL: valid config should parse");
        return 1;
    }

    let config: i64 = result_unwrap(result);

    // Check host
    let host: i64 = get_config_string(config, "host");
    if option_is_none(host) {
        println("FAIL: host should exist");
        return 1;
    }
    if string_eq(option_unwrap(host), "localhost") == false {
        println("FAIL: host should be 'localhost'");
        return 1;
    }

    // Check port
    let port: i64 = get_config_int(config, "port");
    if option_unwrap(port) != 8080 {
        println("FAIL: port should be 8080");
        return 1;
    }

    // Check debug
    let debug: i64 = get_config_bool(config, "debug");
    if option_unwrap(debug) != true {
        println("FAIL: debug should be true");
        return 1;
    }

    println("PASS: test_valid_config");
    0
}

fn test_missing_keys() -> i64 {
    let json: i64 = "{\"host\": \"example.com\"}";
    let result: i64 = parse_config(json);
    let config: i64 = result_unwrap(result);

    let port: i64 = get_config_int(config, "port");
    if option_is_some(port) {
        println("FAIL: missing port should return None");
        return 1;
    }

    let debug: i64 = get_config_bool(config, "debug");
    if option_is_some(debug) {
        println("FAIL: missing debug should return None");
        return 1;
    }

    println("PASS: test_missing_keys");
    0
}

fn test_invalid_json() -> i64 {
    let json: i64 = "not valid json";
    let result: i64 = parse_config(json);

    if result_is_ok(result) {
        println("FAIL: invalid json should fail");
        return 1;
    }

    println("PASS: test_invalid_json");
    0
}

fn test_non_object_config() -> i64 {
    let json: i64 = "[1, 2, 3]";
    let result: i64 = parse_config(json);

    if result_is_ok(result) {
        println("FAIL: array config should fail");
        return 1;
    }

    println("PASS: test_non_object_config");
    0
}

fn test_nested_config() -> i64 {
    let json: i64 = "{\"database\": {\"host\": \"db.local\", \"port\": 5432}}";
    let result: i64 = parse_config(json);
    let config: i64 = result_unwrap(result);

    let db: i64 = json_get(config, "database");
    if json_is_object(db) == false {
        println("FAIL: database should be an object");
        return 1;
    }

    let db_host: i64 = json_get(db, "host");
    if string_eq(json_as_string(db_host), "db.local") == false {
        println("FAIL: database host should be 'db.local'");
        return 1;
    }

    let db_port: i64 = json_get(db, "port");
    if json_as_i64(db_port) != 5432 {
        println("FAIL: database port should be 5432");
        return 1;
    }

    println("PASS: test_nested_config");
    0
}

fn main() -> i64 {
    println("=== Config Parser Integration Test ===");
    println("");

    var failures: i64 = 0;
    failures = failures + test_valid_config();
    failures = failures + test_missing_keys();
    failures = failures + test_invalid_json();
    failures = failures + test_non_object_config();
    failures = failures + test_nested_config();

    println("");
    if failures == 0 {
        println("All config parser tests passed!");
    } else {
        print("Config parser tests failed: ");
        println(int_to_string(failures));
    }

    failures
}
