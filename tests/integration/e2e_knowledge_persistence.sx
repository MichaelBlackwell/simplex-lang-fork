// End-to-End Scenario Test: Knowledge Persistence
// v0.5.0: Anima and HiveMnemonic persist across sessions
//
// Scenario: An AI assistant that remembers past interactions
// and accumulates knowledge over multiple sessions.

// External declarations
fn anima_memory_new(capacity: i64) -> i64;
fn anima_remember(mem: i64, content: i64, importance: f64) -> i64;
fn anima_learn(mem: i64, content: i64, confidence: f64, source: i64) -> i64;
fn anima_believe(mem: i64, content: i64, confidence: f64, evidence: i64) -> i64;
fn anima_revise_belief(mem: i64, belief_id: i64, confidence: f64, evidence: i64) -> i64;
fn anima_desire(mem: i64, goal: i64, priority: f64) -> i64;
fn anima_recall_for_goal(mem: i64, goal: i64, context: i64, max: i64) -> i64;
fn anima_episodic_count(mem: i64) -> i64;
fn anima_semantic_count(mem: i64) -> i64;
fn anima_beliefs_count(mem: i64) -> i64;
fn anima_consolidate(mem: i64) -> i64;
fn anima_save(mem: i64, path: i64) -> i64;
fn anima_load(path: i64) -> i64;
fn anima_memory_close(mem: i64);

fn hive_mnemonic_new(episodic_cap: i64, semantic_cap: i64, belief_threshold: i64) -> i64;
fn hive_mnemonic_learn(mnemonic: i64, content: i64, confidence: f64) -> i64;
fn hive_mnemonic_remember(mnemonic: i64, content: i64, importance: f64) -> i64;
fn hive_mnemonic_believe(mnemonic: i64, content: i64, confidence: f64) -> i64;
fn hive_mnemonic_episodic_count(mnemonic: i64) -> i64;
fn hive_mnemonic_semantic_count(mnemonic: i64) -> i64;
fn hive_mnemonic_save(mnemonic: i64, path: i64) -> i64;
fn hive_mnemonic_load(path: i64) -> i64;
fn hive_mnemonic_close(mnemonic: i64);

fn file_exists(path: i64) -> i64;
fn file_delete(path: i64) -> i64;

fn vec_len(v: i64) -> i64;
fn string_from(s: i64) -> i64;
fn print(s: i64);
fn println(s: i64);
fn print_i64(n: i64);
fn print_string(s: i64);

fn main() {
 println("=== Knowledge Persistence Scenario ===");
 println("Testing Anima and HiveMnemonic save/load");
 println("");

 let anima_path: i64 = string_from("/tmp/test_anima.dat");
 let mnemonic_path: i64 = string_from("/tmp/test_mnemonic.dat");

 // Clean up any existing files
 if file_exists(anima_path) == 1 {
 file_delete(anima_path);
 }
 if file_exists(mnemonic_path) == 1 {
 file_delete(mnemonic_path);
 }

 // ========================================
 // SESSION 1: Create and populate memories
 // ========================================
 println("### SESSION 1: Initial Learning ###");
 println("");

 println("Creating new Anima...");
 let anima1: i64 = anima_memory_new(10);

 // Simulate user interactions
 println("Simulating user interactions...");

 anima_remember(anima1, string_from("User asked about error handling in Simplex"), 0.8);
 anima_remember(anima1, string_from("Explained Result type and ? operator"), 0.85);
 anima_remember(anima1, string_from("User seemed confused about pattern matching"), 0.7);

 anima_learn(anima1, string_from("User prefers verbose explanations"), 0.75, string_from("observation"));
 anima_learn(anima1, string_from("User is working on a web application"), 0.8, string_from("user said"));
 anima_learn(anima1, string_from("User has Python background"), 0.9, string_from("user said"));

 anima_believe(anima1, string_from("User is an intermediate developer"), 0.7, string_from("based on questions"));
 anima_believe(anima1, string_from("User values code clarity"), 0.65, string_from("based on preferences"));

 anima_desire(anima1, string_from("Help user learn Simplex effectively"), 0.9);

 println("");
 println("Session 1 state:");
 print(" Episodic memories: ");
 print_i64(anima_episodic_count(anima1));
 println("");
 print(" Semantic knowledge: ");
 print_i64(anima_semantic_count(anima1));
 println("");
 print(" Beliefs: ");
 print_i64(anima_beliefs_count(anima1));
 println("");

 // Save anima
 println("");
 println("Saving Anima to disk...");
 let save_result1: i64 = anima_save(anima1, anima_path);
 if save_result1 == 1 {
 println(" PASS: Anima saved successfully");
 } else {
 println(" FAIL: Anima save failed");
 }

 // Create and populate HiveMnemonic
 println("");
 println("Creating HiveMnemonic with team knowledge...");
 let mnemonic1: i64 = hive_mnemonic_new(100, 500, 50);

 hive_mnemonic_learn(mnemonic1, string_from("Simplex actors use message passing"), 0.95);
 hive_mnemonic_learn(mnemonic1, string_from("The ? operator propagates errors"), 0.9);
 hive_mnemonic_remember(mnemonic1, string_from("Session with user about error handling"), 0.8);
 hive_mnemonic_believe(mnemonic1, string_from("Error handling is a common learning challenge"), 0.75);

 println("Session 1 mnemonic state:");
 print(" Semantic: ");
 print_i64(hive_mnemonic_semantic_count(mnemonic1));
 println("");
 print(" Episodic: ");
 print_i64(hive_mnemonic_episodic_count(mnemonic1));
 println("");

 // Save mnemonic
 println("");
 println("Saving HiveMnemonic to disk...");
 let save_result2: i64 = hive_mnemonic_save(mnemonic1, mnemonic_path);
 if save_result2 == 1 {
 println(" PASS: HiveMnemonic saved successfully");
 } else {
 println(" FAIL: HiveMnemonic save failed");
 }

 // Close session 1
 anima_memory_close(anima1);
 hive_mnemonic_close(mnemonic1);
 println("");
 println("Session 1 ended. Memory closed.");
 println("");

 // ========================================
 // SESSION 2: Load and continue
 // ========================================
 println("### SESSION 2: Resume with Loaded Memories ###");
 println("");

 // Verify files exist
 if file_exists(anima_path) == 1 {
 println("Anima file exists on disk");
 } else {
 println("ERROR: Anima file not found");
 }

 // Load anima
 println("");
 println("Loading Anima from disk...");
 let anima2: i64 = anima_load(anima_path);
 if anima2 != 0 {
 println(" PASS: Anima loaded successfully");

 println("");
 println("Loaded state:");
 print(" Episodic memories: ");
 print_i64(anima_episodic_count(anima2));
 println("");
 print(" Semantic knowledge: ");
 print_i64(anima_semantic_count(anima2));
 println("");
 print(" Beliefs: ");
 print_i64(anima_beliefs_count(anima2));
 println("");

 // Recall relevant memories
 println("");
 println("Recalling memories about 'error handling'...");
 let recalled: i64 = anima_recall_for_goal(anima2, string_from("error handling"), 0, 5);
 let recalled_count: i64 = vec_len(recalled);
 print(" Found ");
 print_i64(recalled_count);
 println(" relevant memories");

 } else {
 println(" FAIL: Anima load failed");
 }

 // Load mnemonic
 println("");
 println("Loading HiveMnemonic from disk...");
 let mnemonic2: i64 = hive_mnemonic_load(mnemonic_path);
 if mnemonic2 != 0 {
 println(" PASS: HiveMnemonic loaded successfully");

 println("");
 println("Loaded state:");
 print(" Semantic: ");
 print_i64(hive_mnemonic_semantic_count(mnemonic2));
 println("");
 print(" Episodic: ");
 print_i64(hive_mnemonic_episodic_count(mnemonic2));
 println("");
 } else {
 println(" FAIL: HiveMnemonic load failed");
 }

 // Continue the session with new interactions
 println("");
 println("Continuing with new interactions...");

 anima_remember(anima2, string_from("User returned to ask about actors"), 0.85);
 anima_remember(anima2, string_from("Explained supervision trees and fault tolerance"), 0.9);
 anima_learn(anima2, string_from("User interested in distributed systems"), 0.8, string_from("user questions"));

 // Update belief based on new evidence
 // User demonstrates more expertise than initially thought
 anima_believe(anima2, string_from("User is an advanced developer"), 0.75, string_from("based on actor questions"));

 println("");
 println("After new interactions:");
 print(" Episodic memories: ");
 print_i64(anima_episodic_count(anima2));
 println(" (grew from session 1)");
 print(" Semantic knowledge: ");
 print_i64(anima_semantic_count(anima2));
 println("");
 print(" Beliefs: ");
 print_i64(anima_beliefs_count(anima2));
 println(" (may have revised beliefs)");

 // Save updated state
 println("");
 println("Saving updated state...");
 anima_save(anima2, anima_path);
 hive_mnemonic_save(mnemonic2, mnemonic_path);
 println(" PASS: State saved");

 anima_memory_close(anima2);
 hive_mnemonic_close(mnemonic2);
 println("");
 println("Session 2 ended.");
 println("");

 // ========================================
 // SESSION 3: Verify persistence works
 // ========================================
 println("### SESSION 3: Verify Full Persistence ###");
 println("");

 println("Loading after multiple saves...");
 let anima3: i64 = anima_load(anima_path);
 if anima3 != 0 {
 let final_episodic: i64 = anima_episodic_count(anima3);
 let final_semantic: i64 = anima_semantic_count(anima3);
 let final_beliefs: i64 = anima_beliefs_count(anima3);

 println("Final Anima state:");
 print(" Episodic: ");
 print_i64(final_episodic);
 println("");
 print(" Semantic: ");
 print_i64(final_semantic);
 println("");
 print(" Beliefs: ");
 print_i64(final_beliefs);
 println("");

 // Verify we have memories from both sessions
 if final_episodic >= 5 {
 println(" PASS: Memories from both sessions preserved");
 } else {
 println(" FAIL: Some memories may be missing");
 }

 // Test memory consolidation
 println("");
 println("Testing memory consolidation...");
 let pruned: i64 = anima_consolidate(anima3);
 print(" Pruned ");
 print_i64(pruned);
 println(" low-importance memories");

 anima_memory_close(anima3);
 }

 // Clean up test files
 println("");
 println("Cleaning up test files...");
 file_delete(anima_path);
 file_delete(mnemonic_path);
 println(" PASS: Test files removed");

 // ========================================
 // SUMMARY
 // ========================================
 println("");
 println("### SCENARIO SUMMARY ###");
 println("");
 println("PASS: Created Anima with episodic, semantic, and belief memories");
 println("PASS: Created HiveMnemonic with shared team knowledge");
 println("PASS: Saved both to disk");
 println("PASS: Loaded memories in new session");
 println("PASS: Verified all memories preserved");
 println("PASS: Added new memories in session 2");
 println("PASS: Re-saved updated state");
 println("PASS: Verified persistence across multiple saves");
 println("PASS: Tested memory consolidation");
 println("");
 println("Persistence verified for:");
 println(" - Episodic memories (experiences)");
 println(" - Semantic knowledge (facts)");
 println(" - Beliefs (with confidence)");
 println(" - Desires (goals)");
 println(" - HiveMnemonic shared state");
 println("");

 println("=== Knowledge Persistence Scenario Complete! ===");
}
