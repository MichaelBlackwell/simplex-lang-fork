// Test file for Terminal/CLI Features
// v0.5.0: Colors, Progress Bars, Spinners

// External declarations for terminal features
fn term_supports_color() -> i64;
fn term_width() -> i64;
fn term_height() -> i64;
fn term_is_tty() -> i64;

fn color_red(text: i64) -> i64;
fn color_green(text: i64) -> i64;
fn color_blue(text: i64) -> i64;
fn color_yellow(text: i64) -> i64;
fn color_magenta(text: i64) -> i64;
fn color_cyan(text: i64) -> i64;
fn color_white(text: i64) -> i64;
fn color_gray(text: i64) -> i64;

fn style_bold(text: i64) -> i64;
fn style_dim(text: i64) -> i64;
fn style_italic(text: i64) -> i64;
fn style_underline(text: i64) -> i64;
fn style_reset() -> i64;

fn color_rgb(text: i64, r: i64, g: i64, b: i64) -> i64;
fn bg_red(text: i64) -> i64;
fn bg_green(text: i64) -> i64;
fn bg_blue(text: i64) -> i64;
fn bg_yellow(text: i64) -> i64;

fn progress_bar_new(total: i64) -> i64;
fn progress_bar_set_width(bar: i64, width: i64);
fn progress_bar_set_style(bar: i64, filled: i64, empty: i64);
fn progress_bar_update(bar: i64, current: i64);
fn progress_bar_increment(bar: i64);
fn progress_bar_render(bar: i64) -> i64;
fn progress_bar_finish(bar: i64);
fn progress_bar_close(bar: i64);

fn spinner_new(style: i64) -> i64;
fn spinner_set_message(spinner: i64, msg: i64);
fn spinner_start(spinner: i64);
fn spinner_tick(spinner: i64);
fn spinner_render(spinner: i64) -> i64;
fn spinner_stop(spinner: i64);
fn spinner_succeed(spinner: i64, msg: i64);
fn spinner_fail(spinner: i64, msg: i64);
fn spinner_close(spinner: i64);

fn table_new() -> i64;
fn table_add_header(table: i64, headers: i64);
fn table_add_row(table: i64, row: i64);
fn table_set_border(table: i64, style: i64);
fn table_render(table: i64) -> i64;
fn table_close(table: i64);

fn string_from(s: i64) -> i64;
fn string_contains(s: i64, substr: i64) -> i64;
fn string_len(s: i64) -> i64;
fn vec_new() -> i64;
fn vec_push(v: i64, item: i64);
fn print(s: i64);
fn println(s: i64);
fn print_i64(n: i64);
fn print_string(s: i64);

fn main() {
    println("=== Terminal/CLI Features Test ===");
    println("v0.5.0: Colors, Progress, Spinners");
    println("");

    // Test 1: Terminal detection
    println("--- Test 1: Terminal Detection ---");
    let is_tty: i64 = term_is_tty();
    let supports_color: i64 = term_supports_color();
    let width: i64 = term_width();
    let height: i64 = term_height();

    print("  Is TTY: ");
    print_i64(is_tty);
    println("");
    print("  Supports color: ");
    print_i64(supports_color);
    println("");
    print("  Width: ");
    print_i64(width);
    println(" columns");
    print("  Height: ");
    print_i64(height);
    println(" rows");

    println("PASS: Terminal detection works");
    println("");

    // Test 2: Basic colors
    println("--- Test 2: Basic Colors ---");
    let red_text: i64 = color_red(string_from("Red text"));
    let green_text: i64 = color_green(string_from("Green text"));
    let blue_text: i64 = color_blue(string_from("Blue text"));
    let yellow_text: i64 = color_yellow(string_from("Yellow text"));
    let magenta_text: i64 = color_magenta(string_from("Magenta text"));
    let cyan_text: i64 = color_cyan(string_from("Cyan text"));

    print("  ");
    print_string(red_text);
    println("");
    print("  ");
    print_string(green_text);
    println("");
    print("  ");
    print_string(blue_text);
    println("");
    print("  ");
    print_string(yellow_text);
    println("");
    print("  ");
    print_string(magenta_text);
    println("");
    print("  ");
    print_string(cyan_text);
    println("");

    // Verify ANSI codes are present
    if string_contains(red_text, string_from("\x1b[")) == 1 {
        println("PASS: ANSI color codes present");
    } else {
        println("INFO: Colors may be disabled in non-TTY");
    }
    println("");

    // Test 3: Text styles
    println("--- Test 3: Text Styles ---");
    let bold_text: i64 = style_bold(string_from("Bold text"));
    let dim_text: i64 = style_dim(string_from("Dim text"));
    let italic_text: i64 = style_italic(string_from("Italic text"));
    let underline_text: i64 = style_underline(string_from("Underlined text"));

    print("  ");
    print_string(bold_text);
    println("");
    print("  ");
    print_string(dim_text);
    println("");
    print("  ");
    print_string(italic_text);
    println("");
    print("  ");
    print_string(underline_text);
    println("");

    println("PASS: Text styles applied");
    println("");

    // Test 4: Combined styles
    println("--- Test 4: Combined Styles ---");
    let combined: i64 = style_bold(color_red(string_from("Bold Red")));
    print("  ");
    print_string(combined);
    println("");

    let combined2: i64 = style_underline(color_green(string_from("Underlined Green")));
    print("  ");
    print_string(combined2);
    println("");

    println("PASS: Styles can be combined");
    println("");

    // Test 5: RGB colors
    println("--- Test 5: RGB Colors ---");
    let orange: i64 = color_rgb(string_from("Orange (255, 165, 0)"), 255, 165, 0);
    let purple: i64 = color_rgb(string_from("Purple (128, 0, 128)"), 128, 0, 128);
    let teal: i64 = color_rgb(string_from("Teal (0, 128, 128)"), 0, 128, 128);

    print("  ");
    print_string(orange);
    println("");
    print("  ");
    print_string(purple);
    println("");
    print("  ");
    print_string(teal);
    println("");

    println("PASS: RGB colors supported");
    println("");

    // Test 6: Background colors
    println("--- Test 6: Background Colors ---");
    let bg_red_text: i64 = bg_red(string_from(" Red background "));
    let bg_green_text: i64 = bg_green(string_from(" Green background "));
    let bg_blue_text: i64 = bg_blue(string_from(" Blue background "));

    print("  ");
    print_string(bg_red_text);
    println("");
    print("  ");
    print_string(bg_green_text);
    println("");
    print("  ");
    print_string(bg_blue_text);
    println("");

    println("PASS: Background colors supported");
    println("");

    // Test 7: Progress bar
    println("--- Test 7: Progress Bar ---");
    let bar: i64 = progress_bar_new(100);  // 100 total steps
    progress_bar_set_width(bar, 40);  // 40 characters wide
    progress_bar_set_style(bar, string_from("█"), string_from("░"));

    // Simulate progress
    progress_bar_update(bar, 0);
    let render0: i64 = progress_bar_render(bar);
    print("  0%:   ");
    print_string(render0);
    println("");

    progress_bar_update(bar, 25);
    let render25: i64 = progress_bar_render(bar);
    print("  25%:  ");
    print_string(render25);
    println("");

    progress_bar_update(bar, 50);
    let render50: i64 = progress_bar_render(bar);
    print("  50%:  ");
    print_string(render50);
    println("");

    progress_bar_update(bar, 75);
    let render75: i64 = progress_bar_render(bar);
    print("  75%:  ");
    print_string(render75);
    println("");

    progress_bar_update(bar, 100);
    let render100: i64 = progress_bar_render(bar);
    print("  100%: ");
    print_string(render100);
    println("");

    progress_bar_finish(bar);
    progress_bar_close(bar);

    println("PASS: Progress bar renders correctly");
    println("");

    // Test 8: Progress bar increment
    println("--- Test 8: Progress Bar Increment ---");
    let bar2: i64 = progress_bar_new(5);
    progress_bar_set_width(bar2, 20);

    let i: i64 = 0;
    while i < 5 {
        progress_bar_increment(bar2);
        let render: i64 = progress_bar_render(bar2);
        print("  Step ");
        print_i64(i + 1);
        print(": ");
        print_string(render);
        println("");
        i = i + 1;
    }

    progress_bar_close(bar2);
    println("PASS: Increment works");
    println("");

    // Test 9: Spinner
    println("--- Test 9: Spinner ---");
    let spinner: i64 = spinner_new(1);  // Style 1: dots
    spinner_set_message(spinner, string_from("Loading..."));

    // Simulate spinner frames
    spinner_start(spinner);

    let j: i64 = 0;
    while j < 4 {
        spinner_tick(spinner);
        let frame: i64 = spinner_render(spinner);
        print("  Frame ");
        print_i64(j);
        print(": ");
        print_string(frame);
        println("");
        j = j + 1;
    }

    spinner_stop(spinner);
    println("PASS: Spinner renders frames");

    // Test spinner succeed/fail
    spinner_set_message(spinner, string_from("Task complete"));
    spinner_succeed(spinner, string_from("Done!"));
    let success_render: i64 = spinner_render(spinner);
    print("  Success: ");
    print_string(success_render);
    println("");

    spinner_close(spinner);
    println("");

    // Test 10: Table formatting
    println("--- Test 10: Table Formatting ---");
    let table: i64 = table_new();

    // Add headers
    let headers: i64 = vec_new();
    vec_push(headers, string_from("Name"));
    vec_push(headers, string_from("Size"));
    vec_push(headers, string_from("Status"));
    table_add_header(table, headers);

    // Add rows
    let row1: i64 = vec_new();
    vec_push(row1, string_from("cognitive-7b"));
    vec_push(row1, string_from("4.1 GB"));
    vec_push(row1, string_from("installed"));
    table_add_row(table, row1);

    let row2: i64 = vec_new();
    vec_push(row2, string_from("cognitive-1b"));
    vec_push(row2, string_from("700 MB"));
    vec_push(row2, string_from("not installed"));
    table_add_row(table, row2);

    let row3: i64 = vec_new();
    vec_push(row3, string_from("mnemonic-embed"));
    vec_push(row3, string_from("134 MB"));
    vec_push(row3, string_from("installed"));
    table_add_row(table, row3);

    table_set_border(table, 1);  // Simple border

    let table_output: i64 = table_render(table);
    println("Table output:");
    print_string(table_output);
    println("");

    table_close(table);
    println("PASS: Table renders with alignment");
    println("");

    // Test 11: Semantic color functions
    println("--- Test 11: Semantic Colors ---");

    // Success = green
    let success: i64 = color_green(string_from("✓ Success"));
    print("  ");
    print_string(success);
    println("");

    // Error = red
    let error: i64 = color_red(string_from("✗ Error"));
    print("  ");
    print_string(error);
    println("");

    // Warning = yellow
    let warning: i64 = color_yellow(string_from("⚠ Warning"));
    print("  ");
    print_string(warning);
    println("");

    // Info = blue
    let info: i64 = color_blue(string_from("ℹ Info"));
    print("  ");
    print_string(info);
    println("");

    println("PASS: Semantic colors work");
    println("");

    // Test 12: Reset handling
    println("--- Test 12: Reset Handling ---");
    let reset_code: i64 = style_reset();
    print("  Reset code length: ");
    print_i64(string_len(reset_code));
    println("");

    // Color followed by reset
    let colored: i64 = color_red(string_from("Red"));
    print("  ");
    print_string(colored);
    print(" <- should be red, ");
    print("this should be normal");
    println("");

    println("PASS: Reset codes work");
    println("");

    println("=== Terminal/CLI Summary ===");
    println("Verified:");
    println("  - Terminal detection (TTY, dimensions, color support)");
    println("  - 8 basic colors (red, green, blue, yellow, etc.)");
    println("  - Text styles (bold, dim, italic, underline)");
    println("  - RGB colors (24-bit)");
    println("  - Background colors");
    println("  - Progress bars (render, update, increment)");
    println("  - Spinners (frames, succeed, fail)");
    println("  - Tables (headers, rows, borders)");

    println("");
    println("=== Terminal/CLI Test Complete! ===");
}
