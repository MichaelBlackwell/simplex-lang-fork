// Nexus Protocol - Type Constants and Tags
//
// This module defines all constants for the Nexus protocol:
// - STF (Simplex Term Format) type tags
// - Frame types and flags
// - Message types
// - Delta operation codes
//
// Protocol Version: 0.9.5

// =============================================================================
// Protocol Constants
// =============================================================================

fn NEXUS_VERSION_MAJOR() -> i64 { 0 }
fn NEXUS_VERSION_MINOR() -> i64 { 9 }
fn NEXUS_VERSION_PATCH() -> i64 { 5 }

fn NEXUS_MAGIC_BYTE_0() -> i64 { 83 }  // 'S' = 0x53
fn NEXUS_MAGIC_BYTE_1() -> i64 { 88 }  // 'X' = 0x58
fn NEXUS_MAGIC() -> i64 { 21336 }       // "SX" as u16 = 0x5358

// Maximum sizes
fn MAX_FRAME_SIZE() -> i64 { 65536 }     // 64KB max frame
fn MAX_BELIEFS_PER_SYNC() -> i64 { 65535 }
fn MAX_PAYLOAD_SIZE() -> i64 { 65000 }

// Default timing
fn DEFAULT_SYNC_RATE_HZ() -> i64 { 60 }
fn DEFAULT_CHECKSUM_INTERVAL() -> i64 { 60 }  // Every 60 frames

// =============================================================================
// Delta Operation Codes (2 bits)
// =============================================================================

fn DELTA_OP_SAME() -> i64 { 0 }      // 00 - No change (2 bits total)
fn DELTA_OP_SMALL() -> i64 { 1 }     // 01 - Small delta (9 bits total)
fn DELTA_OP_LARGE() -> i64 { 2 }     // 10 - Large delta (18 bits total)
fn DELTA_OP_FULL() -> i64 { 3 }      // 11 - Full value (34 bits total)

// Delta encoding constants
fn DELTA_SMALL_BITS() -> i64 { 7 }   // 7 bits for small delta value
fn DELTA_LARGE_BITS() -> i64 { 16 }  // 16 bits for large delta value
fn DELTA_FULL_BITS() -> i64 { 32 }   // 32 bits for full value

fn DELTA_SMALL_MIN() -> i64 { -64 }
fn DELTA_SMALL_MAX() -> i64 { 63 }
fn DELTA_SMALL_SCALE() -> i64 { 1000 }  // Scale factor: 0.001

fn DELTA_LARGE_MIN() -> i64 { -32768 }
fn DELTA_LARGE_MAX() -> i64 { 32767 }
fn DELTA_LARGE_SCALE() -> i64 { 10000 }  // Scale factor: 0.0001

// =============================================================================
// STF (Simplex Term Format) Type Tags (1 byte)
// =============================================================================

// Primitives (0x00-0x0F)
fn STF_NIL() -> i64 { 0 }
fn STF_TRUE() -> i64 { 1 }
fn STF_FALSE() -> i64 { 2 }
fn STF_SMALL_INT() -> i64 { 3 }    // i8
fn STF_INT32() -> i64 { 4 }
fn STF_INT64() -> i64 { 5 }
fn STF_FLOAT32() -> i64 { 6 }
fn STF_FLOAT64() -> i64 { 7 }
fn STF_UINT8() -> i64 { 8 }
fn STF_UINT16() -> i64 { 9 }
fn STF_UINT32() -> i64 { 10 }
fn STF_UINT64() -> i64 { 11 }

// Dual Numbers (0x0D-0x0F)
fn STF_DUAL16() -> i64 { 13 }       // f32 + i8 derivative (scaled x0.01)
fn STF_DUAL32() -> i64 { 14 }       // f32 + f32 derivative
fn STF_DUAL64() -> i64 { 15 }       // f64 + f64 derivative

// Compounds (0x10-0x1F)
fn STF_ATOM_SMALL() -> i64 { 16 }   // Atom with length <= 255
fn STF_ATOM_LARGE() -> i64 { 17 }   // Atom with length > 255
fn STF_BINARY() -> i64 { 18 }       // Binary blob
fn STF_STRING() -> i64 { 19 }       // UTF-8 string
fn STF_LIST() -> i64 { 20 }         // Variable-length list
fn STF_TUPLE() -> i64 { 21 }        // Fixed-size tuple
fn STF_MAP() -> i64 { 22 }          // Key-value map

// Cognitive Types (0x20-0x2F)
fn STF_ACTOR_ADDR() -> i64 { 32 }   // node/hive/specialist/instance
fn STF_BELIEF() -> i64 { 33 }       // id + confidence(dual) + content + sources
fn STF_GOAL() -> i64 { 34 }         // id + priority(dual) + deadline + content
fn STF_INTENTION() -> i64 { 35 }    // goal_id + plan + status(dual)
fn STF_VECTOR_CLOCK() -> i64 { 36 } // Causality tracking
fn STF_CRDT_DELTA() -> i64 { 37 }   // CRDT update

// Neural Types (0x30-0x3F)
fn STF_CODEBOOK_REF() -> i64 { 48 } // Reference to shared codebook entry
fn STF_NEURAL_EMB() -> i64 { 49 }   // Neural embedding vector
fn STF_PATTERN_INST() -> i64 { 50 } // Pattern instantiation

// Security Types (0x38-0x3F)
fn STF_SIGNATURE() -> i64 { 56 }    // Cryptographic signature
fn STF_CERTIFICATE() -> i64 { 57 }  // Hive certificate
fn STF_ENCRYPTED() -> i64 { 58 }    // Encrypted payload wrapper
fn STF_ACL() -> i64 { 59 }          // Access control list

// Control Types (0xF0-0xFF)
fn STF_COMPRESSED() -> i64 { 240 }   // Compressed payload follows
fn STF_EXTENSION() -> i64 { 254 }    // Extension type
fn STF_INVALID() -> i64 { 255 }      // Invalid/reserved

// =============================================================================
// Frame Types (1 byte)
// =============================================================================

fn FRAME_HELLO() -> i64 { 1 }      // Initial handshake
fn FRAME_WELCOME() -> i64 { 2 }    // Handshake response
fn FRAME_CATALOG() -> i64 { 3 }    // Belief UUID catalog
fn FRAME_CATALOG_ACK() -> i64 { 4 } // Catalog acknowledgment
fn FRAME_BASELINE() -> i64 { 5 }   // Full state snapshot
fn FRAME_SYNC() -> i64 { 6 }       // Delta sync frame
fn FRAME_CHECKSUM() -> i64 { 7 }   // State verification
fn FRAME_DEFINE() -> i64 { 8 }     // Add new belief
fn FRAME_TOMBSTONE() -> i64 { 9 }  // Remove belief
fn FRAME_FULL_SYNC() -> i64 { 10 } // Full re-sync request
fn FRAME_DISCONNECT() -> i64 { 11 } // Graceful close
fn FRAME_PING() -> i64 { 12 }      // Keepalive ping
fn FRAME_PONG() -> i64 { 13 }      // Keepalive pong

// =============================================================================
// Frame Flags (1 byte, bitfield)
// =============================================================================

fn FLAG_NONE() -> i64 { 0 }
fn FLAG_FRAGMENT() -> i64 { 1 }     // Fragment of larger message
fn FLAG_COMPRESSED() -> i64 { 2 }   // Payload is compressed
fn FLAG_HAS_CORRELATION() -> i64 { 4 } // Has correlation ID
fn FLAG_HAS_STREAM() -> i64 { 8 }   // Has stream ID
fn FLAG_ENCRYPTED() -> i64 { 16 }    // Payload is encrypted
fn FLAG_SIGNED() -> i64 { 32 }       // Frame has signature
fn FLAG_URGENT() -> i64 { 64 }       // High priority
fn FLAG_FINAL() -> i64 { 128 }       // Final fragment

// =============================================================================
// Message Types (1 byte)
// =============================================================================

// Core Messages
fn MSG_SEND() -> i64 { 1 }          // Fire and forget
fn MSG_REPLY() -> i64 { 2 }         // Response to SEND
fn MSG_STREAM_START() -> i64 { 3 }  // Begin streaming
fn MSG_STREAM_DATA() -> i64 { 4 }   // Stream chunk
fn MSG_STREAM_END() -> i64 { 5 }    // End streaming
fn MSG_ERROR() -> i64 { 6 }         // Error response

// Cognitive Messages
fn MSG_BELIEF() -> i64 { 16 }        // Belief propagation
fn MSG_GOAL() -> i64 { 17 }          // Goal delegation
fn MSG_INTENTION() -> i64 { 18 }     // Intention update
fn MSG_QUERY() -> i64 { 19 }         // Query request
fn MSG_OBSERVE() -> i64 { 20 }       // Observation
fn MSG_SYNC() -> i64 { 21 }          // CRDT sync

// Control Messages
fn MSG_PING() -> i64 { 32 }
fn MSG_PONG() -> i64 { 33 }
fn MSG_FLOW() -> i64 { 34 }          // Backpressure
fn MSG_CLOSE() -> i64 { 35 }
fn MSG_REDIRECT() -> i64 { 36 }

// Federation Messages
fn MSG_JOIN() -> i64 { 48 }
fn MSG_LEAVE() -> i64 { 49 }
fn MSG_ANNOUNCE() -> i64 { 50 }
fn MSG_DISCOVER() -> i64 { 51 }
fn MSG_HANDOFF() -> i64 { 52 }

// =============================================================================
// Error Codes
// =============================================================================

fn ERR_NONE() -> i64 { 0 }
fn ERR_INVALID_MAGIC() -> i64 { 1 }
fn ERR_INVALID_VERSION() -> i64 { 2 }
fn ERR_INVALID_FRAME_TYPE() -> i64 { 3 }
fn ERR_INVALID_LENGTH() -> i64 { 4 }
fn ERR_CHECKSUM_MISMATCH() -> i64 { 5 }
fn ERR_CATALOG_MISMATCH() -> i64 { 6 }
fn ERR_DECODE_ERROR() -> i64 { 7 }
fn ERR_BUFFER_OVERFLOW() -> i64 { 8 }
fn ERR_CONNECTION_CLOSED() -> i64 { 9 }
fn ERR_TIMEOUT() -> i64 { 10 }
fn ERR_AUTH_FAILED() -> i64 { 11 }
fn ERR_SIGNATURE_INVALID() -> i64 { 12 }
fn ERR_ENCRYPTION_FAILED() -> i64 { 13 }
fn ERR_DECRYPTION_FAILED() -> i64 { 14 }
fn ERR_ACCESS_DENIED() -> i64 { 15 }
fn ERR_CERT_EXPIRED() -> i64 { 16 }
fn ERR_CERT_UNTRUSTED() -> i64 { 17 }

// =============================================================================
// Connection States
// =============================================================================

fn CONN_DISCONNECTED() -> i64 { 0 }
fn CONN_CONNECTING() -> i64 { 1 }
fn CONN_HANDSHAKE() -> i64 { 2 }
fn CONN_CATALOG_EXCHANGE() -> i64 { 3 }
fn CONN_BASELINE() -> i64 { 4 }
fn CONN_SYNCING() -> i64 { 5 }
fn CONN_IDLE() -> i64 { 6 }
fn CONN_ERROR() -> i64 { 7 }

// =============================================================================
// Sync Strategies
// =============================================================================

fn SYNC_FIXED_RATE() -> i64 { 0 }      // Fixed Hz
fn SYNC_ADAPTIVE() -> i64 { 1 }        // Adjust based on change rate
fn SYNC_ON_CHANGE() -> i64 { 2 }       // Only when beliefs change

// =============================================================================
// Helper Functions
// =============================================================================

fn is_valid_stf_tag(tag: i64) -> i64 {
    if tag < 0 { return 0; }
    if tag > 255 { return 0; }

    // Check known ranges
    if tag <= 11 { return 1; }  // Primitives
    if tag >= 13 && tag <= 15 { return 1; }  // Dual numbers
    if tag >= 16 && tag <= 22 { return 1; }  // Compounds
    if tag >= 32 && tag <= 37 { return 1; }  // Cognitive
    if tag >= 48 && tag <= 50 { return 1; }  // Neural
    if tag >= 56 && tag <= 59 { return 1; }  // Security
    if tag == 240 { return 1; }  // Compressed
    if tag == 254 { return 1; }  // Extension

    0  // Unknown tag
}

fn is_valid_frame_type(frame_type: i64) -> i64 {
    if frame_type >= FRAME_HELLO() && frame_type <= FRAME_PONG() {
        return 1;
    }
    0
}
